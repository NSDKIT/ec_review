# 楽天商品調査ワークフロー - 全体フロー図

## 📊 ワークフロー全体図

```
┌─────────────────────────────────────────────────────────────────┐
│                    ユーザー操作（UI）                              │
│  「調査開始」タブ → 「楽天商品調査を実行」ボタンクリック              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              rakuten-ui.js (UIコンポーネント)                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. モーダルフォーム表示                                    │   │
│  │    - 検索キーワード入力                                    │   │
│  │    - 最低価格・最高価格設定                                │   │
│  │    - 除外キーワード設定                                    │   │
│  │    - 楽天アプリID設定                                      │   │
│  │    - 取得件数選択（30/50/100件）                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 2. フォーム送信 → rakutenWorkflow.execute() 呼び出し      │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│         rakuten-workflow.js (メインワークフロー)                   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ステップ1: Google Sheetsをクリア                           │   │
│  │   clearSheet()                                            │   │
│  │   → Sheet1!B2:O300 を空にする                            │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ステップ2: 楽天APIで商品検索                                │   │
│  │   rakutenAPI.searchItems()                                │   │
│  │   → 楽天市場API呼び出し                                    │   │
│  │   → 商品データを取得（最大30/50/100件）                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ステップ3: 商品データをGoogle Sheetsに書き込み              │   │
│  │   processAndWriteProducts()                               │   │
│  │   ├─ ヘッダー書き込み（B1:O1）                            │   │
│  │   └─ 各商品をループ処理                                    │   │
│  │       ├─ 送料込み価格取得（必要時）                        │   │
│  │       ├─ 行データ作成                                      │   │
│  │       └─ Google Sheetsに書き込み                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ステップ4: レビュー分析（最大30件）                         │   │
│  │   analyzeReviews()                                        │   │
│  │   └─ 各商品のレビューを分析                                │   │
│  │       ├─ 商品URLから商品ID抽出                            │   │
│  │       ├─ レビューページを取得（最大50ページ）              │   │
│  │       ├─ 直近3ヶ月のレビューを抽出                         │   │
│  │       ├─ 評価別に分類（高/中/低）                          │   │
│  │       └─ Google Sheetsに書き込み                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ステップ5: 結果を返す                                       │   │
│  │   → 成功/失敗、取得件数、Google Sheets URL                 │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              rakuten-ui.js (結果表示)                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ - 進捗バーを100%に更新                                     │   │
│  │ - 結果モーダルを表示                                       │   │
│  │ - Google Sheetsリンクを表示                                │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 詳細フロー

### 1. 初期化・準備フェーズ

```
ユーザー操作
    ↓
rakuten-ui.js 初期化
    ├─ モーダルHTML作成
    ├─ スタイル追加
    └─ イベントリスナー設定
```

### 2. 商品検索フェーズ

```
rakuten-workflow.js
    ↓
rakuten-api.js
    ├─ パラメータ構築
    │   ├─ keyword（検索キーワード）
    │   ├─ minPrice（最低価格）
    │   ├─ maxPrice（最高価格）
    │   ├─ NGKeyword（除外キーワード）
    │   └─ hits（取得件数）
    ↓
楽天市場API
    GET https://app.rakuten.co.jp/services/api/IchibaItem/Search/20220601
    ↓
レスポンス処理
    ├─ 商品データ抽出
    ├─ 価格・評価・URL等を整形
    └─ 商品リストを返す
```

### 3. データ書き込みフェーズ

```
各商品をループ処理
    ↓
商品データ整形
    ├─ 検索順位
    ├─ 商品名
    ├─ 価格(送料抜)
    ├─ 価格(送料込) ← 必要に応じて追加API呼び出し
    ├─ 商品URL
    ├─ サムネURL
    ├─ レビュー数
    └─ レビュー平均
    ↓
Google Sheets API
    writeData()
    ↓
Sheet1!B{行番号}:O{行番号} に書き込み
```

### 4. レビュー分析フェーズ

```
各商品をループ処理（最大30件）
    ↓
rakuten-review-analyzer.js
    ↓
商品URLから商品ID抽出
    ├─ 商品ページHTML取得（プロキシ必要）
    ├─ ratItemId を正規表現で抽出
    └─ 商品IDを取得
    ↓
レビューページを取得
    ├─ 最大50ページまでループ
    ├─ 3ヶ月以前のレビューが見つかるまで取得
    └─ レビューデータをパース
    ↓
レビュー分析
    ├─ 直近3ヶ月のレビューを抽出
    ├─ 最新レビュー日を取得
    ├─ 評価別に分類
    │   ├─ 高評価（4-5）レビュー
    │   ├─ 中評価（3）レビュー
    │   └─ 低評価（1-2）レビュー
    ├─ 平均評価を計算
    └─ レビュー数をカウント
    ↓
Google Sheets API
    writeReviewData()
    ↓
Sheet1!J{行番号}:O{行番号} に書き込み
    ├─ レビュー最新日
    ├─ 直近3ヶ月のレビュー数
    ├─ 直近3ヶ月のレビュー平均
    ├─ 高評価レビュー（<br>区切り）
    ├─ 中評価レビュー（<br>区切り）
    └─ 低評価レビュー（<br>区切り）
```

## 📋 データフロー

### 入力データ
```javascript
{
    keyword: "iPhone ケース",
    minPrice: 500,
    maxPrice: 15000,
    NGKeyword: "中古",
    hits: 30,
    rakuten_appid: "1011800059095379100"
}
```

### 中間データ（楽天APIレスポンス）
```javascript
{
    total_products: 30,
    products: [
        {
            ranking: 1,
            item_name: "iPhone 15 Pro ケース",
            item_code: "abc123",
            item_price: 2980,
            item_url: "https://item.rakuten.co.jp/...",
            review_count: 1250,
            review_average: 4.3,
            // ... その他の商品情報
        },
        // ... 29件
    ]
}
```

### 出力データ（Google Sheets）
```
Sheet1!B1:O1 (ヘッダー)
検索順位 | 商品名 | 価格(送料抜) | 価格(送料込) | 商品URL | サムネURL | レビュー数 | レビュー平均 | レビュー最新日 | 直近3ヶ月のレビュー数 | 直近3ヶ月のレビュー平均 | 高評価レビュー | 中評価レビュー | 低評価レビュー

Sheet1!B2:O2 (1件目)
1 | iPhone 15 Pro ケース | 2980 | 2980 | https://... | https://... | 1250 | 4.3 | 2025/01/15 | 45 | 4.2 | 良い商品です<br>おすすめ | 普通です | 壊れました

Sheet1!B3:O3 (2件目)
...
```

## ⚠️ 注意点・制約

### 1. Google Sheets書き込み
- **現状**: プレースホルダー実装
- **必要**: Google Apps ScriptまたはバックエンドAPI
- **理由**: OAuth認証が必要

### 2. レビュー取得
- **現状**: 構造のみ実装
- **必要**: プロキシサーバーまたはバックエンドAPI
- **理由**: CORS制限によりブラウザから直接取得不可

### 3. レート制限
- 楽天API: 1秒あたりのリクエスト数に制限あり
- レビュー取得: 1秒待機を実装済み

### 4. エラーハンドリング
- 各ステップでエラーが発生しても続行
- コンソールにエラーログを出力
- ユーザーには最終結果を表示

## 🎯 実行例

### ユーザーの操作
1. 「調査開始」タブを開く
2. 「楽天商品調査を実行」ボタンをクリック
3. フォームに入力:
   - 検索キーワード: "iPhone ケース"
   - 最低価格: 500
   - 最高価格: 15000
   - 除外キーワード: "中古"
   - 取得件数: 30件
4. 「調査開始」ボタンをクリック

### 実行中の表示
- 進捗バー: 0% → 100%
- ログ表示:
  ```
  [10:00:00] 調査を開始しています...
  [10:00:01] Google Sheetsをクリア中...
  [10:00:02] 楽天APIで商品検索中...
  [10:00:03] 30件の商品を処理中...
  [10:00:05] 10/30件処理完了
  [10:00:10] 20/30件処理完了
  [10:00:15] 30/30件処理完了
  [10:00:16] レビュー分析を開始...
  [10:00:20] 5/30件のレビュー分析完了
  ...
  ```

### 完了後の表示
- 結果モーダル:
  - ✅ 30件の商品データを取得しました。
  - 取得商品数: 30件
  - レビュー分析: 30件完了
  - 「Google Sheetsを開く」ボタン

## 🔗 関連ファイル

- `js/rakuten-api.js` - 楽天API連携
- `js/rakuten-review-analyzer.js` - レビュー分析
- `js/rakuten-workflow.js` - メインワークフロー
- `js/rakuten-ui.js` - UIコンポーネント
- `js/google-sheets.js` - Google Sheets API連携

