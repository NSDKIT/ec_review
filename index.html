<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“èª¿æŸ»ãƒ»åˆ†æ</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- WordCloud2.js -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰å®Ÿè£…ï¼ˆCanvas APIä½¿ç”¨ï¼‰ -->
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        
        /* Custom chatbot container */
        #dify-chatbot-container {
            font-family: 'Inter', sans-serif;
        }
        
        #closeChatButton:hover {
            background: #c82333 !important;
            transform: scale(1.1);
        }
        
        /* Main app container */
        .app-container {
            height: 100vh;
            background: #f8f9fa;
            color: #212529;
        }
        
        /* Header styling */
        .header {
            padding: 2rem 0;
            text-align: center;
            color: #212529;
            background: #ffffff;
            border-bottom: 1px solid #e9ecef;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #6c757d;
        }
        
        /* Tab styling */
        .tabs-container {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-bottom: none;
            margin: 0 2rem;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab {
            padding: 1rem 2rem;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab:hover {
            color: #212529;
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #212529;
            border-bottom-color: #0d6efd;
            background: #f8f9fa;
        }
        
        /* Content area */
        .content-area {
            background: #ffffff;
            margin: 0 2rem 2rem 2rem;
            border-radius: 0 0 20px 20px;
            border: 1px solid #e9ecef;
            border-top: none;
            min-height: 60vh;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content {
            display: none;
            padding: 2rem;
        }
        
        /* Chat tab specific height */
        .chat-tab {
            height: 60vh;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chat tab specific styling */
        .chat-tab {
            position: relative;
            height: 60vh;
        }
        
        .chat-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        
        .start-chat-button {
            background: #ffffff;
            color: #212529;
            border: 2px solid #0d6efd;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .start-chat-button:hover {
            background: #0d6efd;
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Results content styling */
        .results-content {
            height: 100%;
            overflow-y: auto;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        /* Responsive design */
        /* Data table styling */
        #dataTable {
            font-size: 0.9rem;
        }
        
        #dataTable th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-right: 1px solid #e5e7eb;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        #dataTable th:hover {
            background-color: #f9fafb;
        }
        
        #dataTable th.sortable:after {
            content: '\f0dc';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }
        
        #dataTable th.sort-asc:after {
            content: '\f0de';
            opacity: 1;
        }
        
        #dataTable th.sort-desc:after {
            content: '\f0dd';
            opacity: 1;
        }
        
        #dataTable td {
            padding: 10px 8px;
            border-right: 1px solid #f3f4f6;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        
        #dataTable tr:hover {
            background-color: #f8fafc;
        }
        
        #dataTable tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        #dataTable tr:nth-child(even):hover {
            background-color: #f1f5f9;
        }
        
        /* Pagination styling */
        .page-number {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-number:hover {
            background-color: #f3f4f6;
        }
        
        .page-number.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Search highlight */
        .search-highlight {
            background-color: #fef3c7;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
        #dataTable td {
            word-wrap: break-word;
            vertical-align: top;
        }
        
        #dataTable .max-w-xs {
            max-width: 12rem;
            word-break: break-all;
        }
        
        #dataTable .max-w-sm {
            max-width: 24rem;
        }
        
        #dataTable .w-20 {
            width: 5rem;
            text-align: center;
        }
        
        /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
        #dataTable a {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .word-cloud-wrapper {
            font-family: 'Inter', 'Hiragino Sans', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯', sans-serif;
            background: white;
            border-radius: 12px;
            margin: 0 auto;
            width: 100%;
            height: 400px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .word-cloud-item {
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
            font-family: inherit;
            letter-spacing: 0.3px;
        }
        
        .word-cloud-item:hover {
            z-index: 10;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
            filter: brightness(1.1);
        }
        
        /* å•†å“æƒ…å ±ã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .product-info-cell {
            padding: 8px 12px;
            vertical-align: top;
            min-width: 300px;
            max-width: 400px;
        }
        
        .product-info-cell .flex {
            align-items: flex-start;
        }
        
        .product-info-cell img {
            transition: transform 0.2s ease;
        }
        
        .product-info-cell img:hover {
            transform: scale(1.05);
        }
        
        .product-info-cell a {
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s ease;
        }
        
        .product-info-cell a:hover {
            border-bottom-color: currentColor;
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .tabs-container {
                margin: 0 1rem;
            }
            
            .content-area {
                margin: 0 1rem 1rem 1rem;
            }
            
            .tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            /* Mobile table adjustments */
            #dataTable {
                font-size: 0.8rem;
            }
            
            #dataTable th,
            #dataTable td {
                padding: 8px 6px;
            }
            
            .flex.gap-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .flex.gap-4 {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">å•†å“èª¿æŸ»ãƒ»åˆ†æ</h1>
            <p class="subtitle">AIã‚’æ´»ç”¨ã—ãŸåŒ…æ‹¬çš„ãªå¸‚å ´åˆ†æãƒ„ãƒ¼ãƒ«</p>
        </div>

        <!-- Tabs Container -->
        <div class="tabs-container">
            <!-- Tab Navigation -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('research')">
                    <i class="fas fa-search mr-2"></i>
                    èª¿æŸ»é–‹å§‹
                </div>
                <div class="tab" onclick="switchTab('results')">
                    <i class="fas fa-chart-bar mr-2"></i>
                    èª¿æŸ»çµæœ
                </div>
                <div class="tab" onclick="switchTab('analysis')">
                    <i class="fas fa-chart-line mr-2"></i>
                    åˆ†æçµæœ
                </div>
                <div class="tab" onclick="switchTab('reviews')">
                    <i class="fas fa-comments mr-2"></i>
                    ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æ
                </div>
                <div class="tab" onclick="switchTab('thumbnail')">
                    <i class="fas fa-image mr-2"></i>
                    ã‚µãƒ ãƒä¾é ¼æ›¸
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- èª¿æŸ»é–‹å§‹ã‚¿ãƒ– -->
            <div id="research-content" class="tab-content active chat-tab">
                <div class="chat-placeholder">
                    <div class="mb-6">
                        <i class="fas fa-robot text-6xl text-blue-500 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">AIèª¿æŸ»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3>
                        <p class="text-gray-600">å•†å“èª¿æŸ»ã‚„å¸‚å ´åˆ†æã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèã‹ã›ãã ã•ã„</p>
                    </div>
                    <div class="flex flex-col gap-4 items-center">
                        <button class="start-chat-button" onclick="startChat()">
                            <i class="fas fa-comments mr-3"></i>
                            <span>ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹</span>
                        </button>
                        <div class="text-gray-500 text-sm">ã¾ãŸã¯</div>
                        <button class="start-chat-button bg-green-600 hover:bg-green-700" onclick="rakutenWorkflowUI.openModal()">
                            <i class="fas fa-shopping-cart mr-3"></i>
                            <span>æ¥½å¤©å•†å“èª¿æŸ»ã‚’å®Ÿè¡Œ</span>
                        </button>
                        <button class="start-chat-button bg-gray-600 hover:bg-gray-700 text-sm" onclick="rakutenWorkflowUI.openSettingsModal()">
                            <i class="fas fa-cog mr-3"></i>
                            <span>è¨­å®šï¼ˆGoogle Spreadsheet IDç­‰ï¼‰</span>
                        </button>
                        <p class="text-xs text-gray-500 mt-2">æ¥½å¤©APIã‚’ä½¿ç”¨ã—ã¦å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ãƒ»åˆ†æã—ã¾ã™</p>
                    </div>
                </div>
            </div>

            <!-- èª¿æŸ»çµæœã‚¿ãƒ– -->
            <div id="results-content" class="tab-content results-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-table mr-2 text-blue-500"></i>
                        èª¿æŸ»çµæœãƒ‡ãƒ¼ã‚¿
                    </h3>
                    <div class="flex gap-2">
                        <button id="refreshDataBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>
                            ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                        </button>

                        <button id="exportDataBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            CSVå‡ºåŠ›
                        </button>
                    </div>
                </div>
                
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                <div id="dataLoading" class="hidden flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                
                <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                <div id="dataError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorMessage">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>
                </div>
                

                
                <!-- ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ -->
                <div id="dataOverview" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                        <span><strong id="totalRows">0</strong> ä»¶ã®ãƒ‡ãƒ¼ã‚¿</span>
                        <span><strong id="totalColumns">0</strong> åˆ—</span>
                        <span>æœ€çµ‚æ›´æ–°: <strong id="lastUpdated">-</strong></span>
                    </div>
                </div>

                <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="bg-white p-4 rounded-lg border mb-4" id="searchFilter">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-64">
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢..." 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        <div>
                            <select id="rowsPerPage" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="10">10ä»¶è¡¨ç¤º</option>
                                <option value="20">20ä»¶è¡¨ç¤º</option>
                                <option value="all">å…¨ä»¶è¡¨ç¤º</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="bg-white rounded-lg border overflow-hidden" id="dataTableContainer">
                    <div class="overflow-x-auto">
                        <table id="dataTable" class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å‹•çš„ã«ç”Ÿæˆ -->
                            </thead>
                            <tbody>
                                <!-- ãƒ‡ãƒ¼ã‚¿ã¯å‹•çš„ã«ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç©ºã®å ´åˆ -->
                    <div id="emptyTable" class="hidden p-8 text-center text-gray-500">
                        <i class="fas fa-table text-4xl mb-4"></i>
                        <p>è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>

                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div id="pagination" class="flex justify-between items-center mt-4 hidden">
                    <div class="text-sm text-gray-600">
                        <span id="paginationInfo">1-10 / 100ä»¶</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevPage" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers" class="flex gap-1">
                            <!-- ãƒšãƒ¼ã‚¸ç•ªå·ã¯å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <button id="nextPage" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†æçµæœã‚¿ãƒ– -->
            <div id="analysis-content" class="tab-content results-content">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-chart-line mr-2 text-green-500"></i>
                    åˆ†æçµæœãƒ»ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                </h3>

                <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
                <div class="stats-grid" id="analysisStatsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="analysisTotalItems">-</div>
                        <div class="stat-label">èª¿æŸ»å¯¾è±¡å•†å“æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analysisAveragePrice">-</div>
                        <div class="stat-label">å¹³å‡ä¾¡æ ¼</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analysisAverageRating">-</div>
                        <div class="stat-label">å¹³å‡è©•ä¾¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analysisCompetitorCount">-</div>
                        <div class="stat-label">ç«¶åˆãƒ–ãƒ©ãƒ³ãƒ‰æ•°</div>
                    </div>
                </div>

                <!-- ä¾¡æ ¼åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-700">ä¾¡æ ¼åˆ†å¸ƒåˆ†æ</h4>
                        <div class="flex items-center gap-2">
                            <label for="priceRangeInput" class="text-sm text-gray-600">ä¾¡æ ¼å¹…:</label>
                            <input type="number" 
                                   id="priceRangeInput" 
                                   value="3000" 
                                   min="1000" 
                                   max="50000" 
                                   step="1000"
                                   class="w-20 px-2 py-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm text-gray-600">å††</span>
                            <button id="updatePriceChart" 
                                    class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>æ›´æ–°
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- è©•ä¾¡åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ -->
                <!--
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">è©•ä¾¡åˆ†å¸ƒåˆ†æ</h4>
                    <div class="chart-container">
                        <canvas id="ratingChart"></canvas>
                    </div>
                </div>
                -->

                <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°ãƒ»ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ -->
                <!-- 
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-700">
                            <i class="fas fa-cloud mr-2 text-blue-500"></i>
                            å•†å“åãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°
                        </h4>

                    </div>
                    <div id="wordCloudContainer" class="h-[500px] relative bg-gray-50 rounded-lg flex items-center justify-center p-2">
                        <div id="wordCloud" class="w-full h-full"></div>
                        <div id="wordCloudLoading" class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            ãƒ†ã‚­ã‚¹ãƒˆåˆ†æä¸­...
                        </div>
                    </div>
                </div>
                -->

                <!-- å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ -->
                <!--
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">
                        <i class="fas fa-trending-up mr-2 text-green-500"></i>
                        å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                    </h4>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                -->

                <!-- ç«¶åˆåˆ†æ -->
                <!--
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">
                        <i class="fas fa-users mr-2 text-purple-500"></i>
                        ç«¶åˆåˆ†æ
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded">
                            <h5 class="font-medium text-gray-800">å¸‚å ´ã‚·ã‚§ã‚¢1ä½</h5>
                            <p class="text-gray-600">ãƒ–ãƒ©ãƒ³ãƒ‰A (32%)</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 32%"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded">
                            <h5 class="font-medium text-gray-800">ä¾¡æ ¼å„ªä½æ€§</h5>
                            <p class="text-gray-600">ãƒ–ãƒ©ãƒ³ãƒ‰B (15%å®‰)</p>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                -->

                <!-- ç«¶åˆãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°åˆ†æ -->
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">
                        <i class="fas fa-crosshairs mr-2 text-red-500"></i>
                        ç«¶åˆãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°åˆ†æ
                    </h4>
                    <div class="chart-container">
                        <canvas id="positioningChart" style="height: 400px;"></canvas>
                    </div>
                </div>

                <!-- é€æ–™æˆ¦ç•¥åˆ†æ -->
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">
                        <i class="fas fa-shipping-fast mr-2 text-blue-500"></i>
                        é€æ–™æˆ¦ç•¥åˆ†æ
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-3 bg-blue-50 rounded">
                            <h5 class="font-medium text-blue-800">é€æ–™ç„¡æ–™å•†å“</h5>
                            <p class="text-2xl font-bold text-blue-600" id="freeShippingRate">-</p>
                            <p class="text-sm text-blue-600">å…¨å•†å“ã®å‰²åˆ</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded">
                            <h5 class="font-medium text-green-800">å¹³å‡é€æ–™</h5>
                            <p class="text-2xl font-bold text-green-600" id="averageShipping">-</p>
                            <p class="text-sm text-green-600">é€æ–™æœ‰ã‚Šå•†å“ã®å¹³å‡</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded">
                            <h5 class="font-medium text-purple-800">é€æ–™æ¯”ç‡</h5>
                            <p class="text-2xl font-bold text-purple-600" id="shippingRatio">-</p>
                            <p class="text-sm text-purple-600">å•†å“ä¾¡æ ¼ã«å¯¾ã™ã‚‹å‰²åˆ</p>
                        </div>
                    </div>
                </div>

                <!-- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ -->
                <div class="bg-white p-4 rounded-lg border mb-4">
                    <h4 class="font-semibold mb-3 text-gray-700">
                        <i class="fas fa-chart-line mr-2 text-green-500"></i>
                        ç›´è¿‘3ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-medium mb-2 text-gray-800">äººæ°—æ€¥ä¸Šæ˜‡å•†å“ TOP 5</h5>
                            <div id="trendingProducts" class="space-y-2">
                                <div class="text-sm text-gray-500">ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­...</div>
                            </div>
                        </div>
                        <div>
                            <h5 class="font-medium mb-2 text-gray-800">æº€è¶³åº¦å‘ä¸Šå•†å“ TOP 5</h5>
                            <div id="improvingProducts" class="space-y-2">
                                <div class="text-sm text-gray-500">ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <!--
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="font-semibold mb-3 text-gray-800">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                    </h4>
                    <ul id="aiRecommendations" class="space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-spinner fa-spin mr-2 mt-1 text-blue-500"></i>
                            <span>ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</span>
                        </li>
                    </ul>
                </div>
                -->
            </div>

            <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚¿ãƒ– -->
            <div id="reviews-content" class="tab-content results-content">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-comments mr-2 text-purple-500"></i>
                    ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </h3>
                    
                    <!-- æ„Ÿæƒ…åˆ†æã‚µãƒãƒªãƒ¼ -->
                    <div class="bg-white p-6 rounded-lg border">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-800 text-lg">
                                æ„Ÿæƒ…åˆ†æã‚µãƒãƒªãƒ¼
                            </h4>
                            <div class="flex items-center gap-4">
                                <button onclick="forceReviewAnalysis()" class="px-3 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600">
                                    <i class="fas fa-sync-alt mr-1"></i>åˆ†æå®Ÿè¡Œ
                                </button>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-purple-600" id="totalReviewComments">951</div>
                                    <div class="text-xs text-gray-600">ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæ•°</div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6">é¡§å®¢ã®ç”Ÿã®å£°ã‹ã‚‰å•†å“ã®å¼·ã¿ã¨æ”¹å–„ç‚¹ã‚’ç™ºè¦‹</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="p-4 bg-green-50 rounded-lg border border-green-200 text-center">
                                <div class="text-3xl font-bold text-green-600 mb-1" id="positiveCount">-</div>
                                <div class="text-sm text-green-800 mb-2">é«˜è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                                <div class="text-xs text-green-600" id="positivePercent">-%</div>
                            </div>
                            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-center">
                                <div class="text-3xl font-bold text-yellow-600 mb-1" id="neutralCount">-</div>
                                <div class="text-sm text-yellow-800 mb-2">ä¸­è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                                <div class="text-xs text-yellow-600" id="neutralPercent">-%</div>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg border border-red-200 text-center">
                                <div class="text-3xl font-bold text-red-600 mb-1" id="negativeCount">-</div>
                                <div class="text-sm text-red-800 mb-2">ä½è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                                <div class="text-xs text-red-600" id="negativePercent">-%</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200 text-center">
                                <div class="text-3xl font-bold text-blue-600 mb-1" id="sentimentScore">-</div>
                                <div class="text-sm text-blue-800 mb-2">ç·åˆæ„Ÿæƒ…ã‚¹ã‚³ã‚¢</div>
                                <div class="text-xs text-blue-600">3.0æº€ç‚¹</div>
                            </div>
                        </div>

                        <!-- æ„Ÿæƒ…åˆ†æãƒãƒ£ãƒ¼ãƒˆ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h5 class="font-medium mb-3 text-gray-700">æ„Ÿæƒ…åˆ†å¸ƒ</h5>
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="sentimentDistributionChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h5 class="font-medium mb-3 text-gray-700">æ„Ÿæƒ…ãƒˆãƒ¬ãƒ³ãƒ‰</h5>
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="sentimentTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ„Ÿæƒ…åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ -->
                    <!--
                    <div class="bg-white p-6 rounded-lg border">
                        <h4 class="font-semibold mb-4 text-gray-800 text-lg">
                            <i class="fas fa-cloud mr-2 text-purple-500"></i>
                            æ„Ÿæƒ…åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h5 class="font-medium text-green-800 mb-3 flex items-center">
                                    <i class="fas fa-smile mr-2"></i>é«˜è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                                </h5>
                                <canvas id="positiveWordCloud" style="width: 100%; height: 250px;"></canvas>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h5 class="font-medium text-yellow-800 mb-3 flex items-center">
                                    <i class="fas fa-meh mr-2"></i>ä¸­è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                                </h5>
                                <canvas id="neutralWordCloud" style="width: 100%; height: 250px;"></canvas>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <h5 class="font-medium text-red-800 mb-3 flex items-center">
                                    <i class="fas fa-frown mr-2"></i>ä½è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                                </h5>
                                <canvas id="negativeWordCloud" style="width: 100%; height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                    -->

                    <!-- è©³ç´°ã‚¤ãƒ³ã‚µã‚¤ãƒˆ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- å•†å“ã®å¼·ã¿ -->
                        <!--
                        <div class="bg-white p-6 rounded-lg border">
                            <h4 class="font-semibold mb-4 text-gray-800 text-lg">
                                <i class="fas fa-thumbs-up mr-2 text-green-500"></i>
                                å•†å“ã®å¼·ã¿åˆ†æ
                            </h4>
                            
                            <div class="space-y-3">
                                <h5 class="font-medium text-gray-700">ã‚ˆãè¨€åŠã•ã‚Œã‚‹å¼·ã¿ TOP 15</h5>
                                <div id="strengthKeywords" class="space-y-2 max-h-96 overflow-y-auto">
                                    <div class="text-sm text-gray-500 p-3">åˆ†æä¸­...</div>
                                </div>
                            </div>
                        </div>
                        -->
                        
                        <!-- æ”¹å–„ãƒã‚¤ãƒ³ãƒˆåˆ†æ - ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ -->
                        <!--
                        <div class="bg-white p-6 rounded-lg border">
                            <h4 class="font-semibold mb-4 text-gray-800 text-lg">
                                <i class="fas fa-thumbs-down mr-2 text-red-500"></i>
                                æ”¹å–„ãƒã‚¤ãƒ³ãƒˆåˆ†æ
                            </h4>
                            
                            <div class="space-y-3">
                                <h5 class="font-medium text-gray-700">ã‚ˆãæŒ‡æ‘˜ã•ã‚Œã‚‹èª²é¡Œ TOP 15</h5>
                                <div id="weaknessKeywords" class="space-y-2 max-h-96 overflow-y-auto">
                                    <div class="text-sm text-gray-500 p-3">åˆ†æä¸­...</div>
                                </div>
                            </div>
                        </div>
                        -->
                    </div>

                    <!-- ç«¶åˆå•†å“æ„Ÿæƒ…æ¯”è¼ƒ -->
                    <!--
                    <div class="bg-white p-6 rounded-lg border">
                        <h4 class="font-semibold mb-4 text-gray-800 text-lg">
                            <i class="fas fa-balance-scale mr-2 text-indigo-500"></i>
                            å•†å“åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢æ¯”è¼ƒ
                        </h4>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="productSentimentComparisonChart"></canvas>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div class="p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                                    <h6 class="font-medium text-green-800">æœ€é«˜è©•ä¾¡å•†å“</h6>
                                    <div id="topRatedProduct" class="text-sm text-green-700 mt-1">åˆ†æä¸­...</div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-red-50 to-pink-50 rounded-lg">
                                    <h6 class="font-medium text-red-800">æ”¹å–„å¿…è¦å•†å“</h6>
                                    <div id="lowestRatedProduct" class="text-sm text-red-700 mt-1">åˆ†æä¸­...</div>
                                </div>
                                <div class="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                                    <h6 class="font-medium text-blue-800">å¹³å‡æ„Ÿæƒ…ã‚¹ã‚³ã‚¢</h6>
                                    <div id="averageSentimentScore" class="text-sm text-blue-700 mt-1">åˆ†æä¸­...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    -->

                    <!-- AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æå°‚ç”¨ï¼‰ -->
                    <!--
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg border border-purple-200">
                        <h4 class="font-semibold mb-4 text-gray-800 text-lg">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã«åŸºã¥ãAIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                        </h4>
                        <ul id="reviewBasedRecommendations" class="space-y-3">
                            <li class="flex items-start">
                                <i class="fas fa-spinner fa-spin mr-3 mt-1 text-purple-500"></i>
                                <span>ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</span>
                            </li>
                        </ul>
                    </div>
                    -->
            </div>

            <!-- ã‚µãƒ ãƒä¾é ¼æ›¸ã‚¿ãƒ– -->
            <div id="thumbnail-content" class="tab-content results-content">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-image mr-2 text-orange-500"></i>
                    ã‚µãƒ ãƒã‚¤ãƒ«ä¾é ¼æ›¸ç”Ÿæˆãƒ„ãƒ¼ãƒ«
                </h3>

                <!-- ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-white p-6 rounded-lg border mb-6">
                    <h4 class="font-semibold mb-4 text-gray-800">
                        <i class="fas fa-fire mr-2 text-red-500"></i>
                        äººæ°—æ€¥ä¸Šæ˜‡å•†å“ã®ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æ
                    </h4>

                    <!-- åˆ†æé–‹å§‹ãƒœã‚¿ãƒ³ -->
                    <div class="mb-6">
                        <button id="analyzeThumbnailsBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-search mr-2"></i>
                            ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æã‚’é–‹å§‹
                        </button>
                        <p class="text-sm text-gray-500 mt-2">â€» ã¾ãšèª¿æŸ»çµæœã‚¿ãƒ–ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„</p>
                    </div>

                    <!-- åˆ†æé€²è¡ŒçŠ¶æ³ -->
                    <div id="thumbnailAnalysisStatus" class="mb-4 hidden">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-3 text-blue-500"></i>
                                <span id="analysisStatusText">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’åˆ†æä¸­...</span>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="thumbnailGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <!-- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-white p-6 rounded-lg border mb-6">
                    <h4 class="font-semibold mb-4 text-gray-800">
                        <i class="fas fa-chart-bar mr-2 text-green-500"></i>
                        ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æçµæœ
                    </h4>
                    
                    <div id="thumbnailAnalysisResults" class="space-y-6">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-image text-4xl mb-3"></i>
                            <p>åˆ†æã‚’é–‹å§‹ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                </div>

                <!-- ä¾é ¼æ›¸ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-lg border border-orange-200">
                    <h4 class="font-semibold mb-4 text-gray-800">
                        <i class="fas fa-file-alt mr-2 text-orange-500"></i>
                        ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼å‘ã‘ä¾é ¼æ›¸
                    </h4>

                    <!-- ä¾é ¼æ›¸ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å•†å“ã‚«ãƒ†ã‚´ãƒª</label>
                            <input type="text" id="productCategory" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: ã‚¹ãƒãƒ›ã‚±ãƒ¼ã‚¹ã€åŒ–ç²§å“ã€å®¶é›»">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¹´é½¢å±¤</label>
                            <select id="targetAge" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="10ä»£">10ä»£</option>
                                <option value="20ä»£">20ä»£</option>
                                <option value="30ä»£">30ä»£</option>
                                <option value="40ä»£">40ä»£</option>
                                <option value="50ä»£ä»¥ä¸Š">50ä»£ä»¥ä¸Š</option>
                                <option value="å…¨å¹´é½¢">å…¨å¹´é½¢</option>
                            </select>
                        </div>
                    </div>

                    <!-- ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ -->
                    <div class="mb-6">
                        <button id="generateBriefBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition duration-300 disabled:bg-gray-400" disabled>
                            <i class="fas fa-magic mr-2"></i>
                            ä¾é ¼æ›¸ã‚’ç”Ÿæˆ
                        </button>
                    </div>

                    <!-- ç”Ÿæˆã•ã‚ŒãŸä¾é ¼æ›¸ -->
                    <div id="designBrief" class="hidden">
                        <div class="bg-white p-6 rounded-lg border border-orange-300">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-semibold text-gray-800">ã‚µãƒ ãƒã‚¤ãƒ«åˆ¶ä½œä¾é ¼æ›¸</h5>
                                <button id="copyBriefBtn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition duration-300">
                                    <i class="fas fa-copy mr-1"></i>
                                    ã‚³ãƒ”ãƒ¼
                                </button>
                            </div>
                            <div id="briefContent" class="prose max-w-none">
                                <!-- ä¾é ¼æ›¸ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Dify Chatbot Configuration -->
    <div id="dify-chatbot-container" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; background: white;">
        <div style="position: relative; width: 100%; height: 100%;">
            <button id="closeChatButton" onclick="closeChatbot()" style="position: absolute; top: 20px; right: 20px; z-index: 10001; background: #dc3545; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                <i class="fas fa-times"></i>
            </button>
            <iframe id="dify-chatbot-iframe" 
                    src="https://udify.app/chatbot/zZnpWhZO5XvEvHU7" 
                    style="width: 100%; height: 100%; border: none;"
                    allow="microphone; camera">
            </iframe>
        </div>
    </div>

    <!-- Google Sheets API Script -->
    <script src="js/google-sheets.js"></script>
    
    <!-- æ¥½å¤©APIé€£æºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/rakuten-api.js"></script>
    <script src="js/rakuten-review-analyzer.js"></script>
    <script src="js/rakuten-workflow.js"></script>
    <script src="js/rakuten-ui.js"></script>

    <!-- Main App Script -->
    <script>
        // Tab switching function
        function switchTab(tabName) {
            console.log('ğŸ”„ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            
            // Remove active class from all tabs and hide all contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Add active class to selected tab and show content
            event.target.classList.add('active');
            
            // Show appropriate tab content
            if (tabName === 'research') {
                document.getElementById('research-content').style.display = 'block';
            } else if (tabName === 'results') {
                document.getElementById('results-content').style.display = 'block';
                setTimeout(initializeResultCharts, 100);
            } else if (tabName === 'analysis') {
                document.getElementById('analysis-content').style.display = 'block';
                setTimeout(initializeTrendChart, 100);
            } else if (tabName === 'reviews') {
                console.log('ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚’è¡¨ç¤ºä¸­...');
                document.getElementById('reviewsTab').style.display = 'block';
                
                // currentDataã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                console.log('ğŸ“‹ currentDataçŠ¶æ…‹:', {
                    exists: !!currentData,
                    hasData: !!(currentData && currentData.data),
                    dataLength: currentData && currentData.data ? currentData.data.length : 0,
                    hasHeaders: !!(currentData && currentData.headers)
                });
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚’å®Ÿè¡Œ
                if (currentData && currentData.data) {
                    console.log('ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æé–¢æ•°ã‚’å®Ÿè¡Œä¸­...');
                    setTimeout(() => {
                        updateReviewSentimentAnalysis(currentData.data, currentData.headers);
                        updateReviewInsights(currentData.data, currentData.headers);
                        updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
                    }, 100);
                } else {
                    console.log('âš ï¸ currentDataãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ...');
                    loadAndDisplayData();
                }
            }
        }

        // Chat state tracking
        let chatbotIsOpen = false;
        
        // Start/Close chat function
        function startChat() {
            if (chatbotIsOpen) {
                closeChatbot();
                return;
            }
            
            console.log('ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™');
            
            // ã‚«ã‚¹ã‚¿ãƒ iframeã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
            const chatContainer = document.getElementById('dify-chatbot-container');
            if (chatContainer) {
                chatContainer.style.display = 'block';
                chatbotIsOpen = true;
                updateChatButton();
                console.log('âœ… Difyãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            } else {
                console.error('âŒ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                alert('ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // Close chatbot function
        function closeChatbot() {
            console.log('ğŸ”‡ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’é–‰ã˜ã¾ã™');
            
            // ã‚«ã‚¹ã‚¿ãƒ iframeã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
            const chatContainer = document.getElementById('dify-chatbot-container');
            if (chatContainer) {
                chatContainer.style.display = 'none';
                console.log('âœ… Difyãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’é–‰ã˜ã¾ã—ãŸ');
            }
            
            chatbotIsOpen = false;
            updateChatButton();
        }
        
        // Update button text based on chat state
        function updateChatButton() {
            const chatButton = document.querySelector('.start-chat-button');
            if (chatButton) {
                const icon = chatButton.querySelector('i');
                const text = chatButton.querySelector('span');
                
                if (chatbotIsOpen) {
                    if (icon) {
                        icon.className = 'fas fa-times mr-3';
                    }
                    if (text) {
                        text.textContent = 'ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã‚‹';
                    }
                    chatButton.style.backgroundColor = '#ffffff';
                    chatButton.style.borderColor = '#dc3545';
                    chatButton.style.color = '#dc3545';
                } else {
                    if (icon) {
                        icon.className = 'fas fa-comments mr-3';
                    }
                    if (text) {
                        text.textContent = 'ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹';
                    }
                    chatButton.style.backgroundColor = '#ffffff';
                    chatButton.style.borderColor = '#0d6efd';
                    chatButton.style.color = '#212529';
                }
            }
        }
        
        // ESC key listener for closing chat
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && chatbotIsOpen) {
                console.log('âŒ¨ï¸ ESCã‚­ãƒ¼ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã¾ã™');
                closeChatbot();
            }
        });

        // Global variables for charts
        let priceChart = null;
        let ratingChart = null;
        let trendChart = null;
        let positioningChart = null;
        let sentimentDistributionChart = null;
        let sentimentTrendChart = null; // æ„Ÿæƒ…ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆç”¨ã®å¤‰æ•°ã‚’è¿½åŠ 
        let productSentimentComparisonChart = null;
        let currentData = null;

        // Initialize result charts with dynamic data
        async function initializeResultCharts() {
            await loadAndDisplayData();
        }

        // Table management variables
        let currentPage = 1;
        let rowsPerPage = 10;
        let sortColumn = null;
        let sortDirection = 'asc';
        let searchTerm = '';
        let filteredData = [];

        // Load data from Google Sheets and display
        async function loadAndDisplayData() {
            showLoading(true);
            hideError();
            
            try {
                // Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ï¼‰
                const rawData = await googleSheetsAPI.fetchSheetData();
                const processedData = googleSheetsAPI.processData(rawData);
                
                currentData = processedData;
                
                // èª¿æŸ»çµæœã‚¿ãƒ–ã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚‚æ¸¡ã™ï¼‰
                displayDataTableWithHeaders(processedData);
                
                // åˆ†æçµæœã‚¿ãƒ–ã§ã¯çµ±è¨ˆã¨ãƒãƒ£ãƒ¼ãƒˆ
                updateAnalysisTab(processedData.stats);
                
                showLoading(false);
                console.log('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ:', processedData);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`);
                
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                showLoading(false);
            }
        }

        // Display data with proper headers (new function)
        function displayDataTableWithHeaders(processedData) {
            console.log('ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºé–‹å§‹:', processedData);
            
            if (!processedData || !processedData.rawData || processedData.rawData.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º');
                showEmptyTable();
                return;
            }

            const headers = processedData.headers || ['æ¤œç´¢é †ä½', 'å•†å“å', 'ä¾¡æ ¼', 'å•†å“URL', 'ã‚µãƒ ãƒURL', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥'];
            const rawData = processedData.rawData;
            
            console.log('ğŸ“‹ ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
            console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿è¡Œæ•°:', rawData.length);
            console.log('ğŸ” æœ€åˆã®3è¡Œãƒ‡ãƒ¼ã‚¿:', rawData.slice(0, 3));
            
            // ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ã‚’æ›´æ–°
            updateDataOverview(rawData.length, headers.length);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            createTableHeader(headers);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ
            filteredData = filterAndSortData(rawData, headers);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’ä½œæˆ
            renderTableBody(filteredData, headers);
        }

        // Display data with proper headers (legacy function for compatibility)
        function displayDataTable(rawData) {
            console.log('ğŸ“Š ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º - è¡Œæ•°:', rawData ? rawData.length : 0);
            
            if (!rawData || rawData.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º');
                showEmptyTable();
                return;
            }

            // å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
            const headers = currentData && currentData.headers ? currentData.headers : 
                ['æ¤œç´¢é †ä½', 'å•†å“å', 'ä¾¡æ ¼', 'å•†å“URL', 'ã‚µãƒ ãƒURL', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥'];
            
            console.log('ğŸ“‹ ä½¿ç”¨ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
            console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿è¡Œæ•°:', rawData.length);
            
            // ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ã‚’æ›´æ–°
            updateDataOverview(rawData.length, headers.length);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            createTableHeader(headers);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ
            filteredData = filterAndSortData(rawData, headers);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’ä½œæˆ
            renderTableBody(filteredData, headers);
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            updatePagination();
            
            // ç©ºãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã‚’éè¡¨ç¤º
            document.getElementById('emptyTable').classList.add('hidden');
            document.getElementById('dataOverview').classList.remove('hidden');
        }

        // Create table header
        function createTableHeader(headers) {
            const thead = document.querySelector('#dataTable thead');
            thead.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            
            // æŒ‡å®šã•ã‚ŒãŸé †åºã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
            const displayOrder = [
                { name: 'æ¤œç´¢é †ä½', column: 'æ¤œç´¢é †ä½' },
                { name: 'å•†å“æƒ…å ±', column: 'å•†å“å' }, // å•†å“æƒ…å ±è¤‡åˆåˆ—
                { name: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥', column: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥' },
                { name: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', column: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°' },
                { name: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', column: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡' }
            ];
            
            displayOrder.forEach(({ name, column }) => {
                const columnIndex = headers.indexOf(column);
                
                // åˆ—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (columnIndex === -1 && name !== 'å•†å“æƒ…å ±') {
                    return;
                }
                
                const th = document.createElement('th');
                th.classList.add('sortable');
                
                if (name === 'å•†å“æƒ…å ±') {
                    // å•†å“æƒ…å ±è¤‡åˆåˆ—
                    th.dataset.column = headers.indexOf('å•†å“å');
                    th.addEventListener('click', () => {
                        sortTable(headers.indexOf('å•†å“å'));
                    });
                } else {
                    // é€šå¸¸ã®åˆ—
                    th.dataset.column = columnIndex;
                    th.addEventListener('click', () => {
                        sortTable(columnIndex);
                    });
                }
                
                // ã‚½ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä»˜ãã®ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
                let headerText = name;
                const checkIndex = name === 'å•†å“æƒ…å ±' ? headers.indexOf('å•†å“å') : columnIndex;
                if (sortColumn === checkIndex) {
                    headerText += sortDirection === 'asc' ? ' â†‘' : ' â†“';
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
                th.textContent = headerText;
                
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
        }

        // Filter and sort data
        function filterAndSortData(dataRows, headers) {
            let filtered = [...dataRows];
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (searchTerm) {
                filtered = filtered.filter(row => 
                    row.some(cell => 
                        String(cell).toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
            }
            
            // ã‚½ãƒ¼ãƒˆ
            if (sortColumn !== null) {
                const headerName = headers[sortColumn];
                
                filtered.sort((a, b) => {
                    const aVal = a[sortColumn] || '';
                    const bVal = b[sortColumn] || '';
                    
                    let comparison = 0;
                    
                    // æ—¥ä»˜åˆ—ã®å ´åˆ
                    if (headerName === 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥') {
                        const aDate = parseDateValue(aVal);
                        const bDate = parseDateValue(bVal);
                        
                        if (aDate && bDate) {
                            comparison = aDate.getTime() - bDate.getTime();
                        } else if (aDate) {
                            comparison = 1;
                        } else if (bDate) {
                            comparison = -1;
                        } else {
                            comparison = String(aVal).localeCompare(String(bVal));
                        }
                    }
                    // æ•°å€¤åˆ—ã®å ´åˆï¼ˆä¾¡æ ¼ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡ãªã©ï¼‰
                    else if (['ä¾¡æ ¼', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', 'æ¤œç´¢é †ä½'].includes(headerName)) {
                        const aNum = parseFloat(String(aVal).replace(/[^\d.-]/g, ''));
                        const bNum = parseFloat(String(bVal).replace(/[^\d.-]/g, ''));
                        
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            comparison = aNum - bNum;
                        } else if (!isNaN(aNum)) {
                            comparison = 1;
                        } else if (!isNaN(bNum)) {
                            comparison = -1;
                        } else {
                            comparison = String(aVal).localeCompare(String(bVal));
                        }
                    }
                    // æ–‡å­—åˆ—åˆ—ã®å ´åˆï¼ˆå•†å“åã€URLãªã©ï¼‰
                    else {
                        comparison = String(aVal).localeCompare(String(bVal));
                    }
                    
                    return sortDirection === 'asc' ? comparison : -comparison;
                });
            }
            
            return filtered;
        }

        // Render table body with pagination
        function renderTableBody(data, headers) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = rowsPerPage === 'all' ? data.length : startIndex + parseInt(rowsPerPage);
            const pageData = data.slice(startIndex, endIndex);
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                
                // æŒ‡å®šã•ã‚ŒãŸé †åºã§ã‚»ãƒ«ã‚’è¿½åŠ 
                const displayOrder = [
                    { name: 'æ¤œç´¢é †ä½', column: 'æ¤œç´¢é †ä½' },
                    { name: 'å•†å“æƒ…å ±', column: null }, // å•†å“æƒ…å ±è¤‡åˆåˆ—
                    { name: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥', column: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥' },
                    { name: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', column: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°' },
                    { name: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', column: 'ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡' }
                ];
                
                displayOrder.forEach(({ name, column }) => {
                    if (name === 'å•†å“æƒ…å ±') {
                        // å•†å“æƒ…å ±è¤‡åˆåˆ—ã‚’ä½œæˆ
                        const productInfoTd = createProductInfoCell(row, headers);
                        tr.appendChild(productInfoTd);
                    } else {
                        // é€šå¸¸ã®åˆ—
                        const columnIndex = headers.indexOf(column);
                        
                        // åˆ—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (columnIndex === -1) {
                            return;
                        }
                        
                        const td = document.createElement('td');
                        let cellContent = row[columnIndex] || '';
                        
                        // ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥ã®å ´åˆã¯æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        if (column === 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥' && cellContent) {
                            cellContent = formatDate(cellContent);
                        }
                        // æ•°å€¤é …ç›®ã®å ´åˆï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã€å¹³å‡ãªã©ï¼‰
                        else if (column.includes('ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°')) {
                            if (cellContent === '' || cellContent === null || cellContent === undefined) {
                                cellContent = '0ä»¶';
                            } else {
                                const num = Number(cellContent);
                                cellContent = num.toLocaleString() + 'ä»¶';
                            }
                        }
                        else if (column.includes('ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡')) {
                            if (cellContent === '' || cellContent === null || cellContent === undefined) {
                                cellContent = '0.0';
                            } else {
                                const num = Number(cellContent);
                                cellContent = num.toFixed(1);
                            }
                        }
                        // æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        else if (searchTerm && cellContent) {
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            cellContent = String(cellContent).replace(regex, '<span class="search-highlight">$1</span>');
                        }
                        
                        td.innerHTML = cellContent;
                        tr.appendChild(td);
                    }
                });
                
                tbody.appendChild(tr);
            });
        }

        // Sort table
        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'asc';
            }
            
            currentPage = 1; // ãƒªã‚»ãƒƒãƒˆ
            
            if (currentData && currentData.rawData) {
                displayDataTable(currentData.rawData);
            }
        }

        // Parse date value for sorting
        function parseDateValue(dateValue) {
            /**
             * ã‚½ãƒ¼ãƒˆç”¨ã«æ—¥ä»˜ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
             * formatDate()ã‚ˆã‚Šã‚‚å‰ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
             */
            
            if (!dateValue) {
                return null;
            }

            console.log(`ğŸ—“ï¸ parseDateValueå‡¦ç†: å…¥åŠ›="${dateValue}", å‹=${typeof dateValue}`);

            try {
                // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1ã€‘"YYYY-MM-DD" å½¢å¼
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                    const date = new Date(dateValue + 'T00:00:00Z');
                    console.log(`  âœ… YYYY-MM-DD ã‹ã‚‰å¤‰æ›å®Œäº†`);
                    return date;
                }

                // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³2ã€‘"YYYY/MM/DD" å½¢å¼
                if (typeof dateValue === 'string' && /^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateValue)) {
                    const parts = dateValue.split('/');
                    const date = new Date(parts[0], parseInt(parts[1]) - 1, parts[2]);
                    console.log(`  âœ… YYYY/MM/DD ã‹ã‚‰å¤‰æ›å®Œäº†`);
                    return date;
                }

                // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³3ã€‘æ—¢ã«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                    console.log(`  âœ… æ—¢ã«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ`);
                    return dateValue;
                }

                // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³4ã€‘æ±ç”¨çš„ã«Date()ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è©¦è¡Œ
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    console.log(`  âœ… æ±ç”¨Date()ã§å¤‰æ›å®Œäº†`);
                    return date;
                }

                console.log(`  âš ï¸ æ—¥ä»˜ã«å¤‰æ›ã§ãã¾ã›ã‚“`);
                return null;

            } catch (error) {
                console.warn(`  âš ï¸ æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return null;
            }
        }

        // Format date function
        function formatDate(dateValue) {
            /**
             * æ—¥ä»˜ã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
             * è¤‡æ•°ã®å½¢å¼ã«å¯¾å¿œ
             */
            
            if (!dateValue) {
                return '';
            }

            console.log(`ğŸ“… formatDateå‡¦ç†: å…¥åŠ›="${dateValue}", å‹=${typeof dateValue}`);

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1ã€‘"YYYY-MM-DD" å½¢å¼
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                const parts = dateValue.split('-');
                const formatted = `${parts[0]}/${parts[1]}/${parts[2]}`;
                console.log(`  âœ… YYYY-MM-DD ã‹ã‚‰å¤‰æ›: "${formatted}"`);
                return formatted;
            }

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³2ã€‘æ—¢ã« "YYYY/MM/DD" å½¢å¼ã®å ´åˆ
            if (typeof dateValue === 'string' && /^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateValue)) {
                console.log(`  âœ… æ—¢ã«è¡¨ç¤ºå½¢å¼: "${dateValue}"`);
                return dateValue;
            }

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³3ã€‘ã€é‡è¦ã€‘Google Sheets Dateå½¢å¼ "Date(2025,9,31)"
            if (typeof dateValue === 'string' && dateValue.startsWith('Date(')) {
                const matches = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (matches) {
                    const year = parseInt(matches[1]);
                    const monthZeroBased = parseInt(matches[2]);  // 0ãƒ™ãƒ¼ã‚¹ã®æœˆï¼ˆ0=1æœˆ, 9=10æœˆ, 10=11æœˆï¼‰
                    const month = monthZeroBased + 1;             // 1ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›ï¼ˆ1=1æœˆ, 10=10æœˆ, 11=11æœˆï¼‰
                    const day = parseInt(matches[3]);
                    
                    const formatted = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
                    
                    console.log(`  ğŸ” Google Sheets Dateå½¢å¼ã‚’è§£æ:`);
                    console.log(`     å…ƒãƒ‡ãƒ¼ã‚¿: "Date(${year},${monthZeroBased},${day})"`);
                    console.log(`     æœˆã®è§£æ: ${monthZeroBased}(0ãƒ™ãƒ¼ã‚¹) + 1 = ${month}(1ãƒ™ãƒ¼ã‚¹)`);
                    console.log(`     âœ… å¤‰æ›çµæœ: "${formatted}"`);
                    
                    return formatted;
                }
            }

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³4ã€‘Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
                const year = dateValue.getFullYear();
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const day = String(dateValue.getDate()).padStart(2, '0');
                
                const formatted = `${year}/${month}/${day}`;
                console.log(`  âœ… Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å¤‰æ›: "${formatted}"`);
                return formatted;
            }

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³5ã€‘ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ã "YYYY-MM-DD HH:MM:SS"
            if (typeof dateValue === 'string' && dateValue.includes(' ')) {
                const datePart = dateValue.split(' ')[0];
                if (/^\d{4}-\d{2}-\d{2}$/.test(datePart)) {
                    const parts = datePart.split('-');
                    const formatted = `${parts[0]}/${parts[1]}/${parts[2]}`;
                    console.log(`  âœ… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰æŠ½å‡º: "${formatted}"`);
                    return formatted;
                }
            }

            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³6ã€‘"YYYY/MM/DD" å½¢å¼ã¸ã®å¤‰æ›è©¦è¡Œ
            if (typeof dateValue === 'string' && /^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateValue)) {
                console.log(`  âœ… æ—¢ã«å¤‰æ›æ¸ˆã¿: "${dateValue}"`);
                return dateValue;
            }

            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ããªã„å ´åˆã¯å…ƒã®å€¤ã‚’æ–‡å­—åˆ—åŒ–
            const fallback = String(dateValue);
            console.log(`  âš ï¸ å½¢å¼ãŒèªè­˜ã§ãã¾ã›ã‚“ã€‚å…ƒã®å€¤ã‚’è¿”ã—ã¾ã™: "${fallback}"`);
            return fallback;
        }

        // Update data overview
        function updateDataOverview(totalRows, totalColumns) {
            const safeRows = (totalRows || 0);
            const safeCols = (totalColumns || 0);
            
            document.getElementById('totalRows').textContent = safeRows.toLocaleString();
            document.getElementById('totalColumns').textContent = safeCols;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }

        // Update pagination
        function updatePagination() {
            if (rowsPerPage === 'all') {
                document.getElementById('pagination').classList.add('hidden');
                return;
            }
            
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('pagination').classList.add('hidden');
                return;
            }
            
            document.getElementById('pagination').classList.remove('hidden');
            
            // ãƒšãƒ¼ã‚¸æƒ…å ±æ›´æ–°
            const startItem = (currentPage - 1) * rowsPerPage + 1;
            const endItem = Math.min(currentPage * rowsPerPage, filteredData.length);
            document.getElementById('paginationInfo').textContent = 
                `${startItem}-${endItem} / ${filteredData.length}ä»¶`;
            
            // ãƒšãƒ¼ã‚¸ç•ªå·ç”Ÿæˆ
            generatePageNumbers(totalPages);
            
            // å‰å¾Œãƒœã‚¿ãƒ³åˆ¶å¾¡
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        // Generate page numbers
        function generatePageNumbers(totalPages) {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('page-number');
                if (i === currentPage) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => {
                    currentPage = i;
                    if (currentData && currentData.rawData) {
                        displayDataTable(currentData.rawData);
                    }
                });
                pageNumbers.appendChild(button);
            }
        }

        // Show empty table
        function showEmptyTable() {
            document.getElementById('emptyTable').classList.remove('hidden');
            document.getElementById('dataOverview').classList.add('hidden');
            document.getElementById('pagination').classList.add('hidden');
        }

        // Export to CSV
        function exportToCSV() {
            if (!currentData || !currentData.rawData) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¿½åŠ 
            const headers = currentData.headers || ['æ¤œç´¢é †ä½', 'å•†å“å', 'ä¾¡æ ¼', 'å•†å“URL', 'ã‚µãƒ ãƒURL', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥'];
            const headerRow = headers.map(header => `"${header}"`).join(',');
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
            const dataRows = currentData.rawData
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
                
            const csvContent = headerRow + '\n' + dataRows;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `èª¿æŸ»çµæœ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Update analysis tab with statistics and charts
        function updateAnalysisTab(stats) {
            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆå®‰å…¨ãªå€¤ã‚’ä½¿ç”¨ï¼‰
            const safeTotalItems = (stats.totalItems || 0);
            const safeAveragePrice = (stats.averagePrice || 0);
            const safeAverageRating = (stats.averageRating || 0);
            const safeCompetitorCount = (stats.competitorCount || 0);
            
            document.getElementById('analysisTotalItems').textContent = safeTotalItems.toLocaleString();
            document.getElementById('analysisAveragePrice').textContent = `Â¥${safeAveragePrice.toLocaleString()}`;
            document.getElementById('analysisAverageRating').textContent = safeAverageRating;
            document.getElementById('analysisCompetitorCount').textContent = safeCompetitorCount;
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            updatePriceChart(stats.priceDistribution);
            updateRatingChart(stats.ratingDistribution);
            updateTrendChart(stats.trendData || null);
            updateWordCloud(stats.productNameKeywords || []);
            
            // æ–°ã—ã„é«˜åº¦åˆ†ææ©Ÿèƒ½
            updatePositioningChart(currentData.data, currentData.headers);
            updateShippingAnalysis(currentData.data, currentData.headers);
            updateTrendAnalysis(currentData.data, currentData.headers);
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†ææ©Ÿèƒ½
            updateReviewSentimentAnalysis(currentData.data, currentData.headers);
            updateReviewInsights(currentData.data, currentData.headers);
            
            updateAIRecommendations(stats);
        }

        // ä¾¡æ ¼åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updatePriceChart(priceDistribution) {
            const priceCtx = document.getElementById('priceChart');
            if (!priceCtx) return;

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (priceChart) {
                priceChart.destroy();
            }

            const labels = Object.keys(priceDistribution);
            const data = Object.values(priceDistribution);

            priceChart = new Chart(priceCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å•†å“æ•°',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ä¾¡æ ¼å¹…ã«åŸºã¥ã„ã¦ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updatePriceChartWithRange() {
            if (!currentData || !currentData.data) {
                console.warn('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // ä¾¡æ ¼å¹…ã®å…¥åŠ›å€¤ã‚’å–å¾—
            const priceRangeInput = document.getElementById('priceRangeInput');
            const priceRange = parseInt(priceRangeInput.value) || 3000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3000å††
            
            console.log('ğŸ”„ ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­... ä¾¡æ ¼å¹…:', priceRange + 'å††');
            
            // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            const prices = currentData.data
                .map(item => parseFloat(item['ä¾¡æ ¼(é€æ–™è¾¼)'] || item['ä¾¡æ ¼(é€æ–™æŠœ)'] || 0))
                .filter(price => !isNaN(price) && price > 0);
                
            if (prices.length === 0) {
                console.warn('æœ‰åŠ¹ãªä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ–°ã—ã„ä¾¡æ ¼åˆ†å¸ƒã‚’è¨ˆç®—
            const newPriceDistribution = googleSheetsAPI.createPriceDistribution(prices, priceRange);
            
            console.log('ğŸ“Š æ–°ã—ã„ä¾¡æ ¼åˆ†å¸ƒ:', newPriceDistribution);
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            updatePriceChart(newPriceDistribution);
        }

        // è©•ä¾¡åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateRatingChart(ratingDistribution) {
            const ratingCtx = document.getElementById('ratingChart');
            if (!ratingCtx) return;

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (ratingChart) {
                ratingChart.destroy();
            }

            const labels = Object.keys(ratingDistribution);
            const data = Object.values(ratingDistribution);

            ratingChart = new Chart(ratingCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#10b981',
                            '#3b82f6',
                            '#f59e0b',
                            '#ef4444',
                            '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function showLoading(show) {
            const loadingEl = document.getElementById('dataLoading');
            const statsGrid = document.getElementById('statsGrid');
            
            if (loadingEl && statsGrid) {
                if (show) {
                    loadingEl.classList.remove('hidden');
                    statsGrid.style.opacity = '0.5';
                } else {
                    loadingEl.classList.add('hidden');
                    statsGrid.style.opacity = '1';
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
        function showError(message) {
            const errorEl = document.getElementById('dataError');
            const messageEl = document.getElementById('errorMessage');
            
            if (errorEl && messageEl) {
                messageEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
        }

        function hideError() {
            const errorEl = document.getElementById('dataError');
            if (errorEl) {
                errorEl.classList.add('hidden');
            }
        }

        // å…¨ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        function destroyAllCharts() {
            const charts = [priceChart, ratingChart, trendChart, positioningChart, sentimentDistributionChart, sentimentTrendChart, productSentimentComparisonChart];
            charts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            
            // ãƒãƒ£ãƒ¼ãƒˆå¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            priceChart = null;
            ratingChart = null;
            trendChart = null;
            positioningChart = null;
            sentimentDistributionChart = null;
            sentimentTrendChart = null;
            productSentimentComparisonChart = null;
            
            // ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚‚ã‚¯ãƒªã‚¢
            Object.keys(sentimentWordClouds).forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                sentimentWordClouds[canvasId] = null;
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        async function refreshData() {
            destroyAllCharts(); // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å…¨ã¦ç ´æ£„
            if (googleSheetsAPI) {
                await googleSheetsAPI.refreshData();
            }
            await loadAndDisplayData();
        }





        // Update trend chart with real data or mock data
        function updateTrendChart(trendData) {
            const trendCtx = document.getElementById('trendChart');
            if (!trendCtx) return;

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (trendChart) {
                trendChart.destroy();
            }

            let chartData;
            
            if (trendData && trendData.length > 0) {
                // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼šæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                chartData = generateTrendFromRealData(trendData);
            } else {
                // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼šç¾åœ¨ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰æ¨æ¸¬ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç”Ÿæˆ
                chartData = generateMockTrend();
            }

            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'å¹³å‡ä¾¡æ ¼',
                        data: chartData.priceData,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å•†å“æ•°',
                        data: chartData.countData,
                        borderColor: 'rgba(168, 85, 247, 1)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: trendData ? 'å®Ÿãƒ‡ãƒ¼ã‚¿åŸºæº–ãƒˆãƒ¬ãƒ³ãƒ‰' : 'æ¨æ¸¬ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå‚è€ƒå€¤ï¼‰'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å¹³å‡ä¾¡æ ¼ (Â¥)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å•†å“æ•°'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // Generate trend from real data (if date data is available)
        function generateTrendFromRealData(data) {
            // å®Ÿè£…äºˆå®šï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥ãªã©ã‹ã‚‰æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç”Ÿæˆ
            console.log('ğŸ”„ å®Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¬ãƒ³ãƒ‰ç”Ÿæˆï¼ˆæœªå®Ÿè£…ï¼‰:', data);
            return generateMockTrend();
        }

        // Generate mock trend based on current data
        function generateMockTrend() {
            const currentStats = currentData?.stats || {};
            const basePrice = currentStats.averagePrice || 12500;
            const baseCount = currentStats.totalItems || 100;
            
            // éå»6ãƒ¶æœˆã®æ¨æ¸¬ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç”Ÿæˆ
            const labels = [];
            const priceData = [];
            const countData = [];
            
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(`${date.getMonth() + 1}æœˆ`);
                
                // ä¾¡æ ¼ã®å­£ç¯€å¤‰å‹•ã‚’æ¨¡æ“¬ï¼ˆÂ±10%ã®ç¯„å›²ï¼‰
                const priceVariation = 1 + (Math.sin((date.getMonth() + 1) / 12 * Math.PI * 2) * 0.1);
                priceData.push(Math.round(basePrice * priceVariation));
                
                // å•†å“æ•°ã®ç·©ã‚„ã‹ãªå¢—åŠ ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ¨¡æ“¬
                const countVariation = 1 + (i * 0.02) + (Math.random() * 0.1 - 0.05);
                countData.push(Math.round(baseCount * countVariation));
            }
            
            return { labels, priceData, countData };
        }

        // Initialize trend chart (legacy function for initial setup)
        function initializeTrendChart() {
            updateTrendChart(null); // Initialize with mock data
        }

        // WordCloudæ›´æ–°çŠ¶æ…‹ç®¡ç†
        let wordCloudUpdating = false;
        
        // Update word cloud with product name text mining
        function updateWordCloud(keywords) {
            const container = document.getElementById('wordCloud');
            const loading = document.getElementById('wordCloudLoading');
            
            if (!container) return;
            
            // é‡è¤‡æ›´æ–°ã‚’é˜²ã
            if (wordCloudUpdating) {
                console.log('â³ WordCloudæ›´æ–°ä¸­ã®ãŸã‚ã€é‡è¤‡å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            wordCloudUpdating = true;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            if (loading) loading.style.display = 'flex';
            
            setTimeout(() => {
                try {
                    // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•†å“åã‚’æŠ½å‡ºã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°
                    let processedKeywords = keywords;
                    
                    if ((!keywords || keywords.length === 0) && currentData && currentData.data) {
                        console.log('ğŸ”¤ é«˜åº¦ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°ã‚’å®Ÿè¡Œ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)');
                        processedKeywords = extractKeywordsFromProductNames(currentData.data);
                    }
                    
                    // ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰HTMLç”Ÿæˆ
                    const wordCloudHTML = generateWordCloudHTML(processedKeywords);
                    container.innerHTML = wordCloudHTML;
                    
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
                    if (loading) loading.style.display = 'none';
                    
                    // æ›´æ–°å®Œäº†ãƒ•ãƒ©ã‚°
                    wordCloudUpdating = false;
                    
                } catch (error) {
                    console.error('âŒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    container.innerHTML = '<div class="text-center text-gray-500 p-8">ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    if (loading) loading.style.display = 'none';
                    wordCloudUpdating = false;
                }
            }, 500); // å°‘ã—é…å»¶ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åŠ¹æœã‚’æ¼”å‡º
        }

        // Extract keywords from product names
        function extractKeywordsFromProductNames(data) {
            if (!data || data.length === 0) {
                console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ - ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨');
                return getSampleKeywords();
            }
            
            console.log('ğŸ”¤ é«˜åº¦æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹:', data.length, 'ä»¶ã®å•†å“ãƒ‡ãƒ¼ã‚¿');
            console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª:', data[0]);
            
            const productNames = data.map(item => item['å•†å“å'] || '').filter(name => name && name.length > 0);
            console.log('ğŸ“ å®Ÿéš›ã®å•†å“åãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®5ä»¶ï¼‰:', productNames.slice(0, 5));
            console.log('ğŸ“Š å•†å“åç·æ•°:', productNames.length);
            
            // é«˜åº¦ãªæ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
            const keywordCounts = {};
            const bigramCounts = {};   // 2æ–‡å­—çµ„ã¿åˆã‚ã›
            const trigramCounts = {};  // 3æ–‡å­—çµ„ã¿åˆã‚ã›
            
            // æ‹¡å¼µã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰è¾æ›¸
            const stopWords = new Set([
                // åŸºæœ¬åŠ©è©ãƒ»åŠ©å‹•è©
                'ã®', 'ã«', 'ã¯', 'ã‚’', 'ãŒ', 'ã§', 'ã¨', 'ã‹ã‚‰', 'ã¾ã§', 'ã‚ˆã‚Š', 'ãªã©', 'ã“ã¨', 'ã‚‚ã®', 'ãŸã‚',
                'ã“ã‚Œ', 'ãã‚Œ', 'ã‚ã‚Œ', 'ã“ã®', 'ãã®', 'ã‚ã®', 'ã©ã®', 'ã©ã‚Œ', 'ãªã«', 'ãªã‚“', 'ã„ã¤', 'ã©ã“',
                'ã™ã‚‹', 'ãªã‚‹', 'ã‚ã‚‹', 'ã„ã‚‹', 'ã§ãã‚‹', 'ã•ã‚Œã‚‹', 'ã‚Œã‚‹', 'ã‚‰ã‚Œã‚‹', 'ã›ã‚‹', 'ã•ã›ã‚‹',
                
                // å•†å“èª¬æ˜ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹èª
                'ã‚»ãƒƒãƒˆ', 'ã‚¿ã‚¤ãƒ—', 'ã‚µã‚¤ã‚º', 'ã‚«ãƒ©ãƒ¼', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'ä»•æ§˜', 'æ©Ÿèƒ½', 'ç‰¹å¾´', 'åŠ¹æœ', 'å“è³ª',
                'å•†å“', 'è£½å“', 'ã‚¢ã‚¤ãƒ†ãƒ ', 'ã‚°ãƒƒã‚º', 'ç”¨å“', 'å™¨å…·', 'é“å…·', 'ç´ æ', 'æè³ª', 'åŸæ–™',
                
                // æ•°é‡ãƒ»å˜ä½
                'å€‹', 'æœ¬', 'æš', 'è¢‹', 'kg', 'g', 'cm', 'mm', 'L', 'ml', 'cc', 'ã‚µã‚¤ã‚º', 'å®¹é‡',
                
                // è¨˜å·ãƒ»è£…é£¾æ–‡å­—
                'ã€', 'ã€‘', '(', ')', 'ï¼ˆ', 'ï¼‰', '[', ']', 'ï¼', 'ï¼Ÿ', 'ãƒ»', 'â€»', 'â˜…', 'â˜†', 
                'â—†', 'â—‡', 'â—‹', 'â—', 'â–²', 'â–¼', 'â– ', 'â–¡', 'â–³', 'â–½', 'â—', 'ï¼Š', 'â™ª', 'â™¡',
                
                // æ•¬èªãƒ»ä¸å¯§èª
                'ãŠ', 'ã”', 'ã•ã‚“', 'ãã‚“', 'ã¡ã‚ƒã‚“', 'ã§ã™', 'ã¾ã™', 'ã ã¨', 'ã§ã‚ã‚‹', 'ãªã„', 'ãš',
                
                // ä¸€èˆ¬çš„ã™ãã‚‹å½¢å®¹è©
                'æ–°ã—ã„', 'å¤ã„', 'è‰¯ã„', 'æ‚ªã„', 'å¤§ãã„', 'å°ã•ã„', 'é«˜ã„', 'å®‰ã„', 'å¤šã„', 'å°‘ãªã„',
                'ç¾å‘³ã—ã„', 'ãŠã„ã—ã„', 'ã†ã¾ã„', 'ã¾ãšã„', 'ãã‚Œã„', 'æ±šã„', 'ã™ã”ã„', 'ã²ã©ã„'
            ]);
            
            // æ—¥æœ¬èªç‰¹æœ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°è¾æ›¸
            const categoryPatterns = {
                'ãƒ–ãƒ©ãƒ³ãƒ‰': ['ãƒŠã‚¤ã‚­', 'ã‚¢ãƒ‡ã‚£ãƒ€ã‚¹', 'ã‚¢ãƒƒãƒ—ãƒ«', 'ã‚½ãƒ‹ãƒ¼', 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯', 'ç„¡å°è‰¯å“'],
                'é£Ÿå“': ['ãŠç±³', 'ãƒ‘ãƒ³', 'é‡èœ', 'è‚‰', 'é­š', 'ãƒ•ãƒ«ãƒ¼ãƒ„', 'æœç‰©', 'ã‚¹ã‚¤ãƒ¼ãƒ„', 'ãŠè“å­'],
                'é›»åŒ–è£½å“': ['ã‚¹ãƒãƒ›', 'ãƒ‘ã‚½ã‚³ãƒ³', 'ãƒ†ãƒ¬ãƒ“', 'å†·è”µåº«', 'æ´—æ¿¯æ©Ÿ', 'ã‚¨ã‚¢ã‚³ãƒ³', 'ã‚«ãƒ¡ãƒ©'],
                'è¡£é¡': ['Tã‚·ãƒ£ãƒ„', 'ã‚¸ãƒ¼ãƒ³ã‚º', 'ã‚¹ã‚«ãƒ¼ãƒˆ', 'ã‚³ãƒ¼ãƒˆ', 'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ', 'ã‚·ãƒ¥ãƒ¼ã‚º', 'é´ä¸‹'],
                'ç¾å®¹': ['åŒ–ç²§å“', 'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', 'ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ¼', 'ã‚¯ãƒªãƒ¼ãƒ ', 'ç¾å®¹æ¶²', 'ãƒã‚¹ã‚¯']
            };
            
            // é«˜åº¦ãªãƒ†ã‚­ã‚¹ãƒˆå‰å‡¦ç†
            function preprocessText(text) {
                return text
                    // HTMLã‚¿ã‚°é™¤å»
                    .replace(/<[^>]*>/g, '')
                    // ç‰¹æ®Šè¨˜å·ãƒ»æ‹¬å¼§å†…å®¹é™¤å»
                    .replace(/ã€[^ã€‘]*ã€‘/g, '')
                    .replace(/\([^)]*\)/g, '')
                    .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '')
                    .replace(/\[[^\]]*\]/g, '')
                    // æ•°é‡è¡¨ç¾ã®æ­£è¦åŒ–
                    .replace(/[0-9]+\.?[0-9]*[kg|g|L|ml|cm|mm|å€‹|æœ¬|æš|è¢‹|ã‚»ãƒƒãƒˆ|ç‚¹]*/g, '')
                    // ä¾¡æ ¼è¡¨ç¾é™¤å»
                    .replace(/[ï¿¥Â¥]?[0-9,]+å††?/g, '')
                    // è‹±æ•°å­—ã®å‰å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹è¿½åŠ ï¼ˆåˆ†å‰²ã—ã‚„ã™ãã™ã‚‹ï¼‰
                    .replace(/([a-zA-Z0-9])([ã‚-ã‚“])/g, '$1 $2')
                    .replace(/([ã‚-ã‚“])([a-zA-Z0-9])/g, '$1 $2')
                    // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«çµ±ä¸€
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // ä¿è­·ã•ã‚ŒãŸN-gramç”Ÿæˆé–¢æ•°ï¼ˆè¤‡åˆèªã‚’ä¿è­·ï¼‰
            function generateNGrams(text, n) {
                const chars = text.replace(/\s/g, '');
                const ngrams = [];
                const protectedRanges = [];
                
                // è¤‡åˆèªã®ä½ç½®ã‚’ç‰¹å®šã—ã¦ä¿è­·ç¯„å›²ã‚’è¨­å®š
                compoundWordDict.forEach(compound => {
                    let index = text.indexOf(compound);
                    while (index !== -1) {
                        protectedRanges.push({
                            start: index,
                            end: index + compound.length,
                            word: compound
                        });
                        index = text.indexOf(compound, index + 1);
                    }
                });
                
                // ä¿è­·ç¯„å›²ã‚’ã‚½ãƒ¼ãƒˆ
                protectedRanges.sort((a, b) => a.start - b.start);
                
                for (let i = 0; i <= chars.length - n; i++) {
                    // ç¾åœ¨ä½ç½®ãŒä¿è­·ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                    const isProtected = protectedRanges.some(range => 
                        i >= range.start && i + n <= range.end
                    );
                    
                    if (!isProtected) {
                        const gram = chars.substring(i, i + n);
                        // æ„å‘³ã®ã‚ã‚‹N-gramã®ã¿æŠ½å‡º
                        if (!/^[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]*$/.test(gram)) {
                            ngrams.push(gram);
                        }
                    }
                }
                return ngrams;
            }
            
            // è¤‡åˆèªãƒ»ä¸€èˆ¬åè©è¾æ›¸ï¼ˆåˆ†å‰²ã‚’é˜²ãï¼‰
            const compoundWordDict = new Set([
                // æ–‡æˆ¿å…·ãƒ»ã‚ªãƒ•ã‚£ã‚¹ç”¨å“
                'ãƒœãƒ¼ãƒ«ãƒšãƒ³', 'ã‚·ãƒ£ãƒ¼ãƒ—ãƒšãƒ³ã‚·ãƒ«', 'ãƒãƒ¼ã‚«ãƒ¼ãƒšãƒ³', 'ã‚µã‚¤ãƒ³ãƒšãƒ³', 'ãƒ•ã‚§ãƒ«ãƒˆãƒšãƒ³', 
                'ãƒ›ãƒƒãƒã‚­ã‚¹', 'ã‚»ãƒ­ãƒ†ãƒ¼ãƒ—', 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰', 'ãƒ•ã‚¡ã‚¤ãƒ«ãƒœãƒƒã‚¯ã‚¹', 'ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«',
                
                // é›»å­æ©Ÿå™¨
                'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³', 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ', 'ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³', 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—', 'ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³', 
                'ã‚¤ãƒ¤ãƒ›ãƒ³', 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼', 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰', 'ãƒã‚¦ã‚¹ãƒ‘ãƒƒãƒ‰', 'ãƒ¢ãƒ‹ã‚¿ãƒ¼', 'ãƒ—ãƒªãƒ³ã‚¿ãƒ¼',
                
                // æ—¥ç”¨å“ãƒ»é›‘è²¨
                'ãƒ†ã‚£ãƒƒã‚·ãƒ¥ãƒšãƒ¼ãƒ‘ãƒ¼', 'ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼', 'ã‚­ãƒƒãƒãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼', 'ãƒ©ãƒƒãƒ—ãƒ•ã‚£ãƒ«ãƒ ',
                'ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«', 'ã‚´ãƒŸè¢‹', 'æ´—å‰¤', 'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼', 'ãƒªãƒ³ã‚¹', 'ãƒœãƒ‡ã‚£ã‚½ãƒ¼ãƒ—', 'ãƒãƒ³ãƒ‰ã‚¯ãƒªãƒ¼ãƒ ',
                
                // é£Ÿå“ãƒ»é£²æ–™
                'ã‚³ãƒ¼ãƒ’ãƒ¼è±†', 'ç·‘èŒ¶', 'ç´…èŒ¶', 'ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼', 'ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯', 'ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯',
                'ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³', 'ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ', 'ãƒ“ã‚¿ãƒŸãƒ³', 'ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«', 'ã”ã¾æ²¹', 'é†¤æ²¹', 'å‘³å™Œ',
                
                // è¡£é¡ãƒ»ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼
                'Tã‚·ãƒ£ãƒ„', 'ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„', 'ã‚¸ãƒ¼ãƒ³ã‚º', 'ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼', 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚·ãƒ¥ãƒ¼ã‚º', 'ãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ¥ãƒ¼ã‚º',
                'è…•æ™‚è¨ˆ', 'ãƒãƒƒã‚¯ãƒ¬ã‚¹', 'ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ', 'ã‚¤ãƒ¤ãƒªãƒ³ã‚°', 'ãƒ”ã‚¢ã‚¹', 'ãƒªãƒ³ã‚°',
                
                // ã‚¹ãƒãƒ¼ãƒ„ãƒ»ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢
                'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚·ãƒ¥ãƒ¼ã‚º', 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¦ã‚§ã‚¢', 'ãƒ¨ã‚¬ãƒãƒƒãƒˆ', 'ãƒ€ãƒ³ãƒ™ãƒ«', 'ãƒãƒ¼ãƒ™ãƒ«',
                'ãƒ†ãƒ‹ã‚¹ãƒ©ã‚±ãƒƒãƒˆ', 'ã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–', 'ã‚µãƒƒã‚«ãƒ¼ãƒœãƒ¼ãƒ«', 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', 'é‡çƒã‚°ãƒ­ãƒ¼ãƒ–'
            ]);
            
            // è¤‡åˆèªæ¤œå‡ºï¼ˆè¾æ›¸ãƒ™ãƒ¼ã‚¹ + ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ï¼‰
            function extractCompoundWords(text) {
                const compounds = [];
                
                // 1. è¾æ›¸ãƒ™ãƒ¼ã‚¹ã®è¤‡åˆèªæ¤œå‡º
                compoundWordDict.forEach(compound => {
                    if (text.includes(compound)) {
                        compounds.push(compound);
                    }
                });
                
                // 2. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ã®è¤‡åˆèªæ¤œå‡º
                const patterns = [
                    /([^\s]{2,})é™å®š/g,
                    /([^\s]{2,})å°‚ç”¨/g,
                    /([^\s]{2,})å¯¾å¿œ/g,
                    /([^\s]{2,})ã‚¿ã‚¤ãƒ—/g,
                    /([^\s]{2,})ã‚»ãƒƒãƒˆ/g,
                    /å›½ç”£([^\s]{2,})/g,
                    /æ‰‹ä½œã‚Š([^\s]{2,})/g,
                    /([^\s]{2,})é¢¨å‘³/g,
                    /([^\s]{2,})ä»•æ§˜/g,
                    /([^\s]{2,})æ©Ÿèƒ½/g,
                    /([^\s]{2,})åŠ å·¥/g,
                    /([^\s]{2,})ç´ æ/g
                ];
                
                patterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        if (match[1] && match[1].length >= 2) {
                            compounds.push(match[0]); // å®Œå…¨ä¸€è‡´
                        }
                    }
                });
                
                return compounds;
            }
            
            // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
            productNames.forEach(name => {
                const cleanText = preprocessText(name);
                
                // 1. å˜èªãƒ¬ãƒ™ãƒ«æŠ½å‡ºï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰
                const words = cleanText
                    .split(/\s+/)
                    .filter(word => word.length >= 2 && !stopWords.has(word));
                
                words.forEach(word => {
                    keywordCounts[word] = (keywordCounts[word] || 0) + 1;
                });
                
                // 2. è¤‡åˆèªæŠ½å‡ºï¼ˆé«˜é‡ã¿ä»˜ã‘ï¼‰
                const compounds = extractCompoundWords(cleanText);
                compounds.forEach(compound => {
                    if (compound.length >= 3 && !stopWords.has(compound)) {
                        // è¾æ›¸ã«ç™»éŒ²ã•ã‚ŒãŸè¤‡åˆèªã¯ç‰¹ã«é«˜ã„é‡ã¿
                        const weight = compoundWordDict.has(compound) ? 5 : 3;
                        keywordCounts[compound] = (keywordCounts[compound] || 0) + weight;
                    }
                });
                
                // 3. Bi-gramæŠ½å‡ºï¼ˆ2æ–‡å­—çµ„ã¿åˆã‚ã›ï¼‰
                const bigrams = generateNGrams(cleanText, 2);
                bigrams.forEach(bigram => {
                    if (!stopWords.has(bigram)) {
                        bigramCounts[bigram] = (bigramCounts[bigram] || 0) + 1;
                    }
                });
                
                // 4. Tri-gramæŠ½å‡ºï¼ˆ3æ–‡å­—çµ„ã¿åˆã‚ã›ï¼‰
                const trigrams = generateNGrams(cleanText, 3);
                trigrams.forEach(trigram => {
                    if (!stopWords.has(trigram)) {
                        trigramCounts[trigram] = (trigramCounts[trigram] || 0) + 1;
                    }
                });
            });
            
            // çµæœçµ±åˆã¨é‡ã¿ä»˜ã‘
            const allKeywords = {};
            
            // å˜èªãƒ¬ãƒ™ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŸºæœ¬é‡ã¿: 1.0ï¼‰
            Object.entries(keywordCounts).forEach(([word, count]) => {
                if (count >= 2) { // 2å›ä»¥ä¸Šå‡ºç¾
                    allKeywords[word] = count * 1.0;
                }
            });
            
            // Tri-gramã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆé‡ã¿: 1.5ã€ãŸã ã—è¤‡åˆèªã§ãªã„ã‚‚ã®ï¼‰
            Object.entries(trigramCounts).forEach(([trigram, count]) => {
                if (count >= 3 && !compoundWordDict.has(trigram)) { // è¤‡åˆèªã§ãªã„å ´åˆã®ã¿
                    allKeywords[trigram] = (allKeywords[trigram] || 0) + (count * 1.0); // é‡ã¿è»½æ¸›
                }
            });
            
            // Bi-gramã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆé‡ã¿: 0.6ã€è£œå®Œç”¨ã®ã¿ï¼‰
            Object.entries(bigramCounts).forEach(([bigram, count]) => {
                if (count >= 6 && !allKeywords[bigram] && !compoundWordDict.has(bigram)) {
                    allKeywords[bigram] = count * 0.6; // ã‚ˆã‚Šä½ã„é‡ã¿
                }
            });
            
            // æœ€çµ‚çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆä½œæˆ
            const sortedKeywords = Object.entries(allKeywords)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 60) // ä¸Šä½60å€‹ã«æ‹¡å¼µ
                .map(([word, weight]) => ({ 
                    text: word, 
                    size: Math.round(weight)
                }));
            
            console.log('ğŸ·ï¸ æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ TOP 15:', sortedKeywords.slice(0, 15));
            console.log('ğŸ“ˆ å˜èªãƒ¬ãƒ™ãƒ«:', Object.keys(keywordCounts).length);
            console.log('ğŸ“ˆ Bi-gramæ•°:', Object.keys(bigramCounts).length);
            console.log('ğŸ“ˆ Tri-gramæ•°:', Object.keys(trigramCounts).length);
            console.log('ğŸ¯ æœ€çµ‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°:', sortedKeywords.length);
            
            // ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
            const hasRealData = sortedKeywords.some(k => 
                k.text.includes('ãµã‚‹ã•ã¨') || k.text.includes('ç´ç¨') || 
                k.text.includes('åŒ—æµ·é“') || k.text.includes('æ¥½å¤©') ||
                k.text.length > 1
            );
            console.log('ğŸ” å®Ÿãƒ‡ãƒ¼ã‚¿æ¤œå‡º:', hasRealData ? 'å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º' : 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§');
            
            return sortedKeywords.length > 0 ? sortedKeywords : getSampleKeywords();
        }

        // Get sample keywords for fallback
        function getSampleKeywords() {
            console.log('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨');
            return [
                { text: 'ãµã‚‹ã•ã¨ç´ç¨', size: 45 },
                { text: 'æ¥½å¤©é™å®š', size: 38 },
                { text: 'åŒ—æµ·é“', size: 32 },
                { text: 'ãƒ¡ãƒ­ãƒ³', size: 28 },
                { text: 'æ–°é®®', size: 25 },
                { text: 'ãŠã„ã—ã„', size: 22 },
                { text: 'ç”£ç›´', size: 18 },
                { text: 'é™å®š', size: 15 },
                { text: 'å›½ç”£', size: 12 },
                { text: 'ãƒ•ãƒ«ãƒ¼ãƒ„', size: 10 }
            ];
        }

        // Create product info cell (thumbnail + product details)
        function createProductInfoCell(row, headers) {
            const td = document.createElement('td');
            td.className = 'product-info-cell';
            
            // å„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå‹å®‰å…¨ï¼‰
            const getColumnValue = (columnName) => {
                const index = headers.indexOf(columnName);
                if (index >= 0 && row[index] != null) {
                    const value = row[index];
                    // æ–‡å­—åˆ—ä»¥å¤–ã¯æ–‡å­—åˆ—ã«å¤‰æ›
                    return typeof value === 'string' ? value : String(value);
                }
                return '';
            };
            
            const thumbnailUrl = getColumnValue('ã‚µãƒ ãƒURL');
            const productName = getColumnValue('å•†å“å');
            const productUrl = getColumnValue('å•†å“URL');
            const priceWithoutShipping = getColumnValue('ä¾¡æ ¼(é€æ–™æŠœ)');
            const priceWithShipping = getColumnValue('ä¾¡æ ¼(é€æ–™è¾¼)');
            const reviewCount = getColumnValue('ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°');
            const reviewAvg = getColumnValue('ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡');
            const recentReviewCount = getColumnValue('ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°');
            const recentReviewAvg = getColumnValue('ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡');
            
            // URL ã®å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
            const safeProductUrl = (typeof productUrl === 'string' && productUrl.length > 0) ? productUrl : '';
            const safeThumbnailUrl = (typeof thumbnailUrl === 'string' && thumbnailUrl.length > 0) ? thumbnailUrl : '';
            
            // å•†å“åã‚’20æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚
            const truncatedName = productName.length > 20 ? productName.substring(0, 20) + '...' : productName;
            
            // ä¾¡æ ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆé€æ–™æŠœãä¾¡æ ¼ã‚’ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºï¼‰
            let formattedPrice = 'ä¾¡æ ¼æœªè¨­å®š';
            
            if (priceWithShipping && priceWithoutShipping) {
                // ä¸¡æ–¹ã‚ã‚‹å ´åˆï¼šé€æ–™ã‚’è¨ˆç®—
                const withShippingNum = Number(priceWithShipping);
                const withoutShippingNum = Number(priceWithoutShipping);
                const shippingCost = withShippingNum - withoutShippingNum;
                
                const withoutShippingFormatted = withoutShippingNum.toLocaleString();
                
                if (shippingCost === 0) {
                    // é€æ–™ç„¡æ–™ã®å ´åˆ
                    formattedPrice = `Â¥${withoutShippingFormatted} (é€æ–™ç„¡æ–™)`;
                } else {
                    // é€æ–™ã‚ã‚Šã®å ´åˆ
                    const shippingFormatted = shippingCost.toLocaleString();
                    formattedPrice = `Â¥${withoutShippingFormatted} (é€æ–™Â¥${shippingFormatted})`;
                }
            } else if (priceWithShipping) {
                // é€æ–™è¾¼ã¿ã®ã¿
                formattedPrice = `Â¥${Number(priceWithShipping).toLocaleString()} (é€æ–™è¾¼)`;
            } else if (priceWithoutShipping) {
                // é€æ–™æŠœãã®ã¿
                formattedPrice = `Â¥${Number(priceWithoutShipping).toLocaleString()} (é€æ–™æŠœ)`;
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå…¨æœŸé–“ + ç›´è¿‘3ãƒ¶æœˆï¼‰
            let reviewInfo = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—';
            
            if (reviewCount && reviewAvg) {
                reviewInfo = `${reviewCount}ä»¶ (â˜…${reviewAvg})`;
                
                // ç›´è¿‘3ãƒ¶æœˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ è¡¨ç¤º
                if (recentReviewCount && recentReviewAvg) {
                    reviewInfo += `<br><small class="text-blue-600">ç›´è¿‘3ãƒ¶æœˆ: ${recentReviewCount}ä»¶ (â˜…${recentReviewAvg})</small>`;
                }
            } else if (reviewCount) {
                reviewInfo = `${reviewCount}ä»¶`;
            }
            
            // HTMLæ§‹ç¯‰
            td.innerHTML = `
                <div class="flex gap-3 items-start py-2">
                    <!-- ã‚µãƒ ãƒã‚¤ãƒ«åˆ— -->
                    <div class="flex-shrink-0">
                        ${safeThumbnailUrl && safeThumbnailUrl.startsWith('http') ? 
                            `<img src="${safeThumbnailUrl}" alt="å•†å“ç”»åƒ" class="w-16 h-16 object-cover rounded border shadow-sm" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                             <div class="w-16 h-16 bg-gray-100 rounded border flex items-center justify-center text-gray-400 text-xs" style="display:none;">
                                 <i class="fas fa-image"></i>
                             </div>` :
                            `<div class="w-16 h-16 bg-gray-100 rounded border flex items-center justify-center text-gray-400 text-xs">
                                 <i class="fas fa-image"></i>
                             </div>`
                        }
                    </div>
                    
                    <!-- å•†å“æƒ…å ±åˆ— -->
                    <div class="flex-grow min-w-0">
                        <!-- å•†å“åï¼ˆãƒªãƒ³ã‚¯ä»˜ãï¼‰ -->
                        <div class="mb-1">
                            ${safeProductUrl && safeProductUrl.startsWith('http') ? 
                                `<a href="${safeProductUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium text-sm leading-tight" title="${productName}">
                                     ${truncatedName}
                                 </a>` :
                                `<span class="font-medium text-sm leading-tight text-gray-800" title="${productName}">
                                     ${truncatedName}
                                 </span>`
                            }
                        </div>
                        
                        <!-- ä¾¡æ ¼ -->
                        <div class="text-lg font-semibold text-green-600 mb-1">
                            ${formattedPrice}
                        </div>
                        
                        <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ± -->
                        <div class="text-xs text-gray-500 flex items-start">
                            <i class="fas fa-star text-yellow-400 mr-1 mt-0.5"></i>
                            <div>${reviewInfo}</div>
                        </div>
                    </div>
                </div>
            `;
            
            return td;
        }

        // Generate HTML word cloud with horizontal layout and no overlaps
        // WordCloudç”ŸæˆçŠ¶æ…‹ç®¡ç†
        let wordCloudGenerating = false;
        
        function generateWordCloudHTML(keywords) {
            if (!keywords || keywords.length === 0) {
                return '<div class="text-center text-gray-500 p-8">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            }
            
            // é‡è¤‡ç”Ÿæˆã‚’é˜²ã
            if (wordCloudGenerating) {
                console.log('â³ WordCloudç”Ÿæˆä¸­ã®ãŸã‚ã€é‡è¤‡å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return '<div class="text-center text-gray-500 p-8">ç”Ÿæˆä¸­...</div>';
            }
            
            // Canvas APIãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰å®Ÿè£…
            const canvasId = 'wordCloudCanvas_' + Date.now(); // ä¸€æ„ã®ID
            let html = `<canvas id="${canvasId}" style="width: 100%; height: 480px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 8px;"></canvas>`;
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
            setTimeout(() => {
                wordCloudGenerating = true; // ç”Ÿæˆé–‹å§‹ãƒ•ãƒ©ã‚°
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    wordCloudGenerating = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
                    return;
                }
                
                // æœ€å¤§ãƒ»æœ€å°ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                const maxSize = Math.max(...keywords.map(k => k.size));
                const minSize = Math.min(...keywords.map(k => k.size));
                const sizeRange = maxSize - minSize || 1;
                
                // WordCloud2.jsç”¨ã®é…åˆ—å½¢å¼ã«å¤‰æ› [text, size]
                const wordList = keywords.map(keyword => {
                    // ã‚µã‚¤ã‚ºã‚’12ã€œ60ã®ç¯„å›²ã«ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆWordCloud2.jsæ¨å¥¨ç¯„å›²ï¼‰
                    const normalizedSize = (keyword.size - minSize) / sizeRange;
                    const scaledSize = Math.round(12 + (normalizedSize * 48));
                    return [keyword.text, scaledSize];
                });
                
                // é«˜å“è³ªã‚«ãƒ©ãƒ¼é–¢æ•°ï¼ˆHSLãƒ™ãƒ¼ã‚¹ï¼‰
                function getColor(word, weight, fontSize, distance, theta) {
                    // é‡è¦åº¦ã«å¿œã˜ãŸè‰²ç›¸è¨ˆç®—
                    const normalizedWeight = (weight - 12) / 48; // 0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
                    
                    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼šé‡è¦åº¦ãŒé«˜ã„ã»ã©æš–è‰²ç³»
                    const hues = [
                        210, // é’ç³»ï¼ˆä½é‡è¦åº¦ï¼‰
                        180, // ã‚·ã‚¢ãƒ³ç³»
                        150, // ç·‘ç³»
                        120, // é»„ç·‘ç³»
                        90,  // é»„ç³»
                        60,  // ã‚ªãƒ¬ãƒ³ã‚¸ç³»
                        30,  // èµ¤ã‚ªãƒ¬ãƒ³ã‚¸ç³»
                        0    // èµ¤ç³»ï¼ˆé«˜é‡è¦åº¦ï¼‰
                    ];
                    
                    const hueIndex = Math.floor(normalizedWeight * (hues.length - 1));
                    const hue = hues[hueIndex];
                    
                    // å½©åº¦ã¨æ˜åº¦ã‚’é‡è¦åº¦ã«å¿œã˜ã¦èª¿æ•´
                    const saturation = 65 + (normalizedWeight * 25); // 65-90%
                    const lightness = 45 + (normalizedWeight * 15);  // 45-60%
                    
                    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                }
                
                // é«˜è§£åƒåº¦å¯¾å¿œï¼ˆä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³è¿½åŠ ï¼‰
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
                
                // ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³è¨­å®šï¼ˆ10%ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿ï¼‰
                const verticalMargin = rect.height * 0.1;
                const effectiveHeight = rect.height - (verticalMargin * 2);
                
                // WordCloud2.jsã®é«˜åº¦ãªè¨­å®š
                const options = {
                    list: wordList,
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šï¼ˆé«˜è§£åƒåº¦å¯¾å¿œï¼‰
                    gridSize: Math.max(4, Math.round(8 * (canvas.width / 1024))), // ã‚ˆã‚Šç´°ã‹ã„ã‚°ãƒªãƒƒãƒ‰
                    weightFactor: function(size) {
                        // æ—¥æœ¬èªæ–‡å­—ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚µã‚¤ã‚ºä¿‚æ•°ï¼ˆä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’è€ƒæ…®ï¼‰
                        const baseSize = Math.pow(size, 1.0) * (effectiveHeight / 600);
                        return Math.max(10, Math.min(baseSize, effectiveHeight / 8)); // ã‚ˆã‚Šå°ã•ã‚ã®ã‚µã‚¤ã‚ºåˆ¶é™
                    },
                    
                    // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
                    fontFamily: 'Inter, "Hiragino Sans", "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯", "Noto Sans JP", "Yu Gothic", sans-serif',
                    fontWeight: function(word, weight) {
                        const normalizedWeight = (weight - 12) / 48;
                        if (normalizedWeight > 0.8) return 'bold';
                        if (normalizedWeight > 0.6) return '600';
                        if (normalizedWeight > 0.4) return '500';
                        return 'normal';
                    },
                    
                    // è‰²è¨­å®š
                    color: getColor,
                    
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
                    backgroundColor: 'transparent',
                    
                    // å›è»¢è¨­å®šï¼ˆã™ã¹ã¦æ°´å¹³ï¼‰
                    rotateRatio: 0,      // å›è»¢ãªã—
                    maxRotation: 0,      // æœ€å¤§å›è»¢è§’åº¦0
                    minRotation: 0,      // æœ€å°å›è»¢è§’åº¦0
                    rotationSteps: 1,    // å›è»¢ã‚¹ãƒ†ãƒƒãƒ—æ•°
                    
                    // é…ç½®è¨­å®šï¼ˆä¸­å¤®é›†ç´„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ç¢ºä¿ï¼‰
                    origin: [rect.width/2, rect.height/2 + verticalMargin/2], // ä¸­å¤®é…ç½®ï¼ˆå°‘ã—ä¸‹ã«èª¿æ•´ï¼‰
                    shape: 'circle',     // å††å½¢é…ç½®ã‚’å¼·åˆ¶  
                    ellipticity: 0.65,   // æ¥•å††ç‡ï¼ˆç¸¦ã‚’ã‚ˆã‚Šåœ§ç¸®ã—ã¦ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ç¢ºä¿ï¼‰
                    
                    // æ—¥æœ¬èªæœ€é©åŒ–
                    drawOutOfBound: false,    // å¢ƒç•Œå¤–æç”»ã‚’ç„¡åŠ¹
                    shrinkToFit: true,        // è‡ªå‹•ã‚µã‚¤ã‚ºèª¿æ•´
                    
                    // é…ç½®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æœ€é©åŒ–ï¼ˆä¸Šä¸‹åˆ‡ã‚Šå–ã‚Šé˜²æ­¢ï¼‰
                    minSize: Math.max(8, effectiveHeight / 60), // æœ€å°ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆæœ‰åŠ¹é«˜ã•åŸºæº–ï¼‰
                    maxSize: Math.min(48, effectiveHeight / 8), // æœ€å¤§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºåˆ¶é™
                    
                    // é«˜åº¦ãªé…ç½®åˆ¶å¾¡ï¼ˆä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³å³å®ˆï¼‰
                    wait: 5,             // é…ç½®è©¦è¡Œé–“éš”ï¼ˆmsï¼‰
                    abortThreshold: 30000, // é…ç½®è«¦ã‚ã—ãã„å€¤ï¼ˆçŸ­ç¸®ï¼‰
                    abort: function() {
                        console.log('WordCloudé…ç½®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³å†…ã§å‡¦ç†å®Œäº†');
                        return false;
                    },
                    
                    // å¢ƒç•Œãƒã‚§ãƒƒã‚¯å¼·åŒ–
                    clearCanvas: false,   // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢ã‚’ç„¡åŠ¹åŒ–
                    classes: function(word, weight) {
                        return 'word-item'; // CSSã‚¯ãƒ©ã‚¹è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    },
                    
                    // ãƒ›ãƒãƒ¼åŠ¹æœ
                    hover: function(item, dimension, event) {
                        if (item) {
                            canvas.style.cursor = 'pointer';
                            canvas.title = `${item[0]}: ${item[1]}å›å‡ºç¾`;
                            
                            // ãƒ›ãƒãƒ¼æ™‚ã®è¦–è¦šåŠ¹æœ
                            const originalOpacity = canvas.style.opacity;
                            canvas.style.transition = 'opacity 0.2s ease';
                        } else {
                            canvas.style.cursor = 'default';
                            canvas.title = '';
                        }
                    },
                    
                    // ã‚¯ãƒªãƒƒã‚¯åŠ¹æœ
                    click: function(item, dimension, event) {
                        if (item) {
                            console.log(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯: ${item[0]} (${item[1]}å›å‡ºç¾)`);
                            
                            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åŠ¹æœ
                            canvas.style.transform = 'scale(0.98)';
                            setTimeout(() => {
                                canvas.style.transform = 'scale(1)';
                            }, 150);
                        }
                    },
                    
                    // æç”»å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    drawOutOfBound: function(item) {
                        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šå¢ƒç•Œå¤–ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ­ã‚°å‡ºåŠ›
                        if (item && item[0]) {
                            console.log(`å¢ƒç•Œå¤–é…ç½®: ${item[0]}`);
                        }
                        return false; // å¢ƒç•Œå¤–ã®æç”»ã‚’é˜²ã
                    }
                };
                
                // WordCloud2.jsã§ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆ
                try {
                    // ç”Ÿæˆé–‹å§‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText('ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆä¸­...', rect.width/2, rect.height/2);
                    
                    // éåŒæœŸã§WordCloudã‚’ç”Ÿæˆ
                    WordCloud(canvas, {
                        ...options,
                        // ç”Ÿæˆå®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        drawOutOfBound: function(item) {
                            if (item && item[0]) {
                                console.log(`é…ç½®èª¿æ•´: ${item[0]}`);
                            }
                            return false;
                        },
                        // ç”Ÿæˆé€²è¡ŒçŠ¶æ³ã®ç›£è¦–
                        clearCanvas: true,
                        backgroundColor: 'transparent'
                    });
                    
                    console.log('ğŸ“Š WordCloud2.jsé«˜å“è³ªãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆå®Œäº†');
                    console.log('ğŸ¨ ä½¿ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°:', wordList.length);
                    console.log('ğŸ“ è§£åƒåº¦:', `${canvas.width}x${canvas.height} (DPR: ${dpr})`);
                    
                    // ç”Ÿæˆå®Œäº†ãƒ•ãƒ©ã‚°
                    wordCloudGenerating = false;
                    
                } catch (error) {
                    console.error('âŒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    wordCloudGenerating = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
                    
                    // é«˜å“è³ªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
                    const gradient = ctx.createLinearGradient(0, 0, rect.width, rect.height);
                    gradient.addColorStop(0, '#f8f9fa');
                    gradient.addColorStop(1, '#e9ecef');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, rect.width, rect.height);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    ctx.fillStyle = '#6c757d';
                    ctx.font = 'bold 18px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText('âš ï¸ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰è¡¨ç¤ºã‚¨ãƒ©ãƒ¼', rect.width/2, rect.height/2 - 10);
                    
                    ctx.font = '14px Inter';
                    ctx.fillText('ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„', rect.width/2, rect.height/2 + 20);
                }
                
            }, 300); // DOMæ›´æ–°ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†ã‚’å¾…ã¤
            
            return html;
        }

        // ç«¶åˆãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°åˆ†æãƒãƒ£ãƒ¼ãƒˆ
        function updatePositioningChart(data, headers) {
            const canvas = document.getElementById('positioningChart');
            if (!canvas || !data) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (positioningChart) {
                positioningChart.destroy();
            }
            
            // ä¾¡æ ¼ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            const chartData = [];
            const priceCol = headers.indexOf('ä¾¡æ ¼(é€æ–™è¾¼)') !== -1 ? 'ä¾¡æ ¼(é€æ–™è¾¼)' : 'ä¾¡æ ¼(é€æ–™æŠœ)';
            
            data.forEach((item, index) => {
                const price = parseFloat(item[priceCol]) || 0;
                const rating = parseFloat(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡']) || 0;
                const reviewCount = parseInt(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°']) || 0;
                
                if (price > 0 && rating > 0) {
                    chartData.push({
                        x: price,
                        y: rating,
                        r: Math.max(3, Math.min(20, reviewCount / 50)), // ãƒãƒ–ãƒ«ã‚µã‚¤ã‚º
                        label: item['å•†å“å']?.substring(0, 20) || `å•†å“${index + 1}`
                    });
                }
            });
            
            const ctx = canvas.getContext('2d');
            positioningChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'å•†å“ãƒã‚¸ã‚·ãƒ§ãƒ³ (ä¾¡æ ¼ vs è©•ä¾¡)',
                        data: chartData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'ä¾¡æ ¼ (å††)' },
                            type: 'linear'
                        },
                        y: {
                            title: { display: true, text: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡' },
                            min: 0,
                            max: 6,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (value === 6) {
                                        return '';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.label}: Â¥${context.raw.x.toLocaleString()}, â˜…${context.raw.y}`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }
        
        // é€æ–™æˆ¦ç•¥åˆ†æ
        function updateShippingAnalysis(data, headers) {
            if (!data || data.length === 0) return;
            
            let freeShippingCount = 0;
            let totalShipping = 0;
            let shippingProductCount = 0;
            let totalPriceForRatio = 0;
            
            data.forEach(item => {
                const priceWithShipping = parseFloat(item['ä¾¡æ ¼(é€æ–™è¾¼)']) || 0;
                const priceWithoutShipping = parseFloat(item['ä¾¡æ ¼(é€æ–™æŠœ)']) || 0;
                
                if (priceWithShipping > 0 && priceWithoutShipping > 0) {
                    const shipping = priceWithShipping - priceWithoutShipping;
                    
                    if (shipping === 0) {
                        freeShippingCount++;
                    } else {
                        totalShipping += shipping;
                        shippingProductCount++;
                        totalPriceForRatio += priceWithoutShipping;
                    }
                }
            });
            
            // é€æ–™ç„¡æ–™å•†å“ã®å‰²åˆ
            const freeShippingRate = ((freeShippingCount / data.length) * 100).toFixed(1);
            document.getElementById('freeShippingRate').textContent = `${freeShippingRate}%`;
            
            // å¹³å‡é€æ–™
            const averageShipping = shippingProductCount > 0 ? Math.round(totalShipping / shippingProductCount) : 0;
            document.getElementById('averageShipping').textContent = `Â¥${averageShipping.toLocaleString()}`;
            
            // é€æ–™æ¯”ç‡
            const shippingRatio = totalPriceForRatio > 0 ? ((totalShipping / totalPriceForRatio) * 100).toFixed(1) : 0;
            document.getElementById('shippingRatio').textContent = `${shippingRatio}%`;
        }
        
        // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
        function updateTrendAnalysis(data, headers) {
            if (!data || data.length === 0) return;
            
            const trendingProducts = [];
            const improvingProducts = [];
            
            data.forEach(item => {
                const totalReviews = parseInt(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°']) || 0;
                const recentReviews = parseInt(item['ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°']) || 0;
                const totalRating = parseFloat(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡']) || 0;
                const recentRating = parseFloat(item['ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡']) || 0;
                
                // äººæ°—æ€¥ä¸Šæ˜‡ = ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ãŒå¤šã„
                if (recentReviews > 0) {
                    trendingProducts.push({
                        name: item['å•†å“å']?.substring(0, 25) || 'å•†å“åä¸æ˜',
                        url: item['å•†å“URL'] || '#',
                        recentReviews: recentReviews,
                        growth: totalReviews > 0 ? ((recentReviews / totalReviews) * 100).toFixed(1) : 0
                    });
                }
                
                // æº€è¶³åº¦å‘ä¸Š = ç›´è¿‘è©•ä¾¡ > å…¨ä½“è©•ä¾¡
                if (recentRating > totalRating && recentRating > 0) {
                    improvingProducts.push({
                        name: item['å•†å“å']?.substring(0, 25) || 'å•†å“åä¸æ˜',
                        url: item['å•†å“URL'] || '#',
                        improvement: (recentRating - totalRating).toFixed(2),
                        recentRating: recentRating.toFixed(1)
                    });
                }
            });
            
            // äººæ°—æ€¥ä¸Šæ˜‡å•†å“ TOP 5
            const topTrending = trendingProducts
                .sort((a, b) => b.recentReviews - a.recentReviews)
                .slice(0, 5);
                
            const trendingHtml = topTrending.length > 0 ? 
                topTrending.map((product, index) => `
                    <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                        <span class="text-sm font-medium">${index + 1}. <a href="${product.url}" target="_blank" class="text-blue-600 hover:underline">${product.name}</a></span>
                        <span class="text-green-600 font-bold">${product.recentReviews}ä»¶</span>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500">è©²å½“å•†å“ãªã—</div>';
            
            document.getElementById('trendingProducts').innerHTML = trendingHtml;
            
            // æº€è¶³åº¦å‘ä¸Šå•†å“ TOP 5  
            const topImproving = improvingProducts
                .sort((a, b) => b.improvement - a.improvement)
                .slice(0, 5);
                
            const improvingHtml = topImproving.length > 0 ? 
                topImproving.map((product, index) => `
                    <div class="flex items-center justify-between p-2 bg-blue-50 rounded">
                        <span class="text-sm font-medium">${index + 1}. <a href="${product.url}" target="_blank" class="text-blue-600 hover:underline">${product.name}</a></span>
                        <span class="text-blue-600 font-bold">+${product.improvement}â˜…</span>
                    </div>
                `).join('') : 
                '<div class="text-sm text-gray-500">è©²å½“å•†å“ãªã—</div>';
            
            document.getElementById('improvingProducts').innerHTML = improvingHtml;
        }
        
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†æ
        function updateReviewSentimentAnalysis(data, headers) {
            console.log('ğŸ­ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ„Ÿæƒ…åˆ†æé–‹å§‹ - ãƒ‡ãƒ¼ã‚¿è¡Œæ•°:', data ? data.length : 0);
            
            if (!data || data.length === 0) {
                console.log('âš ï¸ æ„Ÿæƒ…åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                return;
            }
            
            let positiveComments = [];
            let neutralComments = [];
            let negativeComments = [];
            
            console.log('ğŸ“‹ ãƒ˜ãƒƒãƒ€ãƒ¼æ§‹æˆ:', headers);
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’åé›†ãƒ»åˆ†æ
            data.forEach((item, index) => {
                const positive = item['é«˜è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const neutral = item['ä¸­è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const negative = item['ä½è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                
                if (index < 3) {
                    console.log(`ğŸ“ è¡Œ${index + 1}ã‚³ãƒ¡ãƒ³ãƒˆä¾‹:`);
                    console.log('  é«˜è©•ä¾¡:', positive ? positive.substring(0, 50) + '...' : '(ãªã—)');
                    console.log('  ä¸­è©•ä¾¡:', neutral ? neutral.substring(0, 50) + '...' : '(ãªã—)');
                    console.log('  ä½è©•ä¾¡:', negative ? negative.substring(0, 50) + '...' : '(ãªã—)');
                }
                
                if (positive && positive.trim().length > 0) {
                    const comments = positive.split('<br>').filter(c => c && c.trim().length > 5);
                    positiveComments.push(...comments);
                }
                if (neutral && neutral.trim().length > 0) {
                    const comments = neutral.split('<br>').filter(c => c && c.trim().length > 5);
                    neutralComments.push(...comments);
                }
                if (negative && negative.trim().length > 0) {
                    const comments = negative.split('<br>').filter(c => c && c.trim().length > 5);
                    negativeComments.push(...comments);
                }
            });
            
            console.log('ğŸ“Š æ„Ÿæƒ…åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ•°:');
            console.log('  é«˜è©•ä¾¡:', positiveComments.length);
            console.log('  ä¸­è©•ä¾¡:', neutralComments.length);
            console.log('  ä½è©•ä¾¡:', negativeComments.length);
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’è¡¨ç¤º
            document.getElementById('positiveCount').textContent = positiveComments.length;
            document.getElementById('neutralCount').textContent = neutralComments.length;
            document.getElementById('negativeCount').textContent = negativeComments.length;
            
            // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
            const totalComments = positiveComments.length + neutralComments.length + negativeComments.length;
            if (totalComments > 0) {
                const positivePercent = Math.round((positiveComments.length / totalComments) * 100);
                const neutralPercent = Math.round((neutralComments.length / totalComments) * 100);
                const negativePercent = Math.round((negativeComments.length / totalComments) * 100);
                
                document.getElementById('positivePercent').textContent = `${positivePercent}%`;
                document.getElementById('neutralPercent').textContent = `${neutralPercent}%`;
                document.getElementById('negativePercent').textContent = `${negativePercent}%`;
            }
            
            // ç·åˆæ„Ÿæƒ…ã‚¹ã‚³ã‚¢è¨ˆç®— (é«˜è©•ä¾¡3ç‚¹ã€ä¸­è©•ä¾¡2ç‚¹ã€ä½è©•ä¾¡1ç‚¹ã®åŠ é‡å¹³å‡)
            const totalScore = (positiveComments.length * 3 + neutralComments.length * 2 + negativeComments.length * 1);
            const sentimentScore = totalComments > 0 ? (totalScore / totalComments).toFixed(1) : 0;
            document.getElementById('sentimentScore').textContent = `${sentimentScore}/3.0`;
            document.getElementById('totalReviewComments').textContent = totalComments.toLocaleString();
            
            console.log(`ğŸ“ˆ ç·åˆæ„Ÿæƒ…ã‚¹ã‚³ã‚¢: ${sentimentScore}/3.0 (ç·ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${totalComments})`);
            
            // å„æ„Ÿæƒ…åˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆï¼ˆå°‘ã—æ™‚é–“ã‚’ãšã‚‰ã—ã¦å®Ÿè¡Œï¼‰
            setTimeout(() => {
                console.log('ğŸ¨ æ„Ÿæƒ…åˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆé–‹å§‹');
                generateSentimentWordCloud('positiveWordCloud', positiveComments, '#10B981');
            }, 300);
            
            setTimeout(() => {
                generateSentimentWordCloud('neutralWordCloud', neutralComments, '#F59E0B');
            }, 600);
            
            setTimeout(() => {
                generateSentimentWordCloud('negativeWordCloud', negativeComments, '#EF4444');
            }, 900);
        }
        
        // æ„Ÿæƒ…åˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const sentimentWordClouds = {};

        // æ„Ÿæƒ…åˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ç‰ˆï¼‰
        function generateSentimentWordCloud(canvasId, comments, color) {
            console.log(`ğŸ¨ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆé–‹å§‹: ${canvasId} - ã‚³ãƒ¡ãƒ³ãƒˆæ•°:${comments.length}`);
            
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`âŒ ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${canvasId}`);
                return;
            }
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
            const canvasRect = canvas.getBoundingClientRect();
            canvas.width = canvasRect.width || 300;
            canvas.height = canvasRect.height || 250;
            console.log(`ğŸ“ ${canvasId}ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º: ${canvas.width}x${canvas.height}`);
            
            if (!comments || comments.length === 0) {
                console.log(`âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºã§ã™: ${canvasId}`);
                // ç©ºã®å ´åˆã¯ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãªã—', canvas.width/2, canvas.height/2);
                return;
            }
            
            // æ—¢å­˜ã®ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            if (sentimentWordClouds[canvasId]) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                sentimentWordClouds[canvasId] = null;
            }
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
            const keywords = extractKeywordsFromComments(comments);
            console.log(`ğŸ“Š ${canvasId}æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°: ${keywords.length}`);
            
            if (keywords.length === 0) {
                console.log(`âš ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ: ${canvasId}`);
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã§ããªã„å ´åˆã‚‚ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒ‡ãƒ¼ã‚¿ãªã—', canvas.width/2, canvas.height/2);
                return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
            const wordList = keywords.map(keyword => [keyword.text, keyword.size]);
            console.log(`ğŸ“ ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆä¾‹:`, wordList.slice(0, 3));
            
            const canvasBounds = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’é©åˆ‡ã«è¨­å®š
            canvas.width = canvasBounds.width * dpr;
            canvas.height = canvasBounds.height * dpr;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            // WordCloud2.jsã§ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆï¼ˆé…å»¶å®Ÿè¡Œï¼‰
            setTimeout(() => {
                try {
                    console.log(`ğŸ”„ WordCloud2.jså®Ÿè¡Œé–‹å§‹: ${canvasId}`);
                    sentimentWordClouds[canvasId] = true; // ç”Ÿæˆä¸­ãƒ•ãƒ©ã‚°
                    
                    if (typeof WordCloud === 'undefined') {
                        console.error('âŒ WordCloud2.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }
                    
                    // ã‚«ãƒ©ãƒ¼é–¢æ•°
                    function getColor(word, weight, fontSize) {
                        return color || '#666';
                    }
                    
                    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
                    generateCustomWordCloud(canvas, wordList, getColor, canvasId);
                    
                    sentimentWordClouds[canvasId] = 'completed'; // ç”Ÿæˆå®Œäº†ãƒ•ãƒ©ã‚°
                    console.log(`âœ… ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆå®Œäº†: ${canvasId}`);
                    
                } catch (error) {
                    console.error(`âŒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼[${canvasId}]:`, error);
                    sentimentWordClouds[canvasId] = null; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#EF4444';
                    ctx.font = '12px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('ç”Ÿæˆã‚¨ãƒ©ãƒ¼', canvas.width/2, canvas.height/2);
                }
            }, 200); // å°‘ã—é•·ã‚ã®é…å»¶
        }
        
        // ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function extractKeywordsFromComments(comments) {
            console.log('ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºé–‹å§‹ - ã‚³ãƒ¡ãƒ³ãƒˆæ•°:', comments.length);
            
            if (!comments || comments.length === 0) {
                console.log('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                return [];
            }
            
            const keywordCounts = {};
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰¹åŒ–ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ‹¡å¼µç‰ˆï¼‰
            const reviewStopWords = new Set([
                'ã§ã™', 'ã¾ã™', 'ã§ã—ãŸ', 'ã¾ã—ãŸ', 'ã ã¨æ€ã„ã¾ã™', 'ã¨æ€ã†', 'ã¨ã„ã†', 'ã¨ã“ã‚', 'ã¿ãŸã„',
                'ã—ãŸ', 'ã—ã¦', 'ãªã£ã¦', 'ã®ã§', 'ã‘ã©', 'ã‹ã‚‰', 'ã¾ã§', 'ã‚ˆã‚Š', 'ã¨ã¦ã‚‚', 'ã™ã”ã', 'ã‹ãªã‚Š',
                'å•†å“', 'è³¼å…¥', 'è²·ã„', 'æ³¨æ–‡', 'ç™ºé€', 'åˆ°ç€', 'æ¢±åŒ…', 'é…é€', 'å±Šã„', 'Amazon', 'æ¥½å¤©', 'ãµã‚‹ã•ã¨', 'ç´ç¨',
                'ã“ã®', 'ãã®', 'ã‚ã®', 'ã©ã®', 'ã“ã¡ã‚‰', 'ãã¡ã‚‰', 'ã‚ã¡ã‚‰', 'ã“ã‚Œ', 'ãã‚Œ', 'ã‚ã‚Œ', 'ã©ã‚Œ',
                'ã®', 'ã«', 'ã¯', 'ã‚’', 'ãŒ', 'ã§', 'ã¨', 'ã‹ã‚‰', 'ã¾ã§', 'ã‚ˆã‚Š', 'ãªã©', 'ã“ã¨', 'ã‚‚ã®', 'ã‚„ã¤',
                'ã‚ã‚‹', 'ã„ã‚‹', 'ã™ã‚‹', 'ãªã‚‹', 'ãã‚‹', 'ã„ã', 'ãªã„', 'ã ã‘', 'ã—ã‹', 'ã§ã‚‚', 'ã‘ã‚Œã©',
                'æ€ã„', 'æ„Ÿã˜', 'æ°—æŒã¡', 'ä»Šå›', 'ä»Šåº¦', 'ä»Šå¹´', 'æ¥å¹´', 'æ¯å¹´', 'å¹´å‰', 'å¹´å¾Œ',
                'ã¡ã‚‡ã£ã¨', 'ã‚‚ã†å°‘ã—', 'ãã‚‰ã„', 'ãã‚‰ã„', 'ã°ã‹ã‚Š', 'ã ã‚‰ã‘', 'ã¾ã¿ã‚Œ', 'ã¥ãã—',
                '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '10', '11', '12', 'æ—¥', 'æœˆ', 'å¹´'
            ]);
            
            comments.forEach((comment, index) => {
                if (!comment || typeof comment !== 'string') {
                    console.log(`âš ï¸ ç„¡åŠ¹ãªã‚³ãƒ¡ãƒ³ãƒˆ[${index}]:`, comment);
                    return;
                }
                
                // HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                const cleanComment = comment
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/#[0-9]+;/g, '')
                    .replace(/<br>/g, ' ')
                    .replace(/<[^>]*>/g, ' ');
                
                // æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã®æ”¹å–„
                const words = cleanComment
                    .replace(/[ï¼ï¼Ÿã€‚ã€ï¼Œï¼ï¼šï¼›]/g, ' ')
                    .replace(/[ï¼ˆï¼‰()ã€Œã€\[\]ã€ã€‘ã€ˆã€‰ã€Šã€‹]/g, ' ')
                    .replace(/[a-zA-Z0-9]+/g, '')
                    .replace(/[\s\n\r]+/g, ' ')
                    .split(' ')
                    .filter(word => {
                        const trimmed = word.trim();
                        return trimmed.length >= 2 && 
                               trimmed.length <= 8 && 
                               !reviewStopWords.has(trimmed) &&
                               !/^[0-9]+$/.test(trimmed) &&
                               /[ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠæ¼¢å­—]/.test(trimmed);
                    });
                
                words.forEach(word => {
                    const trimmedWord = word.trim();
                    if (trimmedWord.length > 1) {
                        keywordCounts[trimmedWord] = (keywordCounts[trimmedWord] || 0) + 1;
                    }
                });
            });
            
            // é »å‡ºé †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½20å€‹ã‚’å–å¾—
            const sortedKeywords = Object.entries(keywordCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word, count]) => ({ text: word, size: count }));
            
            console.log('âœ… æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°:', sortedKeywords.length);
            console.log('ğŸ“Š ä¸Šä½5ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', sortedKeywords.slice(0, 5));
            
            return sortedKeywords;
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°ï¼ˆé«˜åº¦ãªæ—¥æœ¬èªå‡¦ç†ï¼‰
        function extractKeywordsFromComments(comments) {
            console.log('ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºé–‹å§‹ - ã‚³ãƒ¡ãƒ³ãƒˆæ•°:', comments.length);
            
            if (!comments || comments.length === 0) {
                console.log('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                return [];
            }
            
            const keywordCounts = {};
            
            // HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ‡ã‚³ãƒ¼ãƒ‰é–¢æ•°
            function decodeHtmlEntities(text) {
                return text
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/#[0-9]+;/g, '')
                    .replace(/<br>/g, ' ')
                    .replace(/<[^>]*>/g, ' ');
            }
            
            // é«˜åº¦ãªãƒ†ã‚­ã‚¹ãƒˆå‰å‡¦ç†ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆç‰¹åŒ–ï¼‰
            function preprocessComment(text) {
                return decodeHtmlEntities(text)
                    // ç‰¹æ®Šè¨˜å·ãƒ»æ‹¬å¼§å†…å®¹é™¤å»
                    .replace(/ã€[^ã€‘]*ã€‘/g, '')
                    .replace(/\([^)]*\)/g, '')
                    .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '')
                    .replace(/\[[^\]]*\]/g, '')
                    // æ•°é‡è¡¨ç¾ã®æ­£è¦åŒ–
                    .replace(/[0-9]+\.?[0-9]*[kg|g|L|ml|cm|mm|å€‹|æœ¬|æš|è¢‹|ã‚»ãƒƒãƒˆ|ç‚¹]*/g, '')
                    // ä¾¡æ ¼è¡¨ç¾é™¤å»
                    .replace(/[ï¿¥Â¥]?[0-9,]+å††?/g, '')
                    // æ—¥ä»˜è¡¨ç¾é™¤å»
                    .replace(/[0-9]{4}å¹´|[0-9]{1,2}æœˆ|[0-9]{1,2}æ—¥/g, '')
                    .replace(/[0-9]{1,2}\/[0-9]{1,2}/g, '')
                    // æ„Ÿæƒ…è¡¨ç¾è¨˜å·ã®æ­£è¦åŒ–
                    .replace(/[ï¼!]{2,}/g, 'ï¼')
                    .replace(/[ï¼Ÿ?]{2,}/g, 'ï¼Ÿ')
                    .replace(/[â€¦]{2,}/g, 'â€¦')
                    // è‹±æ•°å­—ã®å‰å¾Œã«ã‚¹ãƒšãƒ¼ã‚¹è¿½åŠ 
                    .replace(/([a-zA-Z0-9])([ã‚-ã‚“])/g, '$1 $2')
                    .replace(/([ã‚-ã‚“])([a-zA-Z0-9])/g, '$1 $2')
                    // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«çµ±ä¸€
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰¹åŒ–ã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰
            const reviewStopWords = new Set([
                // åŸºæœ¬åŠ©è©ãƒ»åŠ©å‹•è©
                'ã®', 'ã«', 'ã¯', 'ã‚’', 'ãŒ', 'ã§', 'ã¨', 'ã‹ã‚‰', 'ã¾ã§', 'ã‚ˆã‚Š', 'ãªã©', 'ã“ã¨', 'ã‚‚ã®', 'ãŸã‚',
                'ã“ã‚Œ', 'ãã‚Œ', 'ã‚ã‚Œ', 'ã“ã®', 'ãã®', 'ã‚ã®', 'ã©ã®', 'ã©ã‚Œ', 'ãªã«', 'ãªã‚“', 'ã„ã¤', 'ã©ã“',
                'ã™ã‚‹', 'ãªã‚‹', 'ã‚ã‚‹', 'ã„ã‚‹', 'ã§ãã‚‹', 'ã•ã‚Œã‚‹', 'ã‚Œã‚‹', 'ã‚‰ã‚Œã‚‹', 'ã›ã‚‹', 'ã•ã›ã‚‹',
                'ã—ãŸ', 'ã—ã¦', 'ã§ã™', 'ã¾ã™', 'ã ã¨', 'ã§ã‚ã‚‹', 'ãªã„', 'ãš', 'ã‘ã©', 'ã§ã‚‚', 'ã—ã‹ã—',
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹èª
                'å•†å“', 'è£½å“', 'ã‚¢ã‚¤ãƒ†ãƒ ', 'ä»Šå›', 'ä»¥å‰', 'å‰å›', 'æ¬¡å›', 'ä»Šåº¦', 'æœ€è¿‘', 'å…ˆæ—¥',
                'æ³¨æ–‡', 'è³¼å…¥', 'è²·ã„', 'å±Šã„', 'åˆ°ç€', 'é…é€', 'ç™ºé€', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'æ„Ÿæƒ³', 'è©•ä¾¡',
                'ãŠåº—', 'ã‚·ãƒ§ãƒƒãƒ—', 'åº—èˆ—', 'ä¼šç¤¾', 'æ¥­è€…', 'ãƒ¡ãƒ¼ã‚«ãƒ¼', 'è²©å£²', 'ä¾¡æ ¼', 'å€¤æ®µ', 'é‡‘é¡',
                'ã‚µã‚¤ã‚º', 'å¤§ãã•', 'é‡ã•', 'è‰²', 'ã‚«ãƒ©ãƒ¼', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'è¦‹ãŸç›®', 'å¤–è¦³', 'åŒ…è£…', 'ç®±',
                
                // ä¸€èˆ¬çš„ã™ãã‚‹æ„Ÿæƒ…è¡¨ç¾
                'ã„ã„', 'ã‚ˆã„', 'è‰¯ã„', 'æ‚ªã„', 'ã ã‚', 'ãƒ€ãƒ¡', 'ã™ã”ã„', 'ã¨ã¦ã‚‚', 'ã‹ãªã‚Š', 'ã‘ã£ã“ã†',
                'æº€è¶³', 'ä¸æº€', 'æ®‹å¿µ', 'æœŸå¾…', 'æ€ã†', 'æ„Ÿã˜', 'æ°—æŒã¡', 'å°è±¡', 'æ„Ÿæƒ³',
                
                // è¨˜å·ãƒ»è£…é£¾æ–‡å­—
                'ã€', 'ã€‘', '(', ')', 'ï¼ˆ', 'ï¼‰', '[', ']', 'ï¼', 'ï¼Ÿ', 'ãƒ»', 'â€»', 'â˜…', 'â˜†', 
                'â—†', 'â—‡', 'â—‹', 'â—', 'â–²', 'â–¼', 'â– ', 'â–¡', 'â–³', 'â–½', 'â—', 'ï¼Š', 'â™ª', 'â™¡'
            ]);
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆå‡¦ç†
            comments.forEach((comment, index) => {
                const cleanComment = preprocessComment(comment);
                console.log(`ã‚³ãƒ¡ãƒ³ãƒˆ${index + 1}å‡¦ç†:`, cleanComment.substring(0, 50) + '...');
                
                if (cleanComment.length < 5) return; // çŸ­ã™ãã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
                
                // 1. å˜èªåˆ†å‰²ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š + æ—¥æœ¬èªç‰¹æœ‰ã®åˆ†å‰²ï¼‰
                const words = cleanComment
                    .split(/[\sã€ã€‚ï¼Œï¼ï¼ï¼Ÿ\n\r]+/)
                    .filter(word => {
                        const trimmed = word.trim();
                        return trimmed.length >= 2 && 
                               trimmed.length <= 10 &&
                               !reviewStopWords.has(trimmed) &&
                               !/^[0-9]+$/.test(trimmed) &&
                               !/^[a-zA-Z]+$/.test(trimmed) &&
                               /[ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠæ¼¢å­—]/.test(trimmed);
                    });
                
                // 2. N-gramå‡¦ç†ï¼ˆ2æ–‡å­—ã€3æ–‡å­—çµ„ã¿åˆã‚ã›ï¼‰
                for (let n = 2; n <= 3; n++) {
                    const ngramText = cleanComment.replace(/\s/g, '');
                    for (let i = 0; i <= ngramText.length - n; i++) {
                        const ngram = ngramText.substring(i, i + n);
                        if (/^[ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠæ¼¢å­—]+$/.test(ngram) && 
                            !reviewStopWords.has(ngram) &&
                            ngram.length === n) {
                            words.push(ngram);
                        }
                    }
                }
                
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ãƒˆ
                words.forEach(word => {
                    const trimmedWord = word.trim();
                    if (trimmedWord.length >= 2) {
                        keywordCounts[trimmedWord] = (keywordCounts[trimmedWord] || 0) + 1;
                    }
                });
            });
            
            // é »å‡ºé †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½30å€‹ã‚’å–å¾—
            const sortedKeywords = Object.entries(keywordCounts)
                .filter(([word, count]) => count >= 2) // 2å›ä»¥ä¸Šå‡ºç¾
                .sort(([,a], [,b]) => b - a)
                .slice(0, 30)
                .map(([word, count]) => ({ text: word, size: count }));
            
            console.log('âœ… æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°:', sortedKeywords.length);
            console.log('ğŸ“Š ä¸Šä½10ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', sortedKeywords.slice(0, 10));
            
            return sortedKeywords.length > 0 ? sortedKeywords : [];
        }
        
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚µã‚¤ãƒˆåˆ†æ
        function updateReviewInsights(data, headers) {
            if (!data || data.length === 0) return;
            
            let allPositiveComments = [];
            let allNegativeComments = [];
            
            // é«˜è©•ä¾¡ãƒ»ä½è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’åé›†
            data.forEach(item => {
                const positive = item['é«˜è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const negative = item['ä½è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                
                if (positive) {
                    const comments = positive.split('<br>').filter(c => c.trim().length > 0);
                    allPositiveComments.push(...comments);
                }
                if (negative) {
                    const comments = negative.split('<br>').filter(c => c.trim().length > 0);
                    allNegativeComments.push(...comments);
                }
            });
            
            // å¼·ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
            const strengthKeywords = extractKeywordsFromComments(allPositiveComments);
            const strengthHtml = strengthKeywords.slice(0, 10).map((keyword, index) => `
                <div class="flex items-center justify-between py-1 px-2 bg-green-50 rounded">
                    <span class="text-sm font-medium text-green-800">${index + 1}. ${keyword.text}</span>
                    <span class="text-xs text-green-600">${keyword.size}å›</span>
                </div>
            `).join('');
            
            const strengthElement = document.getElementById('strengthKeywords');
            if (strengthElement) {
                strengthElement.innerHTML = strengthHtml || '<div class="text-sm text-gray-500">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            }
            
            // èª²é¡Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
            const weaknessKeywords = extractKeywordsFromComments(allNegativeComments);
            const weaknessHtml = weaknessKeywords.slice(0, 10).map((keyword, index) => `
                <div class="flex items-center justify-between py-1 px-2 bg-red-50 rounded">
                    <span class="text-sm font-medium text-red-800">${index + 1}. ${keyword.text}</span>
                    <span class="text-xs text-red-600">${keyword.size}å›</span>
                </div>
            `).join('');
            
            const weaknessElement = document.getElementById('weaknessKeywords');
            if (weaknessElement) {
                weaknessElement.innerHTML = weaknessHtml || '<div class="text-sm text-gray-500">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            }
        }

        // AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”Ÿæˆ
        function updateAIRecommendations(stats) {
            const recommendations = [];
            
            // ä¾¡æ ¼æˆ¦ç•¥ã®æ¨å¥¨
            if (stats.averagePrice) {
                const optimalPrice = Math.round(stats.averagePrice * 0.9);
                recommendations.push({
                    icon: 'fas fa-yen-sign',
                    color: 'green',
                    text: `ä¾¡æ ¼å¸¯ã‚’Â¥${optimalPrice.toLocaleString()}ä»¥ä¸‹ã«è¨­å®šã™ã‚‹ã“ã¨ã§ç«¶äº‰åŠ›ã‚’ç¢ºä¿`
                });
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆ¦ç•¥ã®æ¨å¥¨
            if (stats.averageRating < 4.0) {
                recommendations.push({
                    icon: 'fas fa-star',
                    color: 'yellow', 
                    text: `ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡${stats.averageRating}ã¯å¸‚å ´å¹³å‡ä»¥ä¸‹ã€‚å“è³ªæ”¹å–„ã¨ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹å¼·åŒ–ã‚’æ¨å¥¨`
                });
            }
            
            // é€æ–™æˆ¦ç•¥ã®æ¨å¥¨
            const freeShippingElement = document.getElementById('freeShippingRate');
            if (freeShippingElement) {
                const freeShippingRate = parseFloat(freeShippingElement.textContent) || 0;
                if (freeShippingRate < 30) {
                    recommendations.push({
                        icon: 'fas fa-shipping-fast',
                        color: 'blue',
                        text: `é€æ–™ç„¡æ–™å•†å“ãŒ${freeShippingRate}%ã¨å°‘ãªã„ã€‚é€æ–™ç„¡æ–™æˆ¦ç•¥ã®æ¤œè¨ã‚’æ¨å¥¨`
                    });
                }
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'fas fa-chart-line',
                    color: 'purple',
                    text: 'å¸‚å ´åˆ†æã«åŸºã¥ãæˆ¦ç•¥çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ç«¶äº‰å„ªä½ã‚’ç¢ºä¿'
                });
            }
            
            const recommendationsHtml = recommendations.map(rec => `
                <li class="flex items-start">
                    <i class="${rec.icon} text-${rec.color}-500 mr-2 mt-1"></i>
                    <span>${rec.text}</span>
                </li>
            `).join('');
            
            const aiRecommendationsElement = document.getElementById('aiRecommendations');
            if (aiRecommendationsElement) {
                aiRecommendationsElement.innerHTML = recommendationsHtml;
            }
        }

        // é«˜åº¦ãªãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æ
        function updateAdvancedReviewAnalysis(data, headers) {
            if (!data || data.length === 0) return;
            
            console.log('ğŸ” é«˜åº¦ãªãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æé–‹å§‹:', data.length, 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿');
            
            let totalPositive = 0;
            let totalNeutral = 0; 
            let totalNegative = 0;
            let productSentimentData = [];
            
            // å•†å“åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢åˆ†æ
            data.forEach(item => {
                const productName = item['å•†å“å'] || 'å•†å“åä¸æ˜';
                const positiveComments = item['é«˜è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const neutralComments = item['ä¸­è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const negativeComments = item['ä½è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                
                const positiveCount = positiveComments ? positiveComments.split('<br>').filter(c => c.trim().length > 0).length : 0;
                const neutralCount = neutralComments ? neutralComments.split('<br>').filter(c => c.trim().length > 0).length : 0;
                const negativeCount = negativeComments ? negativeComments.split('<br>').filter(c => c.trim().length > 0).length : 0;
                
                totalPositive += positiveCount;
                totalNeutral += neutralCount;
                totalNegative += negativeCount;
                
                // å•†å“åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è¨ˆç®— (3ç‚¹æº€ç‚¹)
                const totalComments = positiveCount + neutralCount + negativeCount;
                const sentimentScore = totalComments > 0 ? 
                    ((positiveCount * 3 + neutralCount * 2 + negativeCount * 1) / totalComments).toFixed(2) : 0;
                
                if (totalComments >= 3) { // æœ€ä½3ã‚³ãƒ¡ãƒ³ãƒˆä»¥ä¸Šã®å•†å“ã®ã¿
                    productSentimentData.push({
                        name: productName.substring(0, 20),
                        score: parseFloat(sentimentScore),
                        totalComments: totalComments,
                        positiveCount: positiveCount,
                        neutralCount: neutralCount,
                        negativeCount: negativeCount
                    });
                }
            });
            
            // å…¨ä½“çµ±è¨ˆã‚’æ›´æ–°
            const totalComments = totalPositive + totalNeutral + totalNegative;
            const totalReviewElement = document.getElementById('totalReviewComments');
            if (totalReviewElement) {
                totalReviewElement.textContent = totalComments.toLocaleString();
            }
            
            // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
            const positivePercent = totalComments > 0 ? ((totalPositive / totalComments) * 100).toFixed(1) : 0;
            const neutralPercent = totalComments > 0 ? ((totalNeutral / totalComments) * 100).toFixed(1) : 0;
            const negativePercent = totalComments > 0 ? ((totalNegative / totalComments) * 100).toFixed(1) : 0;
            
            // å€‹åˆ¥ã®çµ±è¨ˆã‚’æ›´æ–°
            const positiveCountEl = document.getElementById('positiveCount');
            const neutralCountEl = document.getElementById('neutralCount');
            const negativeCountEl = document.getElementById('negativeCount');
            const positivePercentEl = document.getElementById('positivePercent');
            const neutralPercentEl = document.getElementById('neutralPercent');
            const negativePercentEl = document.getElementById('negativePercent');
            
            if (positiveCountEl) positiveCountEl.textContent = totalPositive.toLocaleString();
            if (neutralCountEl) neutralCountEl.textContent = totalNeutral.toLocaleString();
            if (negativeCountEl) negativeCountEl.textContent = totalNegative.toLocaleString();
            if (positivePercentEl) positivePercentEl.textContent = `${positivePercent}%`;
            if (neutralPercentEl) neutralPercentEl.textContent = `${neutralPercent}%`;
            if (negativePercentEl) negativePercentEl.textContent = `${negativePercent}%`;
            
            // æ„Ÿæƒ…åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
            updateSentimentDistributionChart(totalPositive, totalNeutral, totalNegative);

            // æ„Ÿæƒ…ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ
            updateSentimentTrendChart(data, headers);
            
            // å•†å“åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ  
            updateProductSentimentComparisonChart(productSentimentData);
            
            // æœ€é«˜è©•ä¾¡ãƒ»æœ€ä½è©•ä¾¡å•†å“ã‚’è¡¨ç¤º
            if (productSentimentData.length > 0) {
                const sortedByScore = [...productSentimentData].sort((a, b) => b.score - a.score);
                const topRated = sortedByScore[0];
                const lowestRated = sortedByScore[sortedByScore.length - 1];
                const averageScore = (sortedByScore.reduce((sum, item) => sum + item.score, 0) / sortedByScore.length).toFixed(2);
                
                const topRatedElement = document.getElementById('topRatedProduct');
                if (topRatedElement) {
                    topRatedElement.textContent = `${topRated.name} (â˜…${topRated.score})`;
                }
                
                const lowestRatedElement = document.getElementById('lowestRatedProduct');
                if (lowestRatedElement) {
                    lowestRatedElement.textContent = `${lowestRated.name} (â˜…${lowestRated.score})`;
                }
                
                const averageScoreElement = document.getElementById('averageSentimentScore');
                if (averageScoreElement) {
                    averageScoreElement.textContent = `â˜…${averageScore}/3.0`;
                }
            }
            
            // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
            updateSentimentWordClouds(data, headers);
            
            // AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æç‰ˆï¼‰
            updateReviewBasedRecommendations(productSentimentData, totalPositive, totalNeutral, totalNegative);
            
            console.log('âœ… é«˜åº¦ãªãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æå®Œäº†');
        }
        
        // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°
        function updateSentimentWordClouds(data, headers) {
            if (!data || data.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ã€ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã®ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            console.log('ğŸ¨ ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆé–‹å§‹');
            
            let allPositiveComments = [];
            let allNeutralComments = [];
            let allNegativeComments = [];
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ„Ÿæƒ…åˆ¥ã«åé›†
            data.forEach(item => {
                const positive = item['é«˜è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const neutral = item['ä¸­è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                const negative = item['ä½è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                
                if (positive) {
                    const comments = positive.split('<br>').filter(c => c.trim().length > 5);
                    allPositiveComments.push(...comments);
                }
                if (neutral) {
                    const comments = neutral.split('<br>').filter(c => c.trim().length > 5);
                    allNeutralComments.push(...comments);
                }
                if (negative) {
                    const comments = negative.split('<br>').filter(c => c.trim().length > 5);
                    allNegativeComments.push(...comments);
                }
            });
            
            console.log('ğŸ“Š åé›†ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆæ•° - é«˜è©•ä¾¡:', allPositiveComments.length, 'ä¸­è©•ä¾¡:', allNeutralComments.length, 'ä½è©•ä¾¡:', allNegativeComments.length);
            
            // å„æ„Ÿæƒ…åˆ¥ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã—ã¦ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
            if (allPositiveComments.length > 0) {
                const positiveKeywords = extractKeywordsFromComments(allPositiveComments);
                console.log('ğŸŸ¢ é«˜è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', positiveKeywords.slice(0, 5));
                generateSentimentWordCloud('positiveWordCloud', positiveKeywords, 'positive');
            } else {
                clearWordCloudCanvas('positiveWordCloud', 'é«˜è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            if (allNeutralComments.length > 0) {
                const neutralKeywords = extractKeywordsFromComments(allNeutralComments);
                console.log('ğŸŸ¡ ä¸­è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', neutralKeywords.slice(0, 5));
                generateSentimentWordCloud('neutralWordCloud', neutralKeywords, 'neutral');
            } else {
                clearWordCloudCanvas('neutralWordCloud', 'ä¸­è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            if (allNegativeComments.length > 0) {
                const negativeKeywords = extractKeywordsFromComments(allNegativeComments);
                console.log('ğŸ”´ ä½è©•ä¾¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', negativeKeywords.slice(0, 5));
                generateSentimentWordCloud('negativeWordCloud', negativeKeywords, 'negative');
            } else {
                clearWordCloudCanvas('negativeWordCloud', 'ä½è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }
        
        // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ¥ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
        function generateSentimentWordCloud(canvasId, keywords, sentiment) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !keywords || keywords.length === 0) {
                console.log(`âš ï¸ ${canvasId}: ã‚­ãƒ£ãƒ³ãƒã‚¹ã¾ãŸã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç„¡åŠ¹`);
                return;
            }
            
            console.log(`ğŸ¨ ${sentiment}ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ: ${keywords.length}ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰`);
            
            try {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜è§£åƒåº¦å¯¾å¿œï¼ˆæ•´æ•°å€¤ã«ä¿®æ­£ï¼‰
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = Math.round(rect.width * dpr);
                canvas.height = Math.round(rect.height * dpr);
                
                // 0ã‚„è² ã®å€¤ã‚’é˜²ã
                if (canvas.width <= 0) canvas.width = 300;
                if (canvas.height <= 0) canvas.height = 250;
                
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
                
                // æ„Ÿæƒ…ã«å¿œã˜ãŸã‚«ãƒ©ãƒ¼è¨­å®š
                const getColorForSentiment = function(word, weight, fontSize) {
                    const normalizedWeight = Math.min(1, weight / 30); // 0-1ç¯„å›²ã«æ­£è¦åŒ–
                    
                    switch (sentiment) {
                        case 'positive':
                            // ç·‘ç³»ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
                            const greenHue = 120 + (normalizedWeight * 30); // 120-150åº¦
                            const greenSat = 60 + (normalizedWeight * 20); // 60-80%
                            const greenLight = 35 + (normalizedWeight * 20); // 35-55%
                            return `hsl(${greenHue}, ${greenSat}%, ${greenLight}%)`;
                            
                        case 'neutral':
                            // é»„ç³»ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
                            const yellowHue = 45 + (normalizedWeight * 15); // 45-60åº¦
                            const yellowSat = 65 + (normalizedWeight * 20); // 65-85%
                            const yellowLight = 40 + (normalizedWeight * 15); // 40-55%
                            return `hsl(${yellowHue}, ${yellowSat}%, ${yellowLight}%)`;
                            
                        case 'negative':
                            // èµ¤ç³»ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
                            const redHue = 0 + (normalizedWeight * 20); // 0-20åº¦
                            const redSat = 70 + (normalizedWeight * 20); // 70-90%
                            const redLight = 40 + (normalizedWeight * 15); // 40-55%
                            return `hsl(${redHue}, ${redSat}%, ${redLight}%)`;
                            
                        default:
                            return '#666';
                    }
                };
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
                const maxSize = Math.max(...keywords.map(k => k.size));
                const minSize = Math.min(...keywords.map(k => k.size));
                const sizeRange = maxSize - minSize || 1;
                
                const wordList = keywords.slice(0, 25).map(keyword => {
                    const normalizedSize = (keyword.size - minSize) / sizeRange;
                    const scaledSize = Math.round(8 + (normalizedSize * 32)); // 8-40ã®ç¯„å›²
                    return [keyword.text, scaledSize];
                });
                
                // ä¸€æ™‚çš„ãªã€Œç”Ÿæˆä¸­ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                ctx.clearRect(0, 0, rect.width, rect.height);
                ctx.fillStyle = '#999';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆä¸­...', rect.width/2, rect.height/2);
                
                // Canvas APIãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰å®Ÿè£…
                generateCustomWordCloud(canvas, wordList, getColorForSentiment, sentiment);
                
                console.log(`âœ… ${sentiment}ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆå®Œäº†: ${wordList.length}èª`);
                
            } catch (error) {
                console.error(`âŒ ${sentiment}ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:`, error);
                clearWordCloudCanvas(canvasId, 'ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼');
            }
        }
        
        // Canvas APIãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆ
        function generateCustomWordCloud(canvas, wordList, colorFunction, sentiment) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            try {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (!wordList || wordList.length === 0) {
                    ctx.fillStyle = '#999';
                    ctx.font = '14px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', canvas.width/2, canvas.height/2);
                    return;
                }
                
                // ãƒ¯ãƒ¼ãƒ‰ã®é…ç½®ã‚’è¨ˆç®—
                const words = [];
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const maxRadius = Math.min(canvas.width, canvas.height) * 0.4;
                
                wordList.forEach((wordData, index) => {
                    const [text, size] = wordData;
                    
                    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆ8-32pxç¯„å›²ï¼‰
                    const fontSize = Math.max(8, Math.min(32, size));
                    const color = colorFunction(text, size, fontSize);
                    
                    // é…ç½®ä½ç½®ã‚’è¨ˆç®—ï¼ˆèºæ—‹é…ç½®ï¼‰
                    const angle = (index / wordList.length) * Math.PI * 4 + (index * 0.5);
                    const radius = Math.min(maxRadius, (index / wordList.length) * maxRadius);
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    words.push({
                        text,
                        x: x,
                        y: y,
                        fontSize,
                        color,
                        size
                    });
                });
                
                // ãƒ¯ãƒ¼ãƒ‰ã‚’æç”»
                words.forEach(word => {
                    ctx.font = `${word.fontSize}px Inter, "Hiragino Sans", "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯", sans-serif`;
                    ctx.fillStyle = word.color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆã®å¢ƒç•Œã‚’ç¢ºèª
                    const textMetrics = ctx.measureText(word.text);
                    const textWidth = textMetrics.width;
                    const textHeight = word.fontSize;
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ç¯„å›²å†…ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´
                    let adjustedX = Math.max(textWidth/2, Math.min(canvas.width - textWidth/2, word.x));
                    let adjustedY = Math.max(textHeight/2, Math.min(canvas.height - textHeight/2, word.y));
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆæç”»
                    ctx.fillText(word.text, adjustedX, adjustedY);
                });
                
                console.log(`âœ… ${sentiment}ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆå®Œäº†: ${wordList.length}èª`);
                
            } catch (error) {
                console.error(`âŒ ${sentiment}ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:`, error);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼', canvas.width/2, canvas.height/2);
            }
        }
        
        // ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
        function clearWordCloudCanvas(canvasId, message = '') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const rect = canvas.getBoundingClientRect();
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (message) {
                ctx.fillStyle = '#999';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(message, canvas.width/2, canvas.height/2);
            }
        }
        
        // æ„Ÿæƒ…åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
        function updateSentimentDistributionChart(positive, neutral, negative) {
            const canvas = document.getElementById('sentimentDistributionChart');
            if (!canvas) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (sentimentDistributionChart) {
                sentimentDistributionChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            sentimentDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['é«˜è©•ä¾¡', 'ä¸­è©•ä¾¡', 'ä½è©•ä¾¡'],
                    datasets: [{
                        data: [positive, neutral, negative],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // æ„Ÿæƒ…ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ
        function updateSentimentTrendChart(data, headers) {
            const canvas = document.getElementById('sentimentTrendChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (sentimentTrendChart) {
                sentimentTrendChart.destroy();
            }

            // æœˆã”ã¨ã®æ„Ÿæƒ…ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’é›†è¨ˆ
            const monthlyData = {};

            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            const isObjectArray = data.length > 0 && typeof data[0] === 'object' && !Array.isArray(data[0]);
            
            console.log('ğŸ“Š ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ: ãƒ‡ãƒ¼ã‚¿å½¢å¼=', isObjectArray ? 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—' : 'é…åˆ—ã®é…åˆ—');
            console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', data.length);
            
            if (!isObjectArray) {
                console.error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ãŒæœŸå¾…ã•ã‚Œã¾ã™');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã®ãŸã‚ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', canvas.width / 2, canvas.height / 2);
                return;
            }

            data.forEach((item, index) => {
                const dateValue = item['ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥'];
                const date = parseDateValue(dateValue);
                
                if (index < 3) {
                    console.log(`ğŸ“… è¡Œ${index + 1}: ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ€æ–°æ—¥='${dateValue}', è§£æçµæœ=`, date);
                }
                
                if (date) {
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { positive: 0, neutral: 0, negative: 0 };
                    }
                    
                    const posComments = item['é«˜è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                    const neuComments = item['ä¸­è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';
                    const negComments = item['ä½è©•ä¾¡ãƒ¬ãƒ“ãƒ¥ãƒ¼'] || '';

                    monthlyData[monthKey].positive += posComments.split('<br>').filter(c => c.trim()).length;
                    monthlyData[monthKey].neutral += neuComments.split('<br>').filter(c => c.trim()).length;
                    monthlyData[monthKey].negative += negComments.split('<br>').filter(c => c.trim()).length;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            
            console.log('ğŸ“Š æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿:', monthlyData);
            console.log('ğŸ“Š æ¤œå‡ºã•ã‚ŒãŸæœˆ:', sortedMonths);

            if (sortedMonths.length === 0) {
                 console.warn('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã®ãŸã‚ã®æœ‰åŠ¹ãªæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 ctx.fillStyle = '#6b7280';
                 ctx.textAlign = 'center';
                 ctx.fillText('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã®ãŸã‚ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', canvas.width / 2, canvas.height / 2);
                return;
            }

            // ãƒãƒ£ãƒ¼ãƒˆç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
            const labels = sortedMonths;
            const positiveData = sortedMonths.map(month => monthlyData[month].positive);
            const neutralData = sortedMonths.map(month => monthlyData[month].neutral);
            const negativeData = sortedMonths.map(month => monthlyData[month].negative);
            
            sentimentTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'é«˜è©•ä¾¡',
                            data: positiveData,
                            borderColor: '#10B981',
                            backgroundColor: 'transparent',
                            tension: 0.3
                        },
                        {
                            label: 'ä¸­è©•ä¾¡',
                            data: neutralData,
                            borderColor: '#F59E0B',
                            backgroundColor: 'transparent',
                            tension: 0.3
                        },
                        {
                            label: 'ä½è©•ä¾¡',
                            data: negativeData,
                            borderColor: '#EF4444',
                            backgroundColor: 'transparent',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ã‚³ãƒ¡ãƒ³ãƒˆæ•°'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }


        // å•†å“åˆ¥æ„Ÿæƒ…ã‚¹ã‚³ã‚¢æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ
        function updateProductSentimentComparisonChart(productData) {
            const canvas = document.getElementById('productSentimentComparisonChart');
            if (!canvas || productData.length === 0) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (productSentimentComparisonChart) {
                productSentimentComparisonChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            const sortedData = productData.sort((a, b) => b.score - a.score).slice(0, 10); // ä¸Šä½10å•†å“
            
            productSentimentComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(item => item.name),
                    datasets: [{
                        label: 'æ„Ÿæƒ…ã‚¹ã‚³ã‚¢',
                        data: sortedData.map(item => item.score),
                        backgroundColor: sortedData.map(item => {
                            if (item.score >= 2.5) return '#10B981'; // ç·‘
                            if (item.score >= 2.0) return '#F59E0B'; // é»„
                            return '#EF4444'; // èµ¤
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 3,
                            title: { display: true, text: 'æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ (3ç‚¹æº€ç‚¹)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = sortedData[context.dataIndex];
                                    return `æ„Ÿæƒ…ã‚¹ã‚³ã‚¢: ${item.score}/3.0 (ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${item.totalComments})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ™ãƒ¼ã‚¹AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        function updateReviewBasedRecommendations(productData, positive, neutral, negative) {
            const recommendations = [];
            const total = positive + neutral + negative;
            
            if (total === 0) {
                recommendations.push({
                    icon: 'fas fa-exclamation-triangle',
                    color: 'yellow',
                    text: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚é¡§å®¢ãƒ¬ãƒ“ãƒ¥ãƒ¼åé›†ã®å¼·åŒ–ã‚’æ¨å¥¨'
                });
            } else {
                // æ„Ÿæƒ…åˆ†å¸ƒã«åŸºã¥ãæ¨å¥¨
                const positiveRate = (positive / total) * 100;
                const negativeRate = (negative / total) * 100;
                
                if (positiveRate < 60) {
                    recommendations.push({
                        icon: 'fas fa-arrow-up',
                        color: 'blue',
                        text: `é«˜è©•ä¾¡ç‡ãŒ${positiveRate.toFixed(1)}%ã¨ä½ã„ã€‚å“è³ªå‘ä¸Šã¨ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ã‚’æ¨å¥¨`
                    });
                }
                
                if (negativeRate > 20) {
                    recommendations.push({
                        icon: 'fas fa-exclamation-circle',
                        color: 'red',
                        text: `ä½è©•ä¾¡ç‡ãŒ${negativeRate.toFixed(1)}%ã¨é«˜ã„ã€‚æ—©æ€¥ãªèª²é¡Œå¯¾å¿œãŒå¿…è¦`
                    });
                }
                
                // å•†å“åˆ¥åˆ†æã«åŸºã¥ãæ¨å¥¨
                if (productData.length > 0) {
                    const lowScoreProducts = productData.filter(p => p.score < 2.0).length;
                    if (lowScoreProducts > 0) {
                        recommendations.push({
                            icon: 'fas fa-chart-line',
                            color: 'orange',
                            text: `${lowScoreProducts}å•†å“ãŒæ„Ÿæƒ…ã‚¹ã‚³ã‚¢2.0æœªæº€ã€‚å€‹åˆ¥å•†å“ã®æ”¹å–„ãŒå¿…è¦`
                        });
                    }
                }
                
                // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ¨å¥¨ã‚‚è¿½åŠ 
                if (positiveRate >= 70) {
                    recommendations.push({
                        icon: 'fas fa-star',
                        color: 'green',
                        text: `é«˜è©•ä¾¡ç‡${positiveRate.toFixed(1)}%ã¯å„ªç§€ã€‚ã“ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã‚’æ¨å¥¨`
                    });
                }
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'fas fa-lightbulb',
                    color: 'purple',
                    text: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚’å®šæœŸçš„ã«å®Ÿæ–½ã—ã€ç¶™ç¶šçš„ãªæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨'
                });
            }
            
            const recommendationsHtml = recommendations.map(rec => `
                <li class="flex items-start">
                    <i class="${rec.icon} text-${rec.color}-500 mr-3 mt-1"></i>
                    <span>${rec.text}</span>
                </li>
            `).join('');
            
            const recommendationsElement = document.getElementById('reviewBasedRecommendations');
            if (recommendationsElement) {
                recommendationsElement.innerHTML = recommendationsHtml;
            }
        }

        // å¼·åˆ¶ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æå®Ÿè¡Œ
        function forceReviewAnalysis() {
            console.log('ğŸ”„ å¼·åˆ¶ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æå®Ÿè¡Œ');
            if (currentData && currentData.data) {
                console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª: ' + currentData.data.length + 'ä»¶');
                updateReviewSentimentAnalysis(currentData.data, currentData.headers);
                updateReviewInsights(currentData.data, currentData.headers);
                updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
            } else {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ...');
                loadAndDisplayData().then(() => {
                    if (currentData && currentData.data) {
                        updateReviewSentimentAnalysis(currentData.data, currentData.headers);
                        updateReviewInsights(currentData.data, currentData.headers);
                        updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
                    }
                });
            }
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å•†å“èª¿æŸ»ãƒ»åˆ†æã‚¢ãƒ—ãƒªãŒæº–å‚™å®Œäº†');
            
            // ãƒ‡ãƒ¼ã‚¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const refreshBtn = document.getElementById('refreshDataBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshData);
            }
            
            // ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const updatePriceChartBtn = document.getElementById('updatePriceChart');
            if (updatePriceChartBtn) {
                updatePriceChartBtn.addEventListener('click', updatePriceChartWithRange);
            }
            



            
            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const exportBtn = document.getElementById('exportDataBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportToCSV);
            }
            
            // æ¤œç´¢æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchTerm = e.target.value;
                    currentPage = 1;
                    if (currentData && currentData.rawData) {
                        displayDataTable(currentData.rawData);
                    }
                });
            }
            
            // è¡Œæ•°å¤‰æ›´ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const rowsSelect = document.getElementById('rowsPerPage');
            if (rowsSelect) {
                rowsSelect.addEventListener('change', (e) => {
                    rowsPerPage = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
                    currentPage = 1;
                    if (currentData && currentData.rawData) {
                        displayDataTable(currentData.rawData);
                    }
                });
            }
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const prevBtn = document.getElementById('prevPage');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        if (currentData && currentData.rawData) {
                            displayDataTable(currentData.rawData);
                        }
                    }
                });
            }
            
            const nextBtn = document.getElementById('nextPage');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        if (currentData && currentData.rawData) {
                            displayDataTable(currentData.rawData);
                        }
                    }
                });
            }
            
            // ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const analyzeThumbnailsBtn = document.getElementById('analyzeThumbnailsBtn');
            if (analyzeThumbnailsBtn) {
                analyzeThumbnailsBtn.addEventListener('click', startThumbnailAnalysis);
            }
            
            // ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const generateBriefBtn = document.getElementById('generateBriefBtn');
            if (generateBriefBtn) {
                generateBriefBtn.addEventListener('click', generateDesignBrief);
            }
            
            // ä¾é ¼æ›¸ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const copyBriefBtn = document.getElementById('copyBriefBtn');
            if (copyBriefBtn) {
                copyBriefBtn.addEventListener('click', copyDesignBrief);
            }
            
            // Initialize data loading
            setTimeout(initializeResultCharts, 1000);
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            setTimeout(() => {
                loadAndDisplayData();
            }, 500);
        });
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            console.log('ğŸ”„ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            const targetContent = document.getElementById(`${tabName}-content`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const clickedTab = event?.target?.closest('.tab');
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€åˆ†æã‚’å®Ÿè¡Œ
            if (tabName === 'reviews') {
                console.log('ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚¿ãƒ–é¸æŠ - åˆ†æã‚’é–‹å§‹');
                setTimeout(() => {
                    if (currentData && currentData.data && currentData.headers) {
                        updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
                    } else {
                        console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    }
                }, 300);
            }
            
            // åˆ†æçµæœã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            if (tabName === 'analysis') {
                console.log('ğŸ“ˆ åˆ†æçµæœã‚¿ãƒ–é¸æŠ - ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°');
                setTimeout(() => {
                    if (currentData && currentData.data && currentData.headers) {
                        updateAllCharts(currentData.data, currentData.headers);
                    }
                }, 300);
            }
            
            // ã‚µãƒ ãƒä¾é ¼æ›¸ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€TOP5å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            if (tabName === 'thumbnail') {
                console.log('ğŸ–¼ï¸ ã‚µãƒ ãƒä¾é ¼æ›¸ã‚¿ãƒ–é¸æŠ');
                prepareThumbnailData();
            }
        }
        
        // ã‚µãƒ ãƒã‚¤ãƒ«åˆ†ææ©Ÿèƒ½
        let topTrendingProducts = [];
        
        // TOP5å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
        function prepareThumbnailData() {
            console.log('ğŸ–¼ï¸ TOP5å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­...');
            
            if (!currentData || !currentData.data || currentData.data.length === 0) {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            // äººæ°—æ€¥ä¸Šæ˜‡å•†å“ TOP 5ã‚’å†è¨ˆç®—
            const trendingProducts = [];
            
            currentData.data.forEach(item => {
                const totalReviews = parseInt(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°']) || 0;
                const recentReviews = parseInt(item['ç›´è¿‘3ãƒ¶æœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°']) || 0;
                
                if (recentReviews > 0) {
                    const thumbnailUrl = item['ã‚µãƒ ãƒURL'] || '';
                    
                    trendingProducts.push({
                        name: item['å•†å“å'] || 'å•†å“åä¸æ˜',
                        url: item['å•†å“URL'] || '#',
                        thumbnailUrl: thumbnailUrl,
                        recentReviews: recentReviews,
                        totalReviews: totalReviews,
                        rating: parseFloat(item['ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹³å‡']) || 0,
                        price: parseInt(item['ä¾¡æ ¼']) || 0
                    });
                }
            });
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã§ã‚½ãƒ¼ãƒˆã—ã¦TOP5ã‚’å–å¾—
            topTrendingProducts = trendingProducts
                .sort((a, b) => b.recentReviews - a.recentReviews)
                .slice(0, 5);
            
            console.log('ğŸ“Š TOP5å•†å“ãƒ‡ãƒ¼ã‚¿:', topTrendingProducts);
            
            // ã‚µãƒ ãƒã‚¤ãƒ«URLæœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
            const withThumbnails = topTrendingProducts.filter(p => p.thumbnailUrl);
            console.log(`ğŸ–¼ï¸ ã‚µãƒ ãƒã‚¤ãƒ«ä»˜ãå•†å“: ${withThumbnails.length}/${topTrendingProducts.length}`);
            
            if (withThumbnails.length === 0 && topTrendingProducts.length > 0) {
                console.log('âš ï¸ åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', Object.keys(currentData.data[0] || {}));
                console.log('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', currentData.data[0]);
            }
            
            // ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            if (analyzeBtn && topTrendingProducts.length > 0) {
                analyzeBtn.disabled = false;
                if (withThumbnails.length > 0) {
                    analyzeBtn.innerHTML = `<i class="fas fa-search mr-2"></i>ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æã‚’é–‹å§‹ (${withThumbnails.length}ä»¶)`;
                } else {
                    analyzeBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>ç”»åƒURLä¸è¶³';
                }
            }
        }
        
        // ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æé–‹å§‹
        function startThumbnailAnalysis() {
            console.log('ğŸ” ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æé–‹å§‹');
            
            if (topTrendingProducts.length === 0) {
                alert('å…ˆã«èª¿æŸ»çµæœã‚¿ãƒ–ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„');
                return;
            }
            
            // åˆ†æçŠ¶æ³ã‚’è¡¨ç¤º
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            const statusText = document.getElementById('analysisStatusText');
            statusDiv.classList.remove('hidden');
            statusText.textContent = 'ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’è¡¨ç¤º
            displayThumbnailGallery();
            
            // åˆ†æãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ†æä¸­...';
        }
        
        // ã‚µãƒ ãƒã‚¤ãƒ«ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º
        function displayThumbnailGallery() {
            const gallery = document.getElementById('thumbnailGallery');
            
            const galleryHtml = topTrendingProducts.map((product, index) => `
                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <div class="text-center">
                        <div class="mb-3">
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full">
                                #${index + 1} äººæ°—æ€¥ä¸Šæ˜‡å•†å“
                            </span>
                        </div>
                        <div class="mb-4">
                            ${product.thumbnailUrl ? 
                                `<img src="${product.thumbnailUrl}" alt="${product.name}" class="w-full h-48 object-cover rounded-lg border" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04MCA4MEgxMjBWMTIwSDgwVjgwWiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K'; this.onerror=null;">` 
                                : `<div class="w-full h-48 bg-gray-200 rounded-lg border flex items-center justify-center">
                                    <i class="fas fa-image text-4xl text-gray-400"></i>
                                </div>`
                            }
                        </div>
                        <h5 class="font-medium text-sm text-gray-800 mb-2 line-clamp-2">
                            <a href="${product.url}" target="_blank" class="hover:text-blue-600">
                                ${product.name.length > 40 ? product.name.substring(0, 40) + '...' : product.name}
                            </a>
                        </h5>

                    </div>
                </div>
            `).join('');
            
            gallery.innerHTML = galleryHtml;
            
            // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰åˆ†æã‚’å®Ÿè¡Œ
            setTimeout(() => {
                analyzeThumbnailImages();
            }, 1000);
        }
        
        // LLMæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        async function testLLMCapability() {
            console.log('ğŸ” LLMæ©Ÿèƒ½ã®åˆ©ç”¨å¯èƒ½æ€§ã‚’æ¤œè¨¼ä¸­...');
            
            // ãƒ†ã‚¹ãƒˆç”¨ç”»åƒURLï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªç”»åƒï¼‰
            const testImageUrl = 'https://via.placeholder.com/300x200/4F46E5/white?text=TEST';
            const testPrompt = 'ã“ã®ç”»åƒã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚è‰²ã€ã‚µã‚¤ã‚ºã€ãƒ†ã‚­ã‚¹ãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚';
            
            try {
                // Method 1: understand_imagesé–¢æ•°ãŒç›´æ¥åˆ©ç”¨å¯èƒ½ã‹ãƒ†ã‚¹ãƒˆ
                if (typeof understand_images === 'function') {
                    console.log('âœ… understand_imagesé–¢æ•°ãŒåˆ©ç”¨å¯èƒ½');
                    const result = await understand_images([testImageUrl], testPrompt, 'gpt-4.1-mini');
                    console.log('âœ… LLMåˆ†ææˆåŠŸ:', result);
                    return { success: true, method: 'function', result: result };
                }
            } catch (error) {
                console.log('âŒ understand_imagesé–¢æ•°ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            try {
                // Method 2: APIçµŒç”±ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                const response = await fetch('/api/understand-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_urls: [testImageUrl],
                        instruction: testPrompt,
                        model: 'gpt-4.1-mini'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… APIçµŒç”±ã§LLMåˆ†ææˆåŠŸ:', data);
                    return { success: true, method: 'api', result: data };
                } else {
                    console.log('âŒ APIå¿œç­”ã‚¨ãƒ©ãƒ¼:', response.status);
                }
            } catch (error) {
                console.log('âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // Method 3: ãã®ä»–ã®LLMã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
            const alternativeEndpoints = [
                '/understand-images',
                '/api/image-analysis',
                '/llm/analyze-image'
            ];
            
            for (const endpoint of alternativeEndpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            images: [testImageUrl],
                            prompt: testPrompt,
                            model: 'gpt-4.1-mini'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`âœ… ${endpoint}ã§åˆ†ææˆåŠŸ:`, data);
                        return { success: true, method: endpoint, result: data };
                    }
                } catch (error) {
                    console.log(`âŒ ${endpoint}ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            console.log('âŒ åˆ©ç”¨å¯èƒ½ãªLLMæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return { success: false, method: null, result: null };
        }
        
        // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’LLMã§åˆ†æï¼ˆé–‹ç™ºç’°å¢ƒã§å®Ÿè¡Œï¼‰
        async function analyzeThumbnailImages() {
            console.log('ğŸ¤– LLMã«ã‚ˆã‚‹ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æé–‹å§‹');
            
            const statusText = document.getElementById('analysisStatusText');
            statusText.textContent = 'ç”»åƒåˆ†æã‚’å®Ÿè¡Œä¸­...';
            
            // ç”»åƒURLã‚’åé›†
            const imageUrls = topTrendingProducts
                .filter(product => product.thumbnailUrl)
                .map(product => product.thumbnailUrl);
            
            console.log('ğŸ–¼ï¸ åé›†ã•ã‚ŒãŸç”»åƒURL:', imageUrls);
            
            if (imageUrls.length === 0) {
                console.log('âš ï¸ ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãªã— - å•†å“ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§åˆ†æå®Ÿè¡Œ');
                statusText.textContent = 'å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­ï¼ˆç”»åƒãªã—ï¼‰...';
                setTimeout(() => {
                    showDataOnlyAnalysisResults();
                }, 2000);
                return;
            }
            
            // é–‹ç™ºç’°å¢ƒã§ã®LLMåˆ†æè¦æ±‚
            statusText.textContent = 'LLMç”»åƒåˆ†æã‚’æº–å‚™ä¸­...é–‹ç™ºè€…ã«ã‚ˆã‚‹åˆ†æå®Ÿè¡ŒãŒå¿…è¦ã§ã™';
            
            // åˆ†æè¦æ±‚æƒ…å ±ã‚’è¡¨ç¤º
            showLLMAnalysisRequest(imageUrls);
        }
        
        // OpenAI APIã‚’ä½¿ç”¨ã—ã¦LLMåˆ†æã‚’è‡ªå‹•å®Ÿè¡Œ
        function showLLMAnalysisRequest(imageUrls) {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç”»åƒURLã‚’ä¿å­˜
            window.pendingImageAnalysis = {
                imageUrls: imageUrls,
                products: topTrendingProducts,
                prompt: `ã‚ãªãŸã¯ã€ç”»åƒåˆ†æã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚å„å¯¾è±¡URLã®ç”»åƒã®ç‰¹å¾´ã‚’è©³ã—ãåˆ†æã—ã¦ãã ã•ã„ã€‚ç‰¹ã«ã€ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ãŒã‚µãƒ ãƒã‚¤ãƒ«åˆ¶ä½œæ™‚ã«å‚è€ƒã«ã§ãã‚‹å…·ä½“çš„ãªè¦ç´ ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

# å¯¾è±¡URL
${topTrendingProducts.map((product, index) => 
`${index + 1}. ${product.thumbnailUrl || 'URLä¸æ˜'}`
).join('\n')}

# åˆ†æè¦æ±‚
ã¾ãšå„ç”»åƒã«ã¤ã„ã¦å€‹åˆ¥ã«è©³ç´°åˆ†æã‚’è¡Œã„ã€ãã®å¾Œå…¨ä½“ã®å…±é€šç‚¹ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

## å„ç”»åƒã®å€‹åˆ¥åˆ†æ
ç”»åƒ1ã€œ${topTrendingProducts.length}ã«ã¤ã„ã¦ã€ãã‚Œãã‚Œä»¥ä¸‹ã®è¦ç´ ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
- è‰²å½©ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã€ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã€è‰²èª¿ï¼‰
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ§‹å›³ã€è¦ç´ é…ç½®ã€ãƒãƒ©ãƒ³ã‚¹ï¼‰
- æ–‡å­—ãƒ»ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ•ã‚©ãƒ³ãƒˆã€ã‚µã‚¤ã‚ºã€é…ç½®ã€è‰²ï¼‰
- å•†å“è¡¨ç¾ï¼ˆã‚¢ãƒ³ã‚°ãƒ«ã€è¦‹ã›æ–¹ã€å¼·èª¿ãƒã‚¤ãƒ³ãƒˆï¼‰
- èƒŒæ™¯ãƒ»è£…é£¾ï¼ˆèƒŒæ™¯è‰²ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã€è£…é£¾è¦ç´ ï¼‰
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã¸ã®è¨´æ±‚è¦ç´ 

## å…¨ä½“ã®å…±é€šåˆ†æ
1. å…±é€šã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ã¨ãƒˆãƒ¬ãƒ³ãƒ‰
2. è‰²ä½¿ã„ã¨ãƒˆãƒ¼ãƒ³ã®å‚¾å‘  
3. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³
4. æ–‡å­—ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
5. å•†å“ã®è¦‹ã›æ–¹ãƒ»ã‚¢ãƒ³ã‚°ãƒ«
6. èƒŒæ™¯ãƒ»è£…é£¾è¦ç´ ã®ç‰¹å¾´
7. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã«éŸ¿ããƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ 

å„ç”»åƒã®ç‰¹å¾´ã‚’å…·ä½“çš„ã«è¿°ã¹ãŸä¸Šã§ã€æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚`
            };
            
            console.log('ğŸ“‹ OpenAIåˆ†æãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', window.pendingImageAnalysis);
            
            // è‡ªå‹•çš„ã«LLMåˆ†æã‚’å®Ÿè¡Œ
            executeLLMAnalysis();
        }
        
        // OpenAI API ã‚’ä½¿ç”¨ã—ãŸLLMåˆ†æå®Ÿè¡Œ
        async function executeLLMAnalysis() {
            if (!window.pendingImageAnalysis) {
                alert('åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const statusText = document.getElementById('analysisStatusText');
            statusText.textContent = 'ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’åˆ†æä¸­...';
            
            try {
                const { imageUrls, prompt } = window.pendingImageAnalysis;
                
                // OpenAI Vision APIå‘¼ã³å‡ºã—
                // APIã‚­ãƒ¼ã¯localStorageã‹ã‚‰å–å¾—ã€ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„
                const apiKey = localStorage.getItem('openai_api_key') || '';
                if (!apiKey) {
                    throw new Error('OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
                
                console.log('ğŸš€ OpenAI APIå‘¼ã³å‡ºã—é–‹å§‹:', {
                    imageCount: imageUrls.length,
                    model: 'gpt-4.1-mini',
                    imageUrls: imageUrls.slice(0, 2) // æœ€åˆã®2ã¤ã®URLã ã‘ãƒ­ã‚°å‡ºåŠ›
                });
                
                // ç”»åƒURLã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                const validImageUrls = imageUrls.filter(url => {
                    try {
                        new URL(url);
                        return url.startsWith('http') && (url.includes('.jpg') || url.includes('.png') || url.includes('.jpeg') || url.includes('.webp'));
                    } catch {
                        return false;
                    }
                });
                
                console.log(`âœ… æœ‰åŠ¹ãªç”»åƒURL: ${validImageUrls.length}/${imageUrls.length}`);
                
                if (validImageUrls.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªç”»åƒURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦CORSå•é¡Œã‚’å›é¿
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const requestBody = {
                    model: 'gpt-4.1-mini',
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: prompt
                            },
                            ...validImageUrls.slice(0, 4).map(url => ({ // æœ€å¤§4æšã¾ã§
                                type: 'image_url',
                                image_url: {
                                    url: url,
                                    detail: 'low' // 'high'ã‹ã‚‰'low'ã«å¤‰æ›´ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’å‰Šæ¸›
                                }
                            }))
                        ]
                    }],
                    max_tokens: 1500, // 2000ã‹ã‚‰1500ã«å‰Šæ¸›
                    temperature: 0.3 // 0.7ã‹ã‚‰0.3ã«å¤‰æ›´ã—ã¦ä¸€è²«æ€§å‘ä¸Š
                };
                
                console.log('ğŸ“¤ é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', {
                    model: requestBody.model,
                    messageCount: requestBody.messages.length,
                    contentItems: requestBody.messages[0].content.length,
                    maxTokens: requestBody.max_tokens
                });
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'ThumbnailAnalyzer/1.0'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('OpenAI API ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries()),
                        body: errorData
                    });
                    
                    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚‚ãƒ­ã‚°å‡ºåŠ›
                    console.error('é€ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', {
                        url: 'https://api.openai.com/v1/chat/completions',
                        method: 'POST',
                        imageUrls: imageUrls,
                        promptLength: prompt.length
                    });
                    
                    throw new Error(`OpenAI API Error: ${response.status} - ${errorData}`);
                }
                
                const data = await response.json();
                const analysisResult = data.choices[0].message.content;
                
                console.log('âœ… OpenAI åˆ†æå®Œäº†:', {
                    tokensUsed: data.usage,
                    resultLength: analysisResult.length
                });
                
                showRealAnalysisResults(analysisResult);
                
            } catch (error) {
                console.error('OpenAI LLMåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                let errorMessage = 'OpenAI APIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (error.message.includes('401')) {
                    errorMessage += ' (APIèªè¨¼ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„)';
                } else if (error.message.includes('429')) {
                    errorMessage += ' (APIåˆ¶é™ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„)';
                } else if (error.message.includes('400')) {
                    errorMessage += ' (ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ç”»åƒURL ã¾ãŸã¯ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™)';
                } else if (error.message.includes('CORS')) {
                    errorMessage += ' (CORS ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™)';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += ' (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„)';
                }
                
                statusText.innerHTML = `
                    <div class="text-red-600">
                        <div>${errorMessage}</div>
                        <div class="text-sm mt-1">ä»£æ›¿åˆ†æã‚’å®Ÿè¡Œã—ã¾ã™...</div>
                        <button onclick="retryWithProxy()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs mt-2 hover:bg-blue-700">
                            ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§å†è©¦è¡Œ
                        </button>
                    </div>
                `;
                
                setTimeout(() => {
                    showEnhancedMockAnalysisResults();
                }, 3000);
            }
        }
        
        // ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã®OpenAI APIå†è©¦è¡Œ
        async function retryWithProxy() {
            if (!window.pendingImageAnalysis) {
                alert('åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const statusText = document.getElementById('analysisStatusText');
            statusText.textContent = 'ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§OpenAI APIå†è©¦è¡Œä¸­...';
            
            try {
                const { imageUrls, prompt } = window.pendingImageAnalysis;
                
                // ã‚ˆã‚Šç°¡å˜ãªãƒ†ã‚­ã‚¹ãƒˆåˆ†æã«åˆ‡ã‚Šæ›¿ãˆï¼ˆç”»åƒãªã—ï¼‰
                const simplifiedPrompt = `
ä»¥ä¸‹ã®äººæ°—æ€¥ä¸Šæ˜‡å•†å“ã®ã‚µãƒ ãƒã‚¤ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ†æã—ã¦ã€ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼å‘ã‘ã®æ¨å¥¨äº‹é …ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

å•†å“ãƒ‡ãƒ¼ã‚¿:
${topTrendingProducts.map((product, index) => 
`${index + 1}. ${product.name}
   - ä¾¡æ ¼: Â¥${product.price.toLocaleString()}
   - è©•ä¾¡: ${product.rating}ç‚¹
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: ${product.recentReviews}ä»¶ï¼ˆ3ãƒ¶æœˆé–“ï¼‰`
).join('\n')}

ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦å…·ä½“çš„ãªæ¨å¥¨äº‹é …ã‚’ææ¡ˆã—ã¦ãã ã•ã„:
1. è‰²å½©æˆ¦ç•¥ï¼ˆä¾¡æ ¼å¸¯ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«åŸºã¥ãï¼‰
2. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³
3. æ–‡å­—ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®ä½¿ç”¨æ–¹æ³•
4. å·®åˆ¥åŒ–ã®ãŸã‚ã®ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ 
5. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã«éŸ¿ããƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¾

æ—¥æœ¬èªã§å…·ä½“çš„ã‹ã¤å®Ÿç”¨çš„ãªå›ç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
`;

                // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆåˆ†æAPIå‘¼ã³å‡ºã—
                const apiKey = localStorage.getItem('openai_api_key') || '';
                if (!apiKey) {
                    throw new Error('OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o', // ã‚ˆã‚Šè»½é‡ãªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
                        messages: [{
                            role: 'user',
                            content: simplifiedPrompt
                        }],
                        max_tokens: 1200,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('ãƒ—ãƒ­ã‚­ã‚·å†è©¦è¡Œã‚¨ãƒ©ãƒ¼:', errorData);
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const analysisResult = data.choices[0].message.content;
                
                console.log('âœ… ãƒ—ãƒ­ã‚­ã‚·çµŒç”±åˆ†æå®Œäº†');
                showRealAnalysisResults(analysisResult);
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚­ã‚·å†è©¦è¡Œå¤±æ•—:', error);
                statusText.textContent = 'ãƒ—ãƒ­ã‚­ã‚·å†è©¦è¡Œã‚‚å¤±æ•—ã—ã¾ã—ãŸ - é«˜å“è³ªãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å®Ÿè¡Œ';
                setTimeout(() => {
                    showEnhancedMockAnalysisResults();
                }, 1000);
            }
        }
        
        // å®Ÿéš›ã®OpenAI LLMåˆ†æçµæœã‚’è¡¨ç¤º
        function showRealAnalysisResults(analysisResult) {
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            statusDiv.classList.add('hidden');
            
            const resultsDiv = document.getElementById('thumbnailAnalysisResults');
            
            // LLMåˆ†æçµæœã‚’æ•´ç†ã—ã¦è¡¨ç¤º
            let analysisHtml = '';
            
            if (analysisResult && analysisResult.length > 0) {
                // åˆ†æçµæœã‚’èª­ã¿ã‚„ã™ãæ•´å½¢
                const formattedAnalysis = analysisResult
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
                
                analysisHtml = `
                    <div class="space-y-6">

                        
                        <div class="bg-white p-6 rounded-lg border shadow-sm">
                            <h5 class="font-semibold text-gray-800 mb-4 flex items-center cursor-pointer" onclick="toggleAnalysisReport()">
                                <i class="fas fa-eye mr-2 text-blue-500"></i>
                                AIç”»åƒåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
                                <i id="analysisToggleIcon" class="fas fa-chevron-down ml-auto text-gray-400"></i>
                            </h5>
                            <div id="analysisReportContent" class="prose max-w-none text-sm leading-relaxed hidden">
                                ${formattedAnalysis}
                            </div>
                        </div>
                        
                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼šåˆ†æå®Œäº†é …ç›®ãƒ»æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»æ´»ç”¨æ–¹æ³• -->
                        <!--
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h5 class="font-semibold text-blue-800 mb-3 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>åˆ†æå®Œäº†é …ç›®
                                </h5>
                                <ul class="space-y-2 text-sm">
                                    <li>âœ… å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ã¨ãƒˆãƒ¬ãƒ³ãƒ‰</li>
                                    <li>âœ… è‰²ä½¿ã„ã¨ãƒˆãƒ¼ãƒ³ã®å‚¾å‘</li>
                                    <li>âœ… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³</li>
                                    <li>âœ… æ–‡å­—ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³</li>
                                    <li>âœ… å•†å“ã®è¦‹ã›æ–¹ãƒ»ã‚¢ãƒ³ã‚°ãƒ«</li>
                                    <li>âœ… èƒŒæ™¯ãƒ»è£…é£¾è¦ç´ ã®ç‰¹å¾´</li>
                                </ul>
                            </div>
                            
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                <h5 class="font-semibold text-orange-800 mb-3 flex items-center">
                                    <i class="fas fa-arrow-right mr-2"></i>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
                                </h5>
                                <ul class="space-y-2 text-sm">
                                    <li>ğŸ“‹ ä¾é ¼æ›¸ç”Ÿæˆã§å…·ä½“çš„ãªæŒ‡ç¤ºæ›¸ä½œæˆ</li>
                                    <li>ğŸ¨ åˆ†æçµæœã‚’å…ƒã«ãƒ‡ã‚¶ã‚¤ãƒ³æ–¹é‡æ±ºå®š</li>
                                    <li>ğŸ“Š ç«¶åˆã¨ã®å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨</li>
                                    <li>ğŸ”„ ç¶™ç¶šçš„ãªæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã®æ§‹ç¯‰</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                            <h6 class="font-medium text-gray-800 mb-2 flex items-center">
                                <i class="fas fa-code mr-2"></i>
                                ä½¿ç”¨ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                            </h6>
                            <div class="text-xs bg-white p-3 rounded border font-mono">
                                <pre class="whitespace-pre-wrap">${window.pendingImageAnalysis?.prompt || 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}</pre>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h6 class="font-medium text-yellow-800 mb-2 flex items-center">
                                <i class="fas fa-lightbulb mr-2"></i>
                                ã“ã®åˆ†æçµæœã®æ´»ç”¨æ–¹æ³•
                            </h6>
                            <p class="text-sm text-yellow-700">
                                ä¸‹è¨˜ã®ã€Œä¾é ¼æ›¸ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã®åˆ†æçµæœã‚’åŸºã«ã—ãŸ
                                å…·ä½“çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³æŒ‡ç¤ºæ›¸ãŒä½œæˆã•ã‚Œã¾ã™ã€‚å•†å“ã‚«ãƒ†ã‚´ãƒªã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¹´é½¢å±¤ã‚’
                                å…¥åŠ›ã—ã¦ã‹ã‚‰ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                        -->
                    </div>
                `;
            } else {
                analysisHtml = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>OpenAIåˆ†æçµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>
                        <p class="text-sm mt-2">ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = analysisHtml;
            
            // ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const generateBtn = document.getElementById('generateBriefBtn');
            generateBtn.disabled = false;
            
            // åˆ†æå®Œäº†
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>OpenAIåˆ†æå®Œäº†';
            
            // åˆ†æçµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆä¾é ¼æ›¸ç”Ÿæˆã§ä½¿ç”¨ï¼‰
            window.llmAnalysisResult = analysisResult;
        }
        
        // ç”»åƒãªã—ã§ã®å•†å“ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœã‚’è¡¨ç¤º
        function showDataOnlyAnalysisResults() {
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            statusDiv.classList.add('hidden');
            
            const resultsDiv = document.getElementById('thumbnailAnalysisResults');
            
            // TOP5å•†å“ã®ç‰¹å¾´ã‚’åˆ†æ
            const avgPrice = topTrendingProducts.reduce((sum, p) => sum + p.price, 0) / topTrendingProducts.length;
            const avgRating = topTrendingProducts.reduce((sum, p) => sum + p.rating, 0) / topTrendingProducts.length;
            const totalReviews = topTrendingProducts.reduce((sum, p) => sum + p.recentReviews, 0);
            
            const analysisHtml = `
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                        <span class="text-yellow-800">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å•†å“ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸ</span>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-semibold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-chart-bar mr-2"></i>å•†å“ãƒ‡ãƒ¼ã‚¿åˆ†æ
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ å¹³å‡ä¾¡æ ¼: Â¥${Math.round(avgPrice).toLocaleString()}</li>
                                <li>â€¢ å¹³å‡è©•ä¾¡: ${avgRating.toFixed(1)}ç‚¹</li>
                                <li>â€¢ ç·ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: ${totalReviews}ä»¶ï¼ˆ3ãƒ¶æœˆé–“ï¼‰</li>
                                <li>â€¢ ä¾¡æ ¼å¸¯: Â¥${Math.min(...topTrendingProducts.map(p => p.price)).toLocaleString()} - Â¥${Math.max(...topTrendingProducts.map(p => p.price)).toLocaleString()}</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-green-800 mb-3 flex items-center">
                                <i class="fas fa-trophy mr-2"></i>äººæ°—è¦å› æ¨å®š
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ ä¾¡æ ¼ç«¶äº‰åŠ›ã®ã‚ã‚‹å•†å“ãŒä¸Šä½</li>
                                <li>â€¢ é«˜è©•ä¾¡ã‚’ç¶­æŒã—ã¦ã„ã‚‹å•†å“</li>
                                <li>â€¢ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã®æ€¥æ¿€ãªå¢—åŠ </li>
                                <li>â€¢ å¸‚å ´ãƒ‹ãƒ¼ã‚ºã¨ã®ãƒãƒƒãƒãƒ³ã‚°</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h5 class="font-semibold text-orange-800 mb-3 flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>ã‚µãƒ ãƒã‚¤ãƒ«åˆ¶ä½œæ¨å¥¨äº‹é …ï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†æãƒ™ãƒ¼ã‚¹ï¼‰
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>ä¾¡æ ¼è¨´æ±‚:</strong>
                                <p>Â¥${Math.round(avgPrice).toLocaleString()}å‰å¾Œã®ä¾¡æ ¼å¸¯ã‚’æ„è­˜ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³</p>
                            </div>
                            <div>
                                <strong>å“è³ªã‚¢ãƒ”ãƒ¼ãƒ«:</strong>
                                <p>${avgRating.toFixed(1)}ç‚¹ã®é«˜è©•ä¾¡ã‚’æ´»ã‹ã—ãŸä¿¡é ¼æ€§ã®è¡¨ç¾</p>
                            </div>
                            <div>
                                <strong>äººæ°—æ„Ÿæ¼”å‡º:</strong>
                                <p>å¤šæ•°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨è©•ä¾¡ã®é«˜ã•ã‚’è¦–è¦šçš„ã«ã‚¢ãƒ”ãƒ¼ãƒ«</p>
                            </div>
                            <div>
                                <strong>å·®åˆ¥åŒ–è¦ç´ :</strong>
                                <p>ç«¶åˆå•†å“ã¨ã®ä¾¡æ ¼ãƒ»å“è³ªã®é•ã„ã‚’æ˜ç¢ºã«è¡¨ç¾</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <h5 class="font-semibold text-red-800 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>æ³¨æ„ç‚¹
                        </h5>
                        <p class="text-sm">
                            å®Ÿéš›ã®å•†å“ç”»åƒã‚„ã‚µãƒ ãƒã‚¤ãƒ«ãŒç¢ºèªã§ããªã„ãŸã‚ã€è¦–è¦šçš„ãªç«¶åˆåˆ†æã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                            å¯èƒ½ã§ã‚ã‚Œã°ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã€Œã‚µãƒ ãƒã‚¤ãƒ«ã€ã€Œç”»åƒURLã€ã€Œå•†å“ç”»åƒã€ç­‰ã®åˆ—ã‚’è¿½åŠ ã—ã¦ã€
                            ç”»åƒURLã‚’å«ã‚ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                        </p>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = analysisHtml;
            
            // ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const generateBtn = document.getElementById('generateBriefBtn');
            generateBtn.disabled = false;
            
            // åˆ†æå®Œäº†
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>åˆ†æå®Œäº†ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰';
        }
        
        // é«˜å“è³ªãªæ¨¡æ“¬åˆ†æçµæœã‚’è¡¨ç¤ºï¼ˆLLMæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ããªã„å ´åˆï¼‰
        function showEnhancedMockAnalysisResults() {
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            statusDiv.classList.add('hidden');
            
            const resultsDiv = document.getElementById('thumbnailAnalysisResults');
            
            // å•†å“ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©³ç´°ãªãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã‚’å®Ÿè¡Œ
            const avgPrice = topTrendingProducts.reduce((sum, p) => sum + p.price, 0) / topTrendingProducts.length;
            const avgRating = topTrendingProducts.reduce((sum, p) => sum + p.rating, 0) / topTrendingProducts.length;
            const priceRange = {
                min: Math.min(...topTrendingProducts.map(p => p.price)),
                max: Math.max(...topTrendingProducts.map(p => p.price))
            };
            
            // ã‚«ãƒ†ã‚´ãƒªæ¨å®šï¼ˆå•†å“åã‹ã‚‰ï¼‰
            const productNames = topTrendingProducts.map(p => p.name.toLowerCase());
            const categories = {
                electronics: productNames.some(name => name.includes('ã‚¹ãƒãƒ›') || name.includes('ã‚±ãƒ¼ã‚¹') || name.includes('å……é›»')),
                beauty: productNames.some(name => name.includes('åŒ–ç²§') || name.includes('ç¾å®¹') || name.includes('ã‚¹ã‚­ãƒ³ã‚±ã‚¢')),
                fashion: productNames.some(name => name.includes('æœ') || name.includes('é´') || name.includes('ãƒãƒƒã‚°')),
                home: productNames.some(name => name.includes('å®¶å…·') || name.includes('ã‚¤ãƒ³ãƒ†ãƒªã‚¢') || name.includes('ã‚­ãƒƒãƒãƒ³'))
            };
            
            const dominantCategory = Object.entries(categories).find(([key, value]) => value)?.[0] || 'general';
            
            const analysisHtml = `
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-database text-blue-600 mr-2"></i>
                            <span class="text-blue-800">å•†å“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æï¼ˆLLMæ©Ÿèƒ½æ¤œè¨¼: åˆ©ç”¨ä¸å¯ï¼‰</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-green-800 mb-3 flex items-center">
                                <i class="fas fa-chart-line mr-2"></i>å¸‚å ´ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ ä¾¡æ ¼å¸¯: Â¥${priceRange.min.toLocaleString()} - Â¥${priceRange.max.toLocaleString()}</li>
                                <li>â€¢ å¹³å‡ä¾¡æ ¼: Â¥${Math.round(avgPrice).toLocaleString()}</li>
                                <li>â€¢ å¹³å‡è©•ä¾¡: ${avgRating.toFixed(1)}ç‚¹ï¼ˆé«˜è©•ä¾¡å•†å“ãŒäººæ°—ï¼‰</li>
                                <li>â€¢ ä¸»è¦ã‚«ãƒ†ã‚´ãƒª: ${dominantCategory}</li>
                            </ul>
                        </div>
                        
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h5 class="font-semibold text-orange-800 mb-3 flex items-center">
                                <i class="fas fa-target mr-2"></i>æ¨å¥¨ãƒ‡ã‚¶ã‚¤ãƒ³æˆ¦ç•¥
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ ${avgPrice < 3000 ? 'ã‚³ã‚¹ãƒ‘é‡è¦–ã®ã‚¢ãƒ”ãƒ¼ãƒ«' : 'å“è³ªãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ„Ÿã®å¼·èª¿'}</li>
                                <li>â€¢ ${avgRating >= 4.0 ? 'é«˜è©•ä¾¡ãƒ»ä¿¡é ¼æ€§ã®è¦–è¦šåŒ–' : 'æ”¹å–„ç‚¹ã®æ˜ç¢ºãªè¡¨ç¾'}</li>
                                <li>â€¢ ${dominantCategory === 'electronics' ? 'ãƒ†ãƒƒã‚¯æ„Ÿãƒ»å…ˆé€²æ€§ã®è¡¨ç¾' : 
                                      dominantCategory === 'beauty' ? 'æ¸…æ½”æ„Ÿãƒ»ä¸Šå“ã•ã®æ¼”å‡º' :
                                      dominantCategory === 'fashion' ? 'ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿãƒ»ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã•' :
                                      'å®Ÿç”¨æ€§ãƒ»æ©Ÿèƒ½æ€§ã®è¨´æ±‚'}</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h5 class="font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-palette mr-2"></i>æ¨å¥¨ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æï¼‰
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>è‰²å½©æˆ¦ç•¥:</strong>
                                <p>${avgPrice < 3000 ? 
                                    'æ˜ã‚‹ã„æš–è‰²ç³»ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ã€ã‚¤ã‚¨ãƒ­ãƒ¼ï¼‰ã§ãŠå¾—æ„Ÿã‚’è¡¨ç¾' : 
                                    'ã‚¯ãƒ¼ãƒ«ãƒˆãƒ¼ãƒ³ï¼ˆãƒ–ãƒ«ãƒ¼ã€ã‚°ãƒ¬ãƒ¼ï¼‰ã§é«˜ç´šæ„Ÿã‚’æ¼”å‡º'}</p>
                            </div>
                            <div>
                                <strong>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:</strong>
                                <p>${avgRating >= 4.0 ? 
                                    'â˜…è©•ä¾¡ã‚’ç›®ç«‹ãŸã›ã‚‹é…ç½®ã€ä¿¡é ¼æ„Ÿã®ã‚ã‚‹ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆ' : 
                                    'æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã‚’æ˜ç¢ºã«ã—ãŸæƒ…å ±å¯†åº¦é«˜ã‚ã®æ§‹æˆ'}</p>
                            </div>
                            <div>
                                <strong>æ–‡å­—ä½¿ç”¨:</strong>
                                <p>ä¾¡æ ¼ï¼ˆÂ¥${Math.round(avgPrice).toLocaleString()}å‰å¾Œï¼‰ã‚’å¤§ããã€è©•ä¾¡ï¼ˆ${avgRating.toFixed(1)}â˜…ï¼‰ã‚’å¼·èª¿</p>
                            </div>
                            <div>
                                <strong>å·®åˆ¥åŒ–è¦ç´ :</strong>
                                <p>${priceRange.max - priceRange.min > 5000 ? 
                                    'ä¾¡æ ¼å¹…ãŒåºƒã„â†’ä¾¡å€¤ææ¡ˆã®æ˜ç¢ºåŒ–ãŒé‡è¦' : 
                                    'ä¾¡æ ¼å¸¯ãŒè¿‘ã„â†’æ©Ÿèƒ½ãƒ»å“è³ªã§ã®å·®åˆ¥åŒ–ãŒå¿…è¦'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h5 class="font-semibold text-yellow-800 mb-3 flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>å®Ÿè£…æ¨å¥¨äº‹é …
                        </h5>
                        <div class="space-y-3 text-sm">
                            <div>
                                <strong>å„ªå…ˆé †ä½1:</strong> ä¾¡æ ¼ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã‚’è¦–è¦šçš„ã«å¼·èª¿ï¼ˆæ•°å­—ã®å¤§ãã•ã€é…ç½®ï¼‰
                            </div>
                            <div>
                                <strong>å„ªå…ˆé †ä½2:</strong> ${dominantCategory}ã‚«ãƒ†ã‚´ãƒªã«é©ã—ãŸãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒˆãƒ¼ãƒ³ã®æ¡ç”¨
                            </div>
                            <div>
                                <strong>å„ªå…ˆé †ä½3:</strong> ç«¶åˆã¨ã®ä¾¡æ ¼ãƒ»è©•ä¾¡å·®ã‚’æ˜ç¢ºã«è¡¨ç¾ã™ã‚‹è¦ç´ ã®è¿½åŠ 
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = analysisHtml;
            
            // ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const generateBtn = document.getElementById('generateBriefBtn');
            generateBtn.disabled = false;
            
            // åˆ†æå®Œäº†
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>ãƒ‡ãƒ¼ã‚¿åˆ†æå®Œäº†';
        }
        
        // æ¨¡æ“¬çš„ãªåˆ†æçµæœã‚’è¡¨ç¤ºï¼ˆå®Ÿè£…ä¾‹ï¼‰
        function showMockAnalysisResults() {
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            statusDiv.classList.add('hidden');
            
            const resultsDiv = document.getElementById('thumbnailAnalysisResults');
            
            const analysisHtml = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-semibold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-palette mr-2"></i>å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ 
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ å•†å“ã‚’ä¸­å¿ƒã«é…ç½®ã—ãŸæ§‹å›³</li>
                                <li>â€¢ æ˜ã‚‹ãæ¸…æ½”æ„Ÿã®ã‚ã‚‹èƒŒæ™¯è‰²</li>
                                <li>â€¢ å•†å“ã®æ©Ÿèƒ½æ€§ã‚’å¼·èª¿ã™ã‚‹æ–‡å­—æƒ…å ±</li>
                                <li>â€¢ ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã®å¼·ã„è‰²ä½¿ã„</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-green-800 mb-3 flex items-center">
                                <i class="fas fa-chart-line mr-2"></i>æˆåŠŸè¦å› 
                            </h5>
                            <ul class="space-y-2 text-sm">
                                <li>â€¢ ä¸€ç›®ã§å•†å“å†…å®¹ãŒç†è§£ã§ãã‚‹</li>
                                <li>â€¢ è³¼è²·æ„æ¬²ã‚’åˆºæ¿€ã™ã‚‹è‰²å½©è¨­è¨ˆ</li>
                                <li>â€¢ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã®å¥½ã¿ã«åˆè‡´ã—ãŸãƒˆãƒ¼ãƒ³</li>
                                <li>â€¢ ç«¶åˆã¨å·®åˆ¥åŒ–ã•ã‚ŒãŸç‹¬è‡ªæ€§</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h5 class="font-semibold text-orange-800 mb-3 flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>ãƒ‡ã‚¶ã‚¤ãƒ³æ¨å¥¨äº‹é …
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong>è‰²å½©:</strong>
                                <p>æ˜åº¦ã®é«˜ã„èƒŒæ™¯è‰²ï¼ˆç™½ãƒ»ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ï¼‰ã«ã€å•†å“ã®ç‰¹å¾´è‰²ã§ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ</p>
                            </div>
                            <div>
                                <strong>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:</strong>
                                <p>å•†å“ã‚’ä¸­å¤®é…ç½®ã—ã€é‡è¦ãªç‰¹å¾´ã‚’å·¦ä¸Šã¾ãŸã¯å³ä¸Šã«é…ç½®</p>
                            </div>
                            <div>
                                <strong>æ–‡å­—:</strong>
                                <p>å¤ªå­—ã‚´ã‚·ãƒƒã‚¯ä½“ã§è¦–èªæ€§é‡è¦–ã€é‡è¦æƒ…å ±ã¯å¤§ããè¡¨ç¤º</p>
                            </div>
                            <div>
                                <strong>æ§‹å›³:</strong>
                                <p>å•†å“ã®ä½¿ç”¨ã‚·ãƒ¼ãƒ³ã¾ãŸã¯åŠ¹æœã‚’é€£æƒ³ã•ã›ã‚‹è¦ç´ ã‚’è¿½åŠ </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = analysisHtml;
            
            // ä¾é ¼æ›¸ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const generateBtn = document.getElementById('generateBriefBtn');
            generateBtn.disabled = false;
            
            // åˆ†æå®Œäº†
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>åˆ†æå®Œäº†';
        }
        
        // åˆ†æã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showAnalysisError(message) {
            const statusDiv = document.getElementById('thumbnailAnalysisStatus');
            statusDiv.classList.add('hidden');
            
            const resultsDiv = document.getElementById('thumbnailAnalysisResults');
            resultsDiv.innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                    <p>${message}</p>
                </div>
            `;
            
            const analyzeBtn = document.getElementById('analyzeThumbnailsBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>ã‚µãƒ ãƒã‚¤ãƒ«åˆ†æã‚’é–‹å§‹';
        }
        
        // ä¾é ¼æ›¸ç”Ÿæˆ
        function generateDesignBrief() {
            console.log('ğŸ“ ä¾é ¼æ›¸ç”Ÿæˆé–‹å§‹');
            
            const category = document.getElementById('productCategory').value || 'å•†å“';
            const targetAge = document.getElementById('targetAge').value || 'å…¨å¹´é½¢';
            
            // ç”»åƒã®æœ‰ç„¡ã‚’ç¢ºèª
            const hasImages = topTrendingProducts.some(p => p.thumbnailUrl);
            const analysisType = hasImages ? 'ç”»åƒ+ãƒ‡ãƒ¼ã‚¿åˆ†æ' : 'ãƒ‡ãƒ¼ã‚¿åˆ†æã®ã¿';
            
            const briefHtml = `
                <div class="space-y-4">
                    <div class="border-b pb-3">
                        <h6 class="font-semibold text-lg">ã‚µãƒ ãƒã‚¤ãƒ«åˆ¶ä½œä¾é ¼æ›¸</h6>
                        <p class="text-sm text-gray-600">ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}</p>
                    </div>
                    
                    <div>
                        <h6 class="font-medium mb-2">ğŸ“‹ åŸºæœ¬æƒ…å ±</h6>
                        <ul class="space-y-1 text-sm">
                            <li><strong>å•†å“ã‚«ãƒ†ã‚´ãƒª:</strong> ${category}</li>
                            <li><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¹´é½¢å±¤:</strong> ${targetAge}</li>
                            <li><strong>å‚è€ƒå•†å“æ•°:</strong> ${topTrendingProducts.length}å•†å“ï¼ˆäººæ°—æ€¥ä¸Šæ˜‡TOP5ï¼‰</li>
                            <li><strong>åˆ†ææ–¹æ³•:</strong> ${analysisType}</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h6 class="font-medium mb-2">ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³è¦æ±‚äº‹é …</h6>
                        <div class="bg-gray-50 p-3 rounded text-sm space-y-2">
                            <p><strong>1. è‰²å½©è¨­è¨ˆ</strong></p>
                            <p>â€¢ æ˜åº¦ã®é«˜ã„èƒŒæ™¯è‰²ï¼ˆç™½ãƒ»ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ç³»ï¼‰ã‚’åŸºèª¿ã¨ã™ã‚‹</p>
                            <p>â€¢ å•†å“ã®ç‰¹å¾´ã‚’è¡¨ç¾ã™ã‚‹ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã‚’åŠ¹æœçš„ã«ä½¿ç”¨</p>
                            <p>â€¢ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ï¼ˆ${targetAge}ï¼‰ã«éŸ¿ãè‰²èª¿ã‚’æ¡ç”¨</p>
                            
                            <p class="pt-2"><strong>2. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»æ§‹å›³</strong></p>
                            <p>â€¢ å•†å“ã‚’ä¸­å¤®ã«é…ç½®ã—ã€è¦–ç·šã‚’é›†ã‚ã‚‹æ§‹å›³</p>
                            <p>â€¢ é‡è¦ãªç‰¹å¾´ã‚„å£²ã‚Šæ–‡å¥ã‚’å·¦ä¸Šã¾ãŸã¯å³ä¸Šã«é…ç½®</p>
                            <p>â€¢ ä¸€ç›®ã§å•†å“å†…å®¹ãŒç†è§£ã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ</p>
                            
                            <p class="pt-2"><strong>3. æ–‡å­—ãƒ»ãƒ†ã‚­ã‚¹ãƒˆ</strong></p>
                            <p>â€¢ å¤ªå­—ã‚´ã‚·ãƒƒã‚¯ä½“ã§è¦–èªæ€§ã‚’é‡è¦–</p>
                            <p>â€¢ é‡è¦ãªæƒ…å ±ï¼ˆä¾¡æ ¼ã€ç‰¹å¾´ï¼‰ã¯å¤§ããè¡¨ç¤º</p>
                            <p>â€¢ æ–‡å­—é‡ã¯æœ€å°é™ã«æŠ‘ãˆã€ã‚­ãƒ£ãƒƒãƒãƒ¼ãªè¡¨ç¾ã‚’ä½¿ç”¨</p>
                            
                            <p class="pt-2"><strong>4. å•†å“è¡¨ç¾</strong></p>
                            <p>â€¢ å•†å“ã®ä½¿ç”¨ã‚·ãƒ¼ãƒ³ã‚„åŠ¹æœã‚’é€£æƒ³ã•ã›ã‚‹è¦ç´ ã‚’å«ã‚€</p>
                            <p>â€¢ å•†å“ã®æ©Ÿèƒ½æ€§ã‚„ç‰¹å¾´ã‚’è¦–è¦šçš„ã«è¡¨ç¾</p>
                            <p>â€¢ ç«¶åˆå•†å“ã¨ã®å·®åˆ¥åŒ–ã‚’å›³ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¦ç´ ã‚’è¿½åŠ </p>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-medium mb-2">ğŸ“Š å‚è€ƒãƒ‡ãƒ¼ã‚¿ï¼ˆåˆ†æçµæœã‚ˆã‚Šï¼‰</h6>
                        <div class="text-sm space-y-2">
                            <p><strong>æˆåŠŸã—ã¦ã„ã‚‹å•†å“ã®å…±é€šç‚¹:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>å•†å“ã‚’ä¸­å¿ƒã¨ã—ãŸå®‰å®šæ„Ÿã®ã‚ã‚‹æ§‹å›³</li>
                                <li>è³¼è²·æ„æ¬²ã‚’åˆºæ¿€ã™ã‚‹åŠ¹æœçš„ãªè‰²å½©è¨­è¨ˆ</li>
                                <li>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã®ãƒ‹ãƒ¼ã‚ºã«åˆè‡´ã—ãŸãƒˆãƒ¼ãƒ³è¨­å®š</li>
                                <li>ç«¶åˆã¨ã®æ˜ç¢ºãªå·®åˆ¥åŒ–è¦ç´ </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-medium mb-2">ğŸ¯ æˆæœç›®æ¨™</h6>
                        <div class="bg-blue-50 p-3 rounded text-sm">
                            <p>â€¢ ã‚¯ãƒªãƒƒã‚¯ç‡ã®å‘ä¸Šï¼ˆç¾åœ¨ã®äººæ°—å•†å“ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šï¼‰</p>
                            <p>â€¢ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã¸ã®è¨´æ±‚åŠ›å¼·åŒ–</p>
                            <p>â€¢ ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã®æ•´åˆæ€§ç¢ºä¿</p>
                            <p>â€¢ ç«¶åˆå•†å“ã¨ã®å·®åˆ¥åŒ–å®Ÿç¾</p>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="font-medium mb-2">ğŸ“ å‚è€ƒå•†å“ä¸€è¦§</h6>
                        <div class="text-xs space-y-1">
                            ${topTrendingProducts.map((product, index) => 
                                `<div class="border-l-2 border-blue-200 pl-2">
                                    <strong>${index + 1}. ${product.name}</strong><br>
                                    ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°: ${product.recentReviews}ä»¶ | è©•ä¾¡: ${product.rating}ç‚¹ | ä¾¡æ ¼: Â¥${product.price.toLocaleString()}<br>
                                    <a href="${product.url}" class="text-blue-600 hover:underline" target="_blank">å•†å“ãƒšãƒ¼ã‚¸</a>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            const briefContent = document.getElementById('briefContent');
            briefContent.innerHTML = briefHtml;
            
            const briefDiv = document.getElementById('designBrief');
            briefDiv.classList.remove('hidden');
            
            // ãƒšãƒ¼ã‚¸ã®ä¾é ¼æ›¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            briefDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ä¾é ¼æ›¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyDesignBrief() {
            const briefContent = document.getElementById('briefContent');
            const textContent = briefContent.innerText;
            
            navigator.clipboard.writeText(textContent).then(() => {
                // ã‚³ãƒ”ãƒ¼å®Œäº†ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const copyBtn = document.getElementById('copyBriefBtn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>ã‚³ãƒ”ãƒ¼å®Œäº†!';
                copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                copyBtn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('bg-green-600');
                    copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            });
        }
        
        // AIç”»åƒåˆ†æãƒ¬ãƒãƒ¼ãƒˆæŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
        function toggleAnalysisReport() {
            const content = document.getElementById('analysisReportContent');
            const icon = document.getElementById('analysisToggleIcon');
            
            if (content && icon) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    content.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }
        
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚’æ‰‹å‹•ã§å¼·åˆ¶å®Ÿè¡Œã™ã‚‹ãƒœã‚¿ãƒ³æ©Ÿèƒ½
        function forceReviewAnalysis() {
            console.log('ğŸ”„ ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æã‚’å¼·åˆ¶å®Ÿè¡Œ');
            if (currentData && currentData.data && currentData.headers) {
                updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
            } else {
                console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰åˆ†æå®Ÿè¡Œ
                refreshData().then(() => {
                    if (currentData && currentData.data && currentData.headers) {
                        updateAdvancedReviewAnalysis(currentData.data, currentData.headers);
                    }
                });
            }
        }
        
        // ChatBoté–¢é€£ - ä¸Šè¨˜ã®startChat()é–¢æ•°ã‚’ä½¿ç”¨
    </script>
</body>
</html>